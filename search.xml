<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ADS层的创建</title>
      <link href="/2022/09/22/ADS%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/"/>
      <url>/2022/09/22/ADS%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="1-访客主题"><a href="#1-访客主题" class="headerlink" title="1. 访客主题"></a>1. 访客主题</h2><h3 id="1-1-访客统计"><a href="#1-1-访客统计" class="headerlink" title="1.1 访客统计"></a>1.1 访客统计</h3><h3 id="1-2-路径分析"><a href="#1-2-路径分析" class="headerlink" title="1.2 路径分析"></a>1.2 路径分析</h3><h2 id="2-用户主题"><a href="#2-用户主题" class="headerlink" title="2. 用户主题"></a>2. 用户主题</h2><h3 id="2-1-用户统计"><a href="#2-1-用户统计" class="headerlink" title="2.1 用户统计"></a>2.1 用户统计</h3><p>​该需求为用户综合统计，其中包含若干指标，以下为对每个指标的解释说明。</p><table><thead><tr><th>指标</th><th>说明</th><th>对应字段</th></tr></thead><tbody><tr><td>新增用户数</td><td>统计新增注册用户人数</td><td>new_user_count</td></tr><tr><td>新增下单用户数</td><td>统计新增下单用户人数</td><td>new_order_user_count</td></tr><tr><td>下单总金额</td><td>统计所有订单总额</td><td>order_final_amount</td></tr><tr><td>下单用户数</td><td>统计下单用户总数</td><td>order_user_count</td></tr><tr><td>未下单用户数</td><td>统计活跃但未下单用户数</td><td>no_order_user_count</td></tr></tbody></table><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_total<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_total<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>new_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'新注册用户数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>new_order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'新增下单用户数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单总金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单用户数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>no_order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'未下单用户数(具体指活跃用户中未下单用户)'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户统计'</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ads/ads_user_total/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据装载</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_user_total<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_total<span class="token keyword">union</span><span class="token keyword">select</span>    <span class="token string">'2022-09-04'</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>login_date_first<span class="token operator">=</span><span class="token string">'2022-09-04'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> new_user_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_date_first<span class="token operator">=</span><span class="token string">'2022-09-04'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> new_order_user_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_final_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_user_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>login_date_last<span class="token operator">=</span><span class="token string">'2022-09-04'</span> <span class="token operator">and</span> order_final_amount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> no_order_user_count<span class="token keyword">from</span> dwt_user_topic<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-04'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-用户变动统计"><a href="#2-2-用户变动统计" class="headerlink" title="2.2 用户变动统计"></a>2.2 用户变动统计</h3><p>​该需求包括两个指标，分别为流失用户数和回流用户数，以下为对两个指标的解释说明。</p><table><thead><tr><th>指标</th><th>说明</th><th>对应字段</th></tr></thead><tbody><tr><td>流失用户数</td><td>之前活跃过的用户，最近一段时间未活跃，就称为流失用户。此处要求统计7日前（只包含7日前当天）活跃，但最近7日未活跃的用户总数。</td><td>user_churn_count</td></tr><tr><td>回流用户数</td><td>之前的活跃用户，一段时间未活跃（流失），今日又活跃了，就称为回流用户。次数要求统计回流用户总数。</td><td>new_order_user_count</td></tr></tbody></table><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_change<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_change<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_churn_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'流失用户数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_back_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'回流用户数'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户变动统计'</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ads/ads_user_change/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>统计的流失用户是登录时间是7天前的，不包括8天 9天等等，必须是第七天前的</p><p>插入语句</p><p><strong>思路分析：</strong></p><p><strong>流失用户：末次活跃时间为7日前的用户即为流失用户。</strong></p><p><strong>回流用户：末次活跃时间为今日，上次活跃时间在8日前的用户即为回流用户。</strong></p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_user_change<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_change<span class="token keyword">union</span><span class="token keyword">select</span>    churn<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>    user_churn_count<span class="token punctuation">,</span>    user_back_count<span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            <span class="token string">'2022-09-01'</span> dt<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> user_churn_count        <span class="token keyword">from</span> dwt_user_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>          <span class="token operator">and</span> login_date_last<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>churn        <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            <span class="token string">'2022-09-01'</span> dt<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> user_back_count        <span class="token keyword">from</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span>                    user_id<span class="token punctuation">,</span>                    login_date_last                <span class="token keyword">from</span> dwt_user_topic                <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>                  <span class="token operator">and</span> login_date_last<span class="token operator">=</span><span class="token string">'2022-09-01'</span>            <span class="token punctuation">)</span>t1                <span class="token keyword">join</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span>                    user_id<span class="token punctuation">,</span>                    login_date_last login_date_previous                <span class="token keyword">from</span> dwt_user_topic                <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>t2            <span class="token keyword">on</span> t1<span class="token punctuation">.</span>user_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>user_id        <span class="token keyword">where</span> datediff<span class="token punctuation">(</span>login_date_last<span class="token punctuation">,</span>login_date_previous<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">8</span>    <span class="token punctuation">)</span>back    <span class="token keyword">on</span> churn<span class="token punctuation">.</span>dt<span class="token operator">=</span>back<span class="token punctuation">.</span>dt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>之前我一直不太明白为什么要用昨天的数据来统计回流用户数目，如果今天的用户登陆了，那么就会把login_date_last这个字段的值给覆盖掉，那么我们就不知道这个用户是否属于7天前登录的了，因此我们使用昨天的数据，使用今天的该字段减去昨天的该字段是否大于等于8，就可以判断这个用户是否是回流用户了。</p><h3 id="2-3-用户行为漏斗分析"><a href="#2-3-用户行为漏斗分析" class="headerlink" title="2.3 用户行为漏斗分析"></a>2.3 用户行为漏斗分析</h3><p>漏斗分析是一个数据分析模型，它能够科学反映一个业务过程从起点到终点各阶段用户转化情况。由于其能将各阶段环节都展示出来，故哪个阶段存在问题，就能一目了然。</p><p><img src="/2022/09/22/ADS%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1664010301300.png" alt="1664010301300"></p><p>该需求要求统计一个完整的购物流程各个阶段的人数。</p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_action<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_action<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>home_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'浏览首页人数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>good_detail_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'浏览商品详情页人数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'加入购物车人数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单人数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付人数'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'漏斗分析'</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ads/ads_user_action/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据装载</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">with</span>    tmp_page <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                <span class="token string">'2022-09-01'</span> dt<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>array_contains<span class="token punctuation">(</span>pages<span class="token punctuation">,</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> home_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>array_contains<span class="token punctuation">(</span>pages<span class="token punctuation">,</span><span class="token string">'good_detail'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> good_detail_count            <span class="token keyword">from</span>                <span class="token punctuation">(</span>                    <span class="token keyword">select</span>                        mid_id<span class="token punctuation">,</span>                        collect_set<span class="token punctuation">(</span>page<span class="token punctuation">.</span>page_id<span class="token punctuation">)</span> pages                    <span class="token keyword">from</span> dws_visitor_action_daycount lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>page_stats<span class="token punctuation">)</span> tmp <span class="token keyword">as</span> page                    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>                      <span class="token operator">and</span> page<span class="token punctuation">.</span>page_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">,</span><span class="token string">'good_detail'</span><span class="token punctuation">)</span>                    <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id                <span class="token punctuation">)</span>t1        <span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_cop <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                <span class="token string">'2022-09-01'</span> dt<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>cart_last_1d_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_last_1d_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>payment_last_1d_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_count            <span class="token keyword">from</span> dwt_user_topic            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>        <span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_user_action<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_action<span class="token keyword">union</span><span class="token keyword">select</span>    tmp_page<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>    home_count<span class="token punctuation">,</span>    good_detail_count<span class="token punctuation">,</span>    cart_count<span class="token punctuation">,</span>    order_count<span class="token punctuation">,</span>    payment_count<span class="token keyword">from</span> tmp_page         <span class="token keyword">join</span> tmp_cop              <span class="token keyword">on</span> tmp_page<span class="token punctuation">.</span>dt<span class="token operator">=</span>tmp_cop<span class="token punctuation">.</span>dt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>​首先由于dws_visitor_action_daycount的粒度是用户，而最终需要的数据是次数，一个用户有可能一天登录了多次页面，因此粒度要粗，所以我们需要使用lateral view函数配合explode函数来进行拆分，拆分后计算登录次数等。然后使用数据主题层的数据在今后收藏、订单、支付的数目统计</p><h3 id="2-4-用户留存率"><a href="#2-4-用户留存率" class="headerlink" title="2.4 用户留存率"></a>2.4 用户留存率</h3><h3 id="2-5-七天内连续三天活跃用户"><a href="#2-5-七天内连续三天活跃用户" class="headerlink" title="2.5 七天内连续三天活跃用户"></a>2.5 七天内连续三天活跃用户</h3><h3 id="2-6-每分钟在线用户数"><a href="#2-6-每分钟在线用户数" class="headerlink" title="2.6 每分钟在线用户数"></a>2.6 每分钟在线用户数</h3><h2 id="3-商品主题"><a href="#3-商品主题" class="headerlink" title="3. 商品主题"></a>3. 商品主题</h2><h3 id="3-1-商品统计"><a href="#3-1-商品统计" class="headerlink" title="3.1 商品统计"></a>3.1 商品统计</h3><p>该指标为商品综合统计，包含每个spu被下单总次数和被下单总金额。</p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_order_spu_stats<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_order_spu_stats<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级品类ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category3_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级品类名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级品类ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category2_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级品类名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级品类ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category1_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级品类名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单数(截止到统计日期总的订单数)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额(截止到统计日期总的订单金额)'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品销售统计'</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ads/ads_order_spu_stats/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据装载</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_order_spu_stats<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_order_spu_stats<span class="token keyword">union</span><span class="token keyword">select</span>    <span class="token string">'2022-09-01'</span> dt<span class="token punctuation">,</span>    spu_id<span class="token punctuation">,</span>    spu_name<span class="token punctuation">,</span>    tm_id<span class="token punctuation">,</span>    tm_name<span class="token punctuation">,</span>    category3_id<span class="token punctuation">,</span>    category3_name<span class="token punctuation">,</span>    category2_id<span class="token punctuation">,</span>    category2_name<span class="token punctuation">,</span>    category1_id<span class="token punctuation">,</span>    category1_name<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            order_last_1d_count<span class="token punctuation">,</span>            order_last_1d_final_amount        <span class="token keyword">from</span> dwt_sku_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>t1        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            spu_id<span class="token punctuation">,</span>            spu_name<span class="token punctuation">,</span>            tm_id<span class="token punctuation">,</span>            tm_name<span class="token punctuation">,</span>            category3_id<span class="token punctuation">,</span>            category3_name<span class="token punctuation">,</span>            category2_id<span class="token punctuation">,</span>            category2_name<span class="token punctuation">,</span>            category1_id<span class="token punctuation">,</span>            category1_name        <span class="token keyword">from</span> dim_sku_info        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>t2    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>id<span class="token keyword">group</span> <span class="token keyword">by</span> spu_id<span class="token punctuation">,</span>spu_name<span class="token punctuation">,</span>tm_id<span class="token punctuation">,</span>tm_name<span class="token punctuation">,</span>category3_id<span class="token punctuation">,</span>category3_name<span class="token punctuation">,</span>category2_id<span class="token punctuation">,</span>category2_name<span class="token punctuation">,</span>category1_id<span class="token punctuation">,</span>category1_name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-2-品牌复购率"><a href="#3-2-品牌复购率" class="headerlink" title="3.2 品牌复购率"></a>3.2 品牌复购率</h3><p>​品牌复购率是指一段时间内重复购买某品牌的人数与购买过该品牌的人数的比值。重复购买即购买次数大于等于2，购买过即购买次数大于1。</p><p>​此处要求统计最近30天的各品牌复购率。</p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_repeat_purchase<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_repeat_purchase<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_repeat_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'复购率'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'品牌复购率'</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ads/ads_repeat_purchase/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据装载</p><p><strong>思路分析：该需求可分两步实现：</strong></p><p><strong>第一步：统计每个用户购买每个品牌的次数。</strong></p><p><strong>第二步：分别统计购买次数大于1的人数和大于2的人数。</strong></p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_repeat_purchase<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_repeat_purchase<span class="token keyword">union</span><span class="token keyword">select</span>    <span class="token string">'2022-09-01'</span> dt<span class="token punctuation">,</span>    tm_id<span class="token punctuation">,</span>    tm_name<span class="token punctuation">,</span>    cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">>=</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">>=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            tm_id<span class="token punctuation">,</span>            tm_name<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count        <span class="token keyword">from</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span>                    user_id<span class="token punctuation">,</span>                    sku_id<span class="token punctuation">,</span>                    <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count                <span class="token keyword">from</span> dwd_order_detail                <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span>                <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>sku_id            <span class="token punctuation">)</span>t1                <span class="token keyword">left</span> <span class="token keyword">join</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span>                    id<span class="token punctuation">,</span>                    tm_id<span class="token punctuation">,</span>                    tm_name                <span class="token keyword">from</span> dim_sku_info                <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>            <span class="token punctuation">)</span>t2            <span class="token keyword">on</span> t1<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>id        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>tm_id<span class="token punctuation">,</span>tm_name    <span class="token punctuation">)</span>t3<span class="token keyword">group</span> <span class="token keyword">by</span> tm_id<span class="token punctuation">,</span>tm_name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>​上述插入语句join了dim_sku_info这个表格，是因为本需求需要统计品牌的复购率，而dwd_order_detail中只有sku_id，因此需要join。然后使用group by语句之后把订单分组，某个用户对某个品牌的订单数目大于等于2之后，就证明该用户复购了一次该商品。</p><h2 id="4-订单主题"><a href="#4-订单主题" class="headerlink" title="4. 订单主题"></a>4. 订单主题</h2><p>​该需求包含订单总数，订单总金额和下单总人数。</p><h3 id="4-1-订单统计"><a href="#4-1-订单统计" class="headerlink" title="4.1 订单统计"></a>4.1 订单统计</h3><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_order_total<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_order_total<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单人数'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单统计'</span><span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>LOCATION <span class="token string">'/warehouse/gmall/ads/ads_order_total/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据插入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_order_total<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_order_total<span class="token keyword">union</span><span class="token keyword">select</span>    <span class="token string">'2022-09-01'</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_last_1d_final_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_user_count<span class="token keyword">from</span> dwt_user_topic<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-2-各地区订单统计"><a href="#4-2-各地区订单统计" class="headerlink" title="4.2 各地区订单统计"></a>4.2 各地区订单统计</h3><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_order_by_province<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_order_by_province<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>province_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>iso_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'国际标准地区编码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>iso_code_3166_2<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'国际标准地区编码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户留存率'</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ads/ads_order_by_province/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_order_by_province<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_order_by_province<span class="token keyword">union</span><span class="token keyword">select</span>    <span class="token string">'2022-09-01'</span> dt<span class="token punctuation">,</span>    province_id<span class="token punctuation">,</span>    province_name<span class="token punctuation">,</span>    area_code<span class="token punctuation">,</span>    iso_code<span class="token punctuation">,</span>    iso_3166_2<span class="token punctuation">,</span>    order_last_1d_count<span class="token punctuation">,</span>    order_last_1d_final_amount<span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            province_id<span class="token punctuation">,</span>            order_last_1d_count<span class="token punctuation">,</span>            order_last_1d_final_amount        <span class="token keyword">from</span> dwt_area_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>t1        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            province_name<span class="token punctuation">,</span>            area_code<span class="token punctuation">,</span>            iso_code<span class="token punctuation">,</span>            iso_3166_2        <span class="token keyword">from</span> dim_base_province    <span class="token punctuation">)</span>t2    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>province_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-优惠券主题"><a href="#5-优惠券主题" class="headerlink" title="5.优惠券主题"></a>5.优惠券主题</h2><p>​该需求要求统计最近30日发布的所有优惠券的领用情况和补贴率，补贴率是指，总优惠金额与使用优惠券的订单的原价金额的比值。</p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_coupon_stats<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ads_coupon_stats <span class="token punctuation">(</span>    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'发布日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>rule_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠规则'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>get_count<span class="token punctuation">`</span>  <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'领取次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用(下单)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_count<span class="token punctuation">`</span>  <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'过期次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用优惠券订单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用优惠券订单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>reduce_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'补贴率'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品销售统计'</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ads/ads_coupon_stats/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据装载</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_coupon_stats<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_coupon_stats<span class="token keyword">union</span><span class="token keyword">select</span>    <span class="token string">'2022-09-01'</span> dt<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    coupon_name<span class="token punctuation">,</span>    start_date<span class="token punctuation">,</span>    rule_name<span class="token punctuation">,</span>    get_count<span class="token punctuation">,</span>    order_count<span class="token punctuation">,</span>    expire_count<span class="token punctuation">,</span>    order_original_amount<span class="token punctuation">,</span>    order_final_amount<span class="token punctuation">,</span>    reduce_amount<span class="token punctuation">,</span>    reduce_rate<span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            coupon_name<span class="token punctuation">,</span>            date_format<span class="token punctuation">(</span>start_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> start_date<span class="token punctuation">,</span>            <span class="token keyword">case</span>                <span class="token keyword">when</span> coupon_type<span class="token operator">=</span><span class="token string">'3201'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'满'</span><span class="token punctuation">,</span>condition_amount<span class="token punctuation">,</span><span class="token string">'元减'</span><span class="token punctuation">,</span>benefit_amount<span class="token punctuation">,</span><span class="token string">'元'</span><span class="token punctuation">)</span>                <span class="token keyword">when</span> coupon_type<span class="token operator">=</span><span class="token string">'3202'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'满'</span><span class="token punctuation">,</span>condition_num<span class="token punctuation">,</span><span class="token string">'件打'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>benefit_discount<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'折'</span><span class="token punctuation">)</span>                <span class="token keyword">when</span> coupon_type<span class="token operator">=</span><span class="token string">'3203'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'减'</span><span class="token punctuation">,</span>benefit_amount<span class="token punctuation">,</span><span class="token string">'元'</span><span class="token punctuation">)</span>                <span class="token keyword">end</span> rule_name        <span class="token keyword">from</span> dim_coupon_info        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>t1        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            coupon_id<span class="token punctuation">,</span>            get_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            expire_count<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            order_reduce_amount reduce_amount<span class="token punctuation">,</span>            cast<span class="token punctuation">(</span>order_reduce_amount<span class="token operator">/</span>order_original_amount <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> reduce_rate        <span class="token keyword">from</span> dwt_coupon_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>t2    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>coupon_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-活动主题"><a href="#6-活动主题" class="headerlink" title="6. 活动主题"></a>6. 活动主题</h2><p>​该需求要求统计最近30日发布的所有活动的参与情况和补贴率，补贴率是指，总优惠金额与参与活动的订单原价金额的比值。</p><p>​下面的插入语句感觉有点小问题，语句统计的是累积参与情况，不是最近30日的。</p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_activity_stats<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_activity_stats<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>activity_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动名称'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动开始日期'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动订单数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动订单原始金额'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动订单最终金额'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>reduce_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'补贴率'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品销售统计'</span><span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>LOCATION <span class="token string">'/warehouse/gmall/ads/ads_activity_stats/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据装载</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_activity_stats<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_activity_stats<span class="token keyword">union</span><span class="token keyword">select</span>    <span class="token string">'2022-09-01'</span> dt<span class="token punctuation">,</span>    t4<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>    activity_name<span class="token punctuation">,</span>    start_date<span class="token punctuation">,</span>    order_count<span class="token punctuation">,</span>    order_original_amount<span class="token punctuation">,</span>    order_final_amount<span class="token punctuation">,</span>    reduce_amount<span class="token punctuation">,</span>    reduce_rate<span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            activity_id<span class="token punctuation">,</span>            activity_name<span class="token punctuation">,</span>            date_format<span class="token punctuation">(</span>start_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> start_date        <span class="token keyword">from</span> dim_activity_rule_info        <span class="token keyword">group</span> <span class="token keyword">by</span> activity_id<span class="token punctuation">,</span>activity_name<span class="token punctuation">,</span>start_time    <span class="token punctuation">)</span>t4        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            activity_id<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span> reduce_amount<span class="token punctuation">,</span>            cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> reduce_rate        <span class="token keyword">from</span> dwt_activity_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> activity_id    <span class="token punctuation">)</span>t5    <span class="token keyword">on</span> t4<span class="token punctuation">.</span>activity_id<span class="token operator">=</span>t5<span class="token punctuation">.</span>activity_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-ADS层业务数据导入脚本"><a href="#7-ADS层业务数据导入脚本" class="headerlink" title="7. ADS层业务数据导入脚本"></a>7. ADS层业务数据导入脚本</h2><p>注意修改优惠卷主题，数据有点小问题，</p><pre class="line-numbers language-sql"><code class="language-sql">ads_activity_stats<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.ads_activity_statsselect * from ${APP}.ads_activity_statsunionselect    '$do_date' dt,    t4.activity_id,    activity_name,    start_date,    order_count,    order_original_amount,    order_final_amount,    reduce_amount,    reduce_ratefrom(    select        activity_id,        activity_name,        date_format(start_time,'yyyy-MM-dd') start_date    from ${APP}.dim_activity_rule_info    group by activity_id,activity_name,start_time)t4left join(    select        activity_id,        sum(order_count) order_count,        sum(order_original_amount) order_original_amount,        sum(order_final_amount) order_final_amount,        sum(order_reduce_amount) reduce_amount,        cast(sum(order_reduce_amount)/sum(order_original_amount)*100 as decimal(16,2)) reduce_rate    from ${APP}.dwt_activity_topic    where dt='$do_date'    group by activity_id)t5on t4.activity_id=t5.activity_id;"</span>ads_coupon_stats<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.ads_coupon_statsselect * from ${APP}.ads_coupon_statsunionselect    '$do_date' dt,    t1.id,    coupon_name,    start_date,    rule_name,    get_count,    order_count,    expire_count,    order_original_amount,    order_final_amount,    reduce_amount,    reduce_ratefrom(    select        id,        coupon_name,        date_format(start_time,'yyyy-MM-dd') start_date,        case            when coupon_type='3201' then concat('满',condition_amount,'元减',benefit_amount,'元')            when coupon_type='3202' then concat('满',condition_num,'件打', (1-benefit_discount)*10,'折')            when coupon_type='3203' then concat('减',benefit_amount,'元')        end rule_name    from ${APP}.dim_coupon_info    where dt='$do_date')t1left join(    select        coupon_id,        get_count,        order_count,        expire_count,        order_original_amount,        order_final_amount,        order_reduce_amount reduce_amount,        cast(order_reduce_amount/order_original_amount as decimal(16,2)) reduce_rate    from ${APP}.dwt_coupon_topic    where dt='$do_date')t2on t1.id=t2.coupon_id;"</span>ads_order_spu_stats<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.ads_order_spu_statsselect * from ${APP}.ads_order_spu_statsunionselect    '$do_date' dt,    spu_id,    spu_name,    tm_id,    tm_name,    category3_id,    category3_name,    category2_id,    category2_name,    category1_id,    category1_name,    sum(order_count),    sum(order_final_amount)from(    select        sku_id,        order_count,        order_final_amount    from ${APP}.dwt_sku_topic    where dt='$do_date')t1left join(    select        id,        spu_id,        spu_name,        tm_id,        tm_name,        category3_id,        category3_name,        category2_id,        category2_name,        category1_id,        category1_name    from ${APP}.dim_sku_info    where dt='$do_date')t2on t1.sku_id=t2.idgroup by spu_id,spu_name,tm_id,tm_name,category3_id,category3_name,category2_id,category2_name,category1_id,category1_name;"</span>ads_repeat_purchase<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.ads_repeat_purchaseselect * from ${APP}.ads_repeat_purchaseunionselect    '$do_date' dt,    tm_id,    tm_name,    cast(sum(if(order_count>=2,1,0))/sum(if(order_count>=1,1,0))*100 as decimal(16,2))from(    select        user_id,        tm_id,        tm_name,        sum(order_count) order_count    from    (        select            user_id,            sku_id,            count(*) order_count        from ${APP}.dwd_order_detail        where dt>=date_add('$do_date',-6) and dt&lt;='$do_date'        group by user_id,sku_id    )t1    left join    (        select            id,            tm_id,            tm_name        from ${APP}.dim_sku_info        where dt='$do_date'    )t2    on t1.sku_id=t2.id    group by user_id,tm_id,tm_name)t3group by tm_id,tm_name;"</span>ads_order_total<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.ads_order_totalselect * from ${APP}.ads_order_totalunionselect    '$do_date',    sum(order_count),    sum(order_final_amount) order_final_amount,    sum(if(order_final_amount>0,1,0)) order_user_countfrom ${APP}.dwt_user_topicwhere dt='$do_date';"</span>ads_order_by_province<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.ads_order_by_provinceselect * from ${APP}.ads_order_by_provinceunionselect    '$do_date' dt,    province_id,    province_name,    area_code,    iso_code,    iso_3166_2,    order_count,    order_final_amountfrom(    select        province_id,        order_count,        order_final_amount    from ${APP}.dwt_area_topic    where dt='$do_date')t1left join(    select        id,        province_name,        area_code,        iso_code,        iso_3166_2    from ${APP}.dim_base_province)t2on t1.province_id=t2.id;"</span>ads_user_total<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.ads_user_totalselect * from ${APP}.ads_user_totalunionselect    '$do_date',    sum(if(login_date_first='$do_date',1,0)) new_user_count,    sum(if(order_date_first='$do_date',1,0)) new_order_user_count,    sum(order_final_amount) order_final_amount,    sum(if(order_final_amount>0,1,0)) order_user_count,    sum(if(login_date_last='$do_date' and order_final_amount=0,1,0)) no_order_user_countfrom ${APP}.dwt_user_topicwhere dt='$do_date';"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 离线数仓 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ADS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DWT层</title>
      <link href="/2022/09/22/DWT%E5%B1%82/"/>
      <url>/2022/09/22/DWT%E5%B1%82/</url>
      
        <content type="html"><![CDATA[<h2 id="1-访客主题"><a href="#1-访客主题" class="headerlink" title="1. 访客主题"></a>1. 访客主题</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_visitor_topic<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_visitor_topic<span class="token punctuation">(</span>    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'应用版本'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_date_first<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'首次访问时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_date_last<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'末次访问时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_last_1d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日访问天数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_last_7d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日访问天数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_last_30d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日访问天数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积访问次数'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--用户行为日志历史数据无法获取，故该字段实为从数仓搭建日至今的累积值</span>    <span class="token punctuation">`</span>visit_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积访问天数'</span><span class="token comment" spellcheck="true">--用户行为日志历史数据无法获取，故该字段实为从数仓搭建日至今的累积值</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'设备主题宽表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_visitor_topic'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据装载</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_visitor_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>old<span class="token punctuation">.</span>brand<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>model<span class="token punctuation">,</span>old<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>channel<span class="token punctuation">,</span>old<span class="token punctuation">.</span>channel<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>os<span class="token punctuation">,</span>old<span class="token punctuation">.</span>os<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>old<span class="token punctuation">.</span>area_code<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>version_code<span class="token punctuation">,</span>old<span class="token punctuation">.</span>version_code<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">case</span> <span class="token keyword">when</span> old<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>is_new<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'2022-09-01'</span>         <span class="token keyword">when</span> old<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>is_new<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'2022-08-31'</span><span class="token comment" spellcheck="true">--无法获取准确的首次登录日期，给定一个数仓搭建日之前的日期</span>         <span class="token keyword">else</span> old<span class="token punctuation">.</span>visit_date_first <span class="token keyword">end</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>visit_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            mid_id<span class="token punctuation">,</span>            brand<span class="token punctuation">,</span>            model<span class="token punctuation">,</span>            channel<span class="token punctuation">,</span>            os<span class="token punctuation">,</span>            area_code<span class="token punctuation">,</span>            version_code<span class="token punctuation">,</span>            visit_date_first<span class="token punctuation">,</span>            visit_date_last<span class="token punctuation">,</span>            visit_last_1d_count<span class="token punctuation">,</span>            visit_last_1d_day_count<span class="token punctuation">,</span>            visit_last_7d_count<span class="token punctuation">,</span>            visit_last_7d_day_count<span class="token punctuation">,</span>            visit_last_30d_count<span class="token punctuation">,</span>            visit_last_30d_day_count<span class="token punctuation">,</span>            visit_count<span class="token punctuation">,</span>            visit_day_count        <span class="token keyword">from</span> dwt_visitor_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>old        <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            mid_id<span class="token punctuation">,</span>            brand<span class="token punctuation">,</span>            model<span class="token punctuation">,</span>            is_new<span class="token punctuation">,</span>            channel<span class="token punctuation">,</span>            os<span class="token punctuation">,</span>            area_code<span class="token punctuation">,</span>            version_code<span class="token punctuation">,</span>            visit_count        <span class="token keyword">from</span> dws_visitor_action_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>1d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>mid_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            mid_id<span class="token punctuation">,</span>            brand<span class="token punctuation">,</span>            model<span class="token punctuation">,</span>            is_new<span class="token punctuation">,</span>            channel<span class="token punctuation">,</span>            os<span class="token punctuation">,</span>            area_code<span class="token punctuation">,</span>            version_code<span class="token punctuation">,</span>            visit_count        <span class="token keyword">from</span> dws_visitor_action_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>7d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>mid_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            mid_id<span class="token punctuation">,</span>            brand<span class="token punctuation">,</span>            model<span class="token punctuation">,</span>            is_new<span class="token punctuation">,</span>            channel<span class="token punctuation">,</span>            os<span class="token punctuation">,</span>            area_code<span class="token punctuation">,</span>            version_code<span class="token punctuation">,</span>            visit_count        <span class="token keyword">from</span> dws_visitor_action_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>30d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>mid_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-用户主题"><a href="#2-用户主题" class="headerlink" title="2. 用户主题"></a>2. 用户主题</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_user_topic<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_user_topic<span class="token punctuation">(</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_date_first<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'首次活跃日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_date_last<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'末次活跃日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_date_1d_count<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'最近1日登录次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_last_1d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日登录天数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日登录次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_last_7d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日登录天数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日登录次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_last_30d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日登录天数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积登录次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积登录天数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_date_first<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'首次下单时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_date_last<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'末次下单时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日订单参与活动次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日订单减免金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日下单用券次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日订单减免金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日原始下单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日最终下单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日订单参与活动次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日订单减免金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日下单用券次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日订单减免金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日原始下单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日最终下单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日订单参与活动次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日订单减免金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日下单用券次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日订单减免金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日原始下单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日最终下单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积订单参与活动次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积订单减免金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单用券次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积订单减免金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积原始下单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积最终下单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_date_first<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'首次支付时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_date_last<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'末次支付时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_last_1d_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日领券次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_last_1d_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日用券(下单)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_last_1d_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日用券(支付)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_last_7d_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日领券次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_last_7d_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日用券(下单)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_last_7d_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日用券(支付)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_last_30d_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日领券次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_last_30d_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日用券(下单)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_last_30d_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日用券(支付)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积领券次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积用券(下单)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积用券(支付)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_1d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日好评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_1d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日中评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_1d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日差评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_1d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日默认评价次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_7d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日好评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_7d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日中评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_7d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日差评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_7d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日默认评价次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_30d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日好评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_30d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日中评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_30d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日差评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_30d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日默认评价次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积好评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积中评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积差评次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积默认评价次数'</span><span class="token punctuation">)</span><span class="token keyword">COMMENT</span> <span class="token string">'会员主题宽表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_user_topic/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首日导入</p><p>还未尝试，主要是他会把所有的分区全部导入一个分区中，跟我的数据不太匹配。采用每日导入的策略</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_user_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    login_date_first<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--以用户的创建日期作为首次登录日期</span>    nvl<span class="token punctuation">(</span>login_date_last<span class="token punctuation">,</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--若有历史登录记录，则根据历史记录获取末次登录日期，否则统一指定一个日期</span>    nvl<span class="token punctuation">(</span>login_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_1d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    order_date_first<span class="token punctuation">,</span>    order_date_last<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    payment_date_first<span class="token punctuation">,</span>    payment_date_last<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_1d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_1d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_1d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_7d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_7d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_7d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_30d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_30d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_30d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> login_date_first    <span class="token keyword">from</span> dim_user_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id user_id<span class="token punctuation">,</span>        <span class="token function">max</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span> login_date_last<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span> <span class="token operator">and</span> login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_1d_day_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">and</span> login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_7d_day_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span> <span class="token operator">and</span> login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_30d_day_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_day_count<span class="token punctuation">,</span>        <span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_date_first<span class="token punctuation">,</span>        <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_date_last<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_date_first<span class="token punctuation">,</span>        <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_date_last<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span> favor_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_1d_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_1d_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_1d_used_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_7d_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_7d_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_7d_used_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_30d_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_30d_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_30d_used_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">)</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span> appraise_default_count    <span class="token keyword">from</span> dws_user_action_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_user_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_date_first<span class="token punctuation">,</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>login_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_date_first <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'2022-09-01'</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>order_date_first<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_date_first <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'2022-09-01'</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>payment_date_first<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_7d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_7d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_7d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_30d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_30d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_30d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            login_date_first<span class="token punctuation">,</span>            login_date_last<span class="token punctuation">,</span>            login_date_1d_count<span class="token punctuation">,</span>            login_last_1d_day_count<span class="token punctuation">,</span>            login_last_7d_count<span class="token punctuation">,</span>            login_last_7d_day_count<span class="token punctuation">,</span>            login_last_30d_count<span class="token punctuation">,</span>            login_last_30d_day_count<span class="token punctuation">,</span>            login_count<span class="token punctuation">,</span>            login_day_count<span class="token punctuation">,</span>            order_date_first<span class="token punctuation">,</span>            order_date_last<span class="token punctuation">,</span>            order_last_1d_count<span class="token punctuation">,</span>            order_activity_last_1d_count<span class="token punctuation">,</span>            order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>            order_coupon_last_1d_count<span class="token punctuation">,</span>            order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>            order_last_1d_original_amount<span class="token punctuation">,</span>            order_last_1d_final_amount<span class="token punctuation">,</span>            order_last_7d_count<span class="token punctuation">,</span>            order_activity_last_7d_count<span class="token punctuation">,</span>            order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>            order_coupon_last_7d_count<span class="token punctuation">,</span>            order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>            order_last_7d_original_amount<span class="token punctuation">,</span>            order_last_7d_final_amount<span class="token punctuation">,</span>            order_last_30d_count<span class="token punctuation">,</span>            order_activity_last_30d_count<span class="token punctuation">,</span>            order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>            order_coupon_last_30d_count<span class="token punctuation">,</span>            order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>            order_last_30d_original_amount<span class="token punctuation">,</span>            order_last_30d_final_amount<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_activity_count<span class="token punctuation">,</span>            order_activity_reduce_amount<span class="token punctuation">,</span>            order_coupon_count<span class="token punctuation">,</span>            order_coupon_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_date_first<span class="token punctuation">,</span>            payment_date_last<span class="token punctuation">,</span>            payment_last_1d_count<span class="token punctuation">,</span>            payment_last_1d_amount<span class="token punctuation">,</span>            payment_last_7d_count<span class="token punctuation">,</span>            payment_last_7d_amount<span class="token punctuation">,</span>            payment_last_30d_count<span class="token punctuation">,</span>            payment_last_30d_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_last_1d_count<span class="token punctuation">,</span>            refund_order_last_1d_num<span class="token punctuation">,</span>            refund_order_last_1d_amount<span class="token punctuation">,</span>            refund_order_last_7d_count<span class="token punctuation">,</span>            refund_order_last_7d_num<span class="token punctuation">,</span>            refund_order_last_7d_amount<span class="token punctuation">,</span>            refund_order_last_30d_count<span class="token punctuation">,</span>            refund_order_last_30d_num<span class="token punctuation">,</span>            refund_order_last_30d_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_num<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_last_1d_count<span class="token punctuation">,</span>            refund_payment_last_1d_num<span class="token punctuation">,</span>            refund_payment_last_1d_amount<span class="token punctuation">,</span>            refund_payment_last_7d_count<span class="token punctuation">,</span>            refund_payment_last_7d_num<span class="token punctuation">,</span>            refund_payment_last_7d_amount<span class="token punctuation">,</span>            refund_payment_last_30d_count<span class="token punctuation">,</span>            refund_payment_last_30d_num<span class="token punctuation">,</span>            refund_payment_last_30d_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_num<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            cart_last_1d_count<span class="token punctuation">,</span>            cart_last_7d_count<span class="token punctuation">,</span>            cart_last_30d_count<span class="token punctuation">,</span>            cart_count<span class="token punctuation">,</span>            favor_last_1d_count<span class="token punctuation">,</span>            favor_last_7d_count<span class="token punctuation">,</span>            favor_last_30d_count<span class="token punctuation">,</span>            favor_count<span class="token punctuation">,</span>            coupon_last_1d_get_count<span class="token punctuation">,</span>            coupon_last_1d_using_count<span class="token punctuation">,</span>            coupon_last_1d_used_count<span class="token punctuation">,</span>            coupon_last_7d_get_count<span class="token punctuation">,</span>            coupon_last_7d_using_count<span class="token punctuation">,</span>            coupon_last_7d_used_count<span class="token punctuation">,</span>            coupon_last_30d_get_count<span class="token punctuation">,</span>            coupon_last_30d_using_count<span class="token punctuation">,</span>            coupon_last_30d_used_count<span class="token punctuation">,</span>            coupon_get_count<span class="token punctuation">,</span>            coupon_using_count<span class="token punctuation">,</span>            coupon_used_count<span class="token punctuation">,</span>            appraise_last_1d_good_count<span class="token punctuation">,</span>            appraise_last_1d_mid_count<span class="token punctuation">,</span>            appraise_last_1d_bad_count<span class="token punctuation">,</span>            appraise_last_1d_default_count<span class="token punctuation">,</span>            appraise_last_7d_good_count<span class="token punctuation">,</span>            appraise_last_7d_mid_count<span class="token punctuation">,</span>            appraise_last_7d_bad_count<span class="token punctuation">,</span>            appraise_last_7d_default_count<span class="token punctuation">,</span>            appraise_last_30d_good_count<span class="token punctuation">,</span>            appraise_last_30d_mid_count<span class="token punctuation">,</span>            appraise_last_30d_bad_count<span class="token punctuation">,</span>            appraise_last_30d_default_count<span class="token punctuation">,</span>            appraise_good_count<span class="token punctuation">,</span>            appraise_mid_count<span class="token punctuation">,</span>            appraise_bad_count<span class="token punctuation">,</span>            appraise_default_count        <span class="token keyword">from</span> dwt_user_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>old        <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            login_count<span class="token punctuation">,</span>            cart_count<span class="token punctuation">,</span>            favor_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_activity_count<span class="token punctuation">,</span>            order_activity_reduce_amount<span class="token punctuation">,</span>            order_coupon_count<span class="token punctuation">,</span>            order_coupon_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_num<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_num<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            coupon_get_count<span class="token punctuation">,</span>            coupon_using_count<span class="token punctuation">,</span>            coupon_used_count<span class="token punctuation">,</span>            appraise_good_count<span class="token punctuation">,</span>            appraise_mid_count<span class="token punctuation">,</span>            appraise_bad_count<span class="token punctuation">,</span>            appraise_default_count        <span class="token keyword">from</span> dws_user_action_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>1d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>user_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>user_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            login_count<span class="token punctuation">,</span>            cart_count<span class="token punctuation">,</span>            favor_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_activity_count<span class="token punctuation">,</span>            order_activity_reduce_amount<span class="token punctuation">,</span>            order_coupon_count<span class="token punctuation">,</span>            order_coupon_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_num<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_num<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            coupon_get_count<span class="token punctuation">,</span>            coupon_using_count<span class="token punctuation">,</span>            coupon_used_count<span class="token punctuation">,</span>            appraise_good_count<span class="token punctuation">,</span>            appraise_mid_count<span class="token punctuation">,</span>            appraise_bad_count<span class="token punctuation">,</span>            appraise_default_count        <span class="token keyword">from</span> dws_user_action_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>7d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>user_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>user_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            login_count<span class="token punctuation">,</span>            cart_count<span class="token punctuation">,</span>            favor_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_activity_count<span class="token punctuation">,</span>            order_activity_reduce_amount<span class="token punctuation">,</span>            order_coupon_count<span class="token punctuation">,</span>            order_coupon_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_num<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_num<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            coupon_get_count<span class="token punctuation">,</span>            coupon_using_count<span class="token punctuation">,</span>            coupon_used_count<span class="token punctuation">,</span>            appraise_good_count<span class="token punctuation">,</span>            appraise_mid_count<span class="token punctuation">,</span>            appraise_bad_count<span class="token punctuation">,</span>            appraise_default_count        <span class="token keyword">from</span> dws_user_action_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>30d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>user_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-商品主题"><a href="#3-商品主题" class="headerlink" title="3. 商品主题"></a>3. 商品主题</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_sku_topic<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_sku_topic<span class="token punctuation">(</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku_id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被下单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与活动被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用优惠券被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日优惠金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日优惠金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被下单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日参与活动被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用优惠券被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日优惠金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日优惠金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被下单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日参与活动被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用优惠券被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日优惠金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日优惠金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被下单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积参与活动被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积使用优惠券被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积优惠金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积优惠金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被支付件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被支付件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被支付件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被支付件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_1d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日好评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_1d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日中评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_1d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日差评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_1d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日默认评价数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_7d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日好评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_7d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日中评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_7d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日差评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_7d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日默认评价数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_30d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日好评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_30d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日中评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_30d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日差评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_last_30d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日默认评价数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积好评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积中评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积差评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积默认评价数'</span><span class="token punctuation">)</span><span class="token keyword">COMMENT</span> <span class="token string">'商品主题宽表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_sku_topic/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首日导入</p><p>未尝试，需要修改，本处使用了每日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_sku_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id    <span class="token keyword">from</span> dim_sku_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_num<span class="token punctuation">)</span> order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_num<span class="token punctuation">)</span> payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span> favor_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span> appraise_default_count    <span class="token keyword">from</span> dws_sku_action_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>sku_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_sku_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            order_last_1d_count<span class="token punctuation">,</span>            order_last_1d_num<span class="token punctuation">,</span>            order_activity_last_1d_count<span class="token punctuation">,</span>            order_coupon_last_1d_count<span class="token punctuation">,</span>            order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>            order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>            order_last_1d_original_amount<span class="token punctuation">,</span>            order_last_1d_final_amount<span class="token punctuation">,</span>            order_last_7d_count<span class="token punctuation">,</span>            order_last_7d_num<span class="token punctuation">,</span>            order_activity_last_7d_count<span class="token punctuation">,</span>            order_coupon_last_7d_count<span class="token punctuation">,</span>            order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>            order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>            order_last_7d_original_amount<span class="token punctuation">,</span>            order_last_7d_final_amount<span class="token punctuation">,</span>            order_last_30d_count<span class="token punctuation">,</span>            order_last_30d_num<span class="token punctuation">,</span>            order_activity_last_30d_count<span class="token punctuation">,</span>            order_coupon_last_30d_count<span class="token punctuation">,</span>            order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>            order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>            order_last_30d_original_amount<span class="token punctuation">,</span>            order_last_30d_final_amount<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_num<span class="token punctuation">,</span>            order_activity_count<span class="token punctuation">,</span>            order_coupon_count<span class="token punctuation">,</span>            order_activity_reduce_amount<span class="token punctuation">,</span>            order_coupon_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_last_1d_count<span class="token punctuation">,</span>            payment_last_1d_num<span class="token punctuation">,</span>            payment_last_1d_amount<span class="token punctuation">,</span>            payment_last_7d_count<span class="token punctuation">,</span>            payment_last_7d_num<span class="token punctuation">,</span>            payment_last_7d_amount<span class="token punctuation">,</span>            payment_last_30d_count<span class="token punctuation">,</span>            payment_last_30d_num<span class="token punctuation">,</span>            payment_last_30d_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_num<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_last_1d_count<span class="token punctuation">,</span>            refund_order_last_1d_num<span class="token punctuation">,</span>            refund_order_last_1d_amount<span class="token punctuation">,</span>            refund_order_last_7d_count<span class="token punctuation">,</span>            refund_order_last_7d_num<span class="token punctuation">,</span>            refund_order_last_7d_amount<span class="token punctuation">,</span>            refund_order_last_30d_count<span class="token punctuation">,</span>            refund_order_last_30d_num<span class="token punctuation">,</span>            refund_order_last_30d_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_num<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_last_1d_count<span class="token punctuation">,</span>            refund_payment_last_1d_num<span class="token punctuation">,</span>            refund_payment_last_1d_amount<span class="token punctuation">,</span>            refund_payment_last_7d_count<span class="token punctuation">,</span>            refund_payment_last_7d_num<span class="token punctuation">,</span>            refund_payment_last_7d_amount<span class="token punctuation">,</span>            refund_payment_last_30d_count<span class="token punctuation">,</span>            refund_payment_last_30d_num<span class="token punctuation">,</span>            refund_payment_last_30d_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_num<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            cart_last_1d_count<span class="token punctuation">,</span>            cart_last_7d_count<span class="token punctuation">,</span>            cart_last_30d_count<span class="token punctuation">,</span>            cart_count<span class="token punctuation">,</span>            favor_last_1d_count<span class="token punctuation">,</span>            favor_last_7d_count<span class="token punctuation">,</span>            favor_last_30d_count<span class="token punctuation">,</span>            favor_count<span class="token punctuation">,</span>            appraise_last_1d_good_count<span class="token punctuation">,</span>            appraise_last_1d_mid_count<span class="token punctuation">,</span>            appraise_last_1d_bad_count<span class="token punctuation">,</span>            appraise_last_1d_default_count<span class="token punctuation">,</span>            appraise_last_7d_good_count<span class="token punctuation">,</span>            appraise_last_7d_mid_count<span class="token punctuation">,</span>            appraise_last_7d_bad_count<span class="token punctuation">,</span>            appraise_last_7d_default_count<span class="token punctuation">,</span>            appraise_last_30d_good_count<span class="token punctuation">,</span>            appraise_last_30d_mid_count<span class="token punctuation">,</span>            appraise_last_30d_bad_count<span class="token punctuation">,</span>            appraise_last_30d_default_count<span class="token punctuation">,</span>            appraise_good_count<span class="token punctuation">,</span>            appraise_mid_count<span class="token punctuation">,</span>            appraise_bad_count<span class="token punctuation">,</span>            appraise_default_count        <span class="token keyword">from</span> dwt_sku_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>old        <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_num<span class="token punctuation">,</span>            order_activity_count<span class="token punctuation">,</span>            order_coupon_count<span class="token punctuation">,</span>            order_activity_reduce_amount<span class="token punctuation">,</span>            order_coupon_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_num<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_num<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_num<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            cart_count<span class="token punctuation">,</span>            favor_count<span class="token punctuation">,</span>            appraise_good_count<span class="token punctuation">,</span>            appraise_mid_count<span class="token punctuation">,</span>            appraise_bad_count<span class="token punctuation">,</span>            appraise_default_count        <span class="token keyword">from</span> dws_sku_action_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>1d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>sku_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_num<span class="token punctuation">,</span>            order_activity_count<span class="token punctuation">,</span>            order_coupon_count<span class="token punctuation">,</span>            order_activity_reduce_amount<span class="token punctuation">,</span>            order_coupon_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_num<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_num<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_num<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            cart_count<span class="token punctuation">,</span>            favor_count<span class="token punctuation">,</span>            appraise_good_count<span class="token punctuation">,</span>            appraise_mid_count<span class="token punctuation">,</span>            appraise_bad_count<span class="token punctuation">,</span>            appraise_default_count        <span class="token keyword">from</span> dws_sku_action_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>7d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>sku_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_num<span class="token punctuation">,</span>            order_activity_count<span class="token punctuation">,</span>            order_coupon_count<span class="token punctuation">,</span>            order_activity_reduce_amount<span class="token punctuation">,</span>            order_coupon_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_num<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_num<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_num<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            cart_count<span class="token punctuation">,</span>            favor_count<span class="token punctuation">,</span>            appraise_good_count<span class="token punctuation">,</span>            appraise_mid_count<span class="token punctuation">,</span>            appraise_bad_count<span class="token punctuation">,</span>            appraise_default_count        <span class="token keyword">from</span> dws_sku_action_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>30d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>sku_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-优惠券主题"><a href="#4-优惠券主题" class="headerlink" title="4. 优惠券主题"></a>4. 优惠券主题</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_coupon_topic<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_coupon_topic<span class="token punctuation">(</span>    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>get_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日领取次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>get_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日领取次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>get_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日领取次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积领取次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券下单优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券下单优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券下单优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积使用(下单)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积下单优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积使用(支付)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日过期次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日过期次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日过期次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积过期次数'</span><span class="token punctuation">)</span><span class="token keyword">comment</span> <span class="token string">'优惠券主题表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_coupon_topic/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_coupon_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>get_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>get_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>get_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>expire_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>expire_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>expire_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id    <span class="token keyword">from</span> dim_coupon_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id coupon_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>get_count<span class="token punctuation">)</span> get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>expire_count<span class="token punctuation">)</span> expire_count    <span class="token keyword">from</span> dws_coupon_info_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>coupon_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_coupon_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>get_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>get_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>expire_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>expire_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            coupon_id<span class="token punctuation">,</span>            get_last_1d_count<span class="token punctuation">,</span>            get_last_7d_count<span class="token punctuation">,</span>            get_last_30d_count<span class="token punctuation">,</span>            get_count<span class="token punctuation">,</span>            order_last_1d_count<span class="token punctuation">,</span>            order_last_1d_reduce_amount<span class="token punctuation">,</span>            order_last_1d_original_amount<span class="token punctuation">,</span>            order_last_1d_final_amount<span class="token punctuation">,</span>            order_last_7d_count<span class="token punctuation">,</span>            order_last_7d_reduce_amount<span class="token punctuation">,</span>            order_last_7d_original_amount<span class="token punctuation">,</span>            order_last_7d_final_amount<span class="token punctuation">,</span>            order_last_30d_count<span class="token punctuation">,</span>            order_last_30d_reduce_amount<span class="token punctuation">,</span>            order_last_30d_original_amount<span class="token punctuation">,</span>            order_last_30d_final_amount<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_last_1d_count<span class="token punctuation">,</span>            payment_last_1d_reduce_amount<span class="token punctuation">,</span>            payment_last_1d_amount<span class="token punctuation">,</span>            payment_last_7d_count<span class="token punctuation">,</span>            payment_last_7d_reduce_amount<span class="token punctuation">,</span>            payment_last_7d_amount<span class="token punctuation">,</span>            payment_last_30d_count<span class="token punctuation">,</span>            payment_last_30d_reduce_amount<span class="token punctuation">,</span>            payment_last_30d_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_reduce_amount<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            expire_last_1d_count<span class="token punctuation">,</span>            expire_last_7d_count<span class="token punctuation">,</span>            expire_last_30d_count<span class="token punctuation">,</span>            expire_count        <span class="token keyword">from</span> dwt_coupon_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>old        <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            coupon_id<span class="token punctuation">,</span>            get_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_reduce_amount<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            expire_count        <span class="token keyword">from</span> dws_coupon_info_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>1d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>coupon_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            coupon_id<span class="token punctuation">,</span>            get_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_reduce_amount<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            expire_count        <span class="token keyword">from</span> dws_coupon_info_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>7d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>coupon_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            coupon_id<span class="token punctuation">,</span>            get_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_reduce_amount<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            expire_count        <span class="token keyword">from</span> dws_coupon_info_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>30d_ago    <span class="token keyword">on</span> old<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>coupon_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-活动主题"><a href="#5-活动主题" class="headerlink" title="5. 活动主题"></a>5. 活动主题</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_activity_topic<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_activity_topic<span class="token punctuation">(</span>    <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则下单优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积下单优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则支付优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积支付优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积支付金额'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动主题宽表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_activity_topic/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_activity_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    t1<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id    <span class="token keyword">from</span> dim_activity_rule_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> dws_activity_info_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>activity_rule_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>activity_rule_id<span class="token operator">and</span> t1<span class="token punctuation">.</span>activity_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>activity_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_activity_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>activity_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount    <span class="token keyword">from</span> dwt_activity_topic    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>old<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount    <span class="token keyword">from</span> dws_activity_info_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span>1d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>activity_rule_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-地区主题"><a href="#6-地区主题" class="headerlink" title="6. 地区主题"></a>6. 地区主题</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_area_topic<span class="token punctuation">;</span>    <span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_area_topic<span class="token punctuation">(</span>    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日访客访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日用户访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7访客访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日用户访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日访客访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日用户访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积访客访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积用户访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_7d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_last_30d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款金额'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'地区主题宽表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_area_topic/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_area_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>visit_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>visit_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id    <span class="token keyword">from</span> dim_base_province<span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id province_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>visit_count<span class="token punctuation">)</span> visit_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount    <span class="token keyword">from</span> dws_area_stats_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>province_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_area_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>today<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>today<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            province_id<span class="token punctuation">,</span>            visit_count<span class="token punctuation">,</span>            login_count<span class="token punctuation">,</span>            visit_last_7d_count<span class="token punctuation">,</span>            login_last_7d_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            order_last_7d_count<span class="token punctuation">,</span>            order_last_7d_original_amount<span class="token punctuation">,</span>            order_last_7d_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            payment_last_7d_count<span class="token punctuation">,</span>            payment_last_7d_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_order_last_7d_count<span class="token punctuation">,</span>            refund_order_last_7d_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            refund_payment_last_7d_count<span class="token punctuation">,</span>            refund_payment_last_7d_amount        <span class="token keyword">from</span> dwt_area_topic        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>old        <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            province_id<span class="token punctuation">,</span>            visit_count<span class="token punctuation">,</span>            login_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_amount        <span class="token keyword">from</span> dws_area_stats_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>today    <span class="token keyword">on</span> old<span class="token punctuation">.</span>province_id<span class="token operator">=</span>today<span class="token punctuation">.</span>province_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            province_id<span class="token punctuation">,</span>            visit_count<span class="token punctuation">,</span>            login_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_amount        <span class="token keyword">from</span> dws_area_stats_daycount        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>7d_ago    <span class="token keyword">on</span> nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>today<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token operator">=</span>today<span class="token punctuation">.</span>province_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-DWT层首日导入脚本"><a href="#7-DWT层首日导入脚本" class="headerlink" title="7. DWT层首日导入脚本"></a>7. DWT层首日导入脚本</h2><p>不保证正确性</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#!/bin/bash</span>APP<span class="token operator">=</span>gmall<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$2"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>   do_date<span class="token operator">=</span>$<span class="token number">2</span><span class="token keyword">else</span>    echo <span class="token string">"请传入日期参数"</span>   <span class="token keyword">exit</span>fi dwt_visitor_topic<span class="token operator">=</span>"<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_visitor_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>old<span class="token punctuation">.</span>brand<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>model<span class="token punctuation">,</span>old<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>channel<span class="token punctuation">,</span>old<span class="token punctuation">.</span>channel<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>os<span class="token punctuation">,</span>old<span class="token punctuation">.</span>os<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>old<span class="token punctuation">.</span>area_code<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>version_code<span class="token punctuation">,</span>old<span class="token punctuation">.</span>version_code<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">case</span> <span class="token keyword">when</span> old<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>is_new<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'$do_date'</span>         <span class="token keyword">when</span> old<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>is_new<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'2020-06-13'</span><span class="token comment" spellcheck="true">--无法获取准确的首次登录日期，给定一个数仓搭建日之前的日期</span>         <span class="token keyword">else</span> old<span class="token punctuation">.</span>visit_date_first <span class="token keyword">end</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>visit_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        channel<span class="token punctuation">,</span>        os<span class="token punctuation">,</span>        area_code<span class="token punctuation">,</span>        version_code<span class="token punctuation">,</span>        visit_date_first<span class="token punctuation">,</span>        visit_date_last<span class="token punctuation">,</span>        visit_last_1d_count<span class="token punctuation">,</span>        visit_last_1d_day_count<span class="token punctuation">,</span>        visit_last_7d_count<span class="token punctuation">,</span>        visit_last_7d_day_count<span class="token punctuation">,</span>        visit_last_30d_count<span class="token punctuation">,</span>        visit_last_30d_day_count<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        visit_day_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwt_visitor_topic    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>old<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        is_new<span class="token punctuation">,</span>        channel<span class="token punctuation">,</span>        os<span class="token punctuation">,</span>        area_code<span class="token punctuation">,</span>        version_code<span class="token punctuation">,</span>        visit_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_visitor_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>1d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>mid_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        is_new<span class="token punctuation">,</span>        channel<span class="token punctuation">,</span>        os<span class="token punctuation">,</span>        area_code<span class="token punctuation">,</span>        version_code<span class="token punctuation">,</span>        visit_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_visitor_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>7d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>mid_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        is_new<span class="token punctuation">,</span>        channel<span class="token punctuation">,</span>        os<span class="token punctuation">,</span>        area_code<span class="token punctuation">,</span>        version_code<span class="token punctuation">,</span>        visit_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_visitor_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>30d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>mid_id<span class="token punctuation">;</span><span class="token string">"dwt_user_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_user_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    login_date_first<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--以用户的创建日期作为首次登录日期</span>    nvl<span class="token punctuation">(</span>login_date_last<span class="token punctuation">,</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--若有历史登录记录，则根据历史记录获取末次登录日期，否则统一指定一个日期</span>    nvl<span class="token punctuation">(</span>login_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_1d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    order_date_first<span class="token punctuation">,</span>    order_date_last<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    payment_date_first<span class="token punctuation">,</span>    payment_date_last<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_1d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_1d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_1d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_7d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_7d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_7d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_30d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_30d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_last_30d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> login_date_first    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dim_user_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id user_id<span class="token punctuation">,</span>        <span class="token function">max</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span> login_date_last<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span> <span class="token operator">and</span> login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_1d_day_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">and</span> login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_7d_day_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span> <span class="token operator">and</span> login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_30d_day_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_day_count<span class="token punctuation">,</span>        <span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_date_first<span class="token punctuation">,</span>        <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_date_last<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_date_first<span class="token punctuation">,</span>        <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_date_last<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span> favor_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_1d_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_1d_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_1d_used_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_7d_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_7d_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_7d_used_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_30d_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_30d_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_30d_used_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">)</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span> appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_user_action_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span><span class="token string">"dwt_sku_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_sku_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_1d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dim_sku_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_num<span class="token punctuation">)</span> order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_num<span class="token punctuation">)</span> payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span> favor_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_default_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span> appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_sku_action_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>sku_id<span class="token punctuation">;</span><span class="token string">"dwt_coupon_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_coupon_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>get_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>get_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>get_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>expire_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>expire_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>expire_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dim_coupon_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id coupon_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>get_count<span class="token punctuation">)</span> get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>expire_count<span class="token punctuation">)</span> expire_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_coupon_info_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>coupon_id<span class="token punctuation">;</span><span class="token string">"dwt_activity_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_activity_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    t1<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dim_activity_rule_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_activity_info_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>activity_rule_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>activity_rule_id<span class="token operator">and</span> t1<span class="token punctuation">.</span>activity_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>activity_id<span class="token punctuation">;</span><span class="token string">"dwt_area_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_area_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>visit_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>visit_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dim_base_province<span class="token punctuation">)</span>t1<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id province_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>visit_count<span class="token punctuation">)</span> visit_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_area_stats_daycount    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id<span class="token punctuation">)</span>t2<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>province_id<span class="token punctuation">;</span><span class="token string">"case $1 in    "</span>dwt_visitor_topic<span class="token string">" )        hive -e "</span>$dwt_visitor_topic<span class="token string">"    ;;    "</span>dwt_user_topic<span class="token string">" )        hive -e "</span>$dwt_user_topic<span class="token string">"    ;;    "</span>dwt_sku_topic<span class="token string">" )        hive -e "</span>$dwt_sku_topic<span class="token string">"    ;;    "</span>dwt_activity_topic<span class="token string">" )        hive -e "</span>$dwt_activity_topic<span class="token string">"    ;;    "</span>dwt_coupon_topic<span class="token string">" )        hive -e "</span>$dwt_coupon_topic<span class="token string">"    ;;    "</span>dwt_area_topic<span class="token string">" )        hive -e "</span>$dwt_area_topic<span class="token string">"    ;;    "</span><span class="token keyword">all</span><span class="token string">" )        hive -e "</span>$dwt_visitor_topic$dwt_user_topic$dwt_sku_topic$dwt_activity_topic$dwt_coupon_topic$dwt_area_topic"    <span class="token punctuation">;</span><span class="token punctuation">;</span>esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-DWT层每日导入脚本"><a href="#8-DWT层每日导入脚本" class="headerlink" title="8. DWT层每日导入脚本"></a>8. DWT层每日导入脚本</h2><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#!/bin/bash</span>APP<span class="token operator">=</span>gmall<span class="token comment" spellcheck="true"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$2"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>    do_date<span class="token operator">=</span>$<span class="token number">2</span><span class="token keyword">else</span><span class="token keyword">exit</span>    do_date<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span><span class="token number">d</span> <span class="token string">"-1 day"</span> <span class="token operator">+</span><span class="token operator">%</span>F<span class="token punctuation">`</span>ficlear_date<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span><span class="token number">d</span> <span class="token string">"$do_date -15 day"</span> <span class="token operator">+</span><span class="token operator">%</span>F<span class="token punctuation">`</span>dwt_visitor_topic<span class="token operator">=</span>"<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_visitor_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>old<span class="token punctuation">.</span>brand<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>model<span class="token punctuation">,</span>old<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>channel<span class="token punctuation">,</span>old<span class="token punctuation">.</span>channel<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>os<span class="token punctuation">,</span>old<span class="token punctuation">.</span>os<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>old<span class="token punctuation">.</span>area_code<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>version_code<span class="token punctuation">,</span>old<span class="token punctuation">.</span>version_code<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">case</span> <span class="token keyword">when</span> old<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>is_new<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'$do_date'</span>         <span class="token keyword">when</span> old<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>is_new<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'2022-08-31'</span><span class="token comment" spellcheck="true">--无法获取准确的首次登录日期，给定一个数仓搭建日之前的日期</span>         <span class="token keyword">else</span> old<span class="token punctuation">.</span>visit_date_first <span class="token keyword">end</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>visit_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        channel<span class="token punctuation">,</span>        os<span class="token punctuation">,</span>        area_code<span class="token punctuation">,</span>        version_code<span class="token punctuation">,</span>        visit_date_first<span class="token punctuation">,</span>        visit_date_last<span class="token punctuation">,</span>        visit_last_1d_count<span class="token punctuation">,</span>        visit_last_1d_day_count<span class="token punctuation">,</span>        visit_last_7d_count<span class="token punctuation">,</span>        visit_last_7d_day_count<span class="token punctuation">,</span>        visit_last_30d_count<span class="token punctuation">,</span>        visit_last_30d_day_count<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        visit_day_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwt_visitor_topic    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>old<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        is_new<span class="token punctuation">,</span>        channel<span class="token punctuation">,</span>        os<span class="token punctuation">,</span>        area_code<span class="token punctuation">,</span>        version_code<span class="token punctuation">,</span>        visit_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_visitor_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>1d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>mid_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        is_new<span class="token punctuation">,</span>        channel<span class="token punctuation">,</span>        os<span class="token punctuation">,</span>        area_code<span class="token punctuation">,</span>        version_code<span class="token punctuation">,</span>        visit_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_visitor_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>7d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>mid_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        is_new<span class="token punctuation">,</span>        channel<span class="token punctuation">,</span>        os<span class="token punctuation">,</span>        area_code<span class="token punctuation">,</span>        version_code<span class="token punctuation">,</span>        visit_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_visitor_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>30d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>mid_id<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#alter table ${APP}.dwt_visitor_topic drop partition(dt='$clear_date');</span><span class="token string">"dwt_user_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_user_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_date_first<span class="token punctuation">,</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>login_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_date_first <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'$do_date'</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>order_date_first<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_date_first <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'$do_date'</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>payment_date_first<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_7d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_7d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_7d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_30d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_30d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_30d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        login_date_first<span class="token punctuation">,</span>        login_date_last<span class="token punctuation">,</span>        login_date_1d_count<span class="token punctuation">,</span>        login_last_1d_day_count<span class="token punctuation">,</span>        login_last_7d_count<span class="token punctuation">,</span>        login_last_7d_day_count<span class="token punctuation">,</span>        login_last_30d_count<span class="token punctuation">,</span>        login_last_30d_day_count<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        login_day_count<span class="token punctuation">,</span>        order_date_first<span class="token punctuation">,</span>        order_date_last<span class="token punctuation">,</span>        order_last_1d_count<span class="token punctuation">,</span>        order_activity_last_1d_count<span class="token punctuation">,</span>        order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>        order_coupon_last_1d_count<span class="token punctuation">,</span>        order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>        order_last_1d_original_amount<span class="token punctuation">,</span>        order_last_1d_final_amount<span class="token punctuation">,</span>        order_last_7d_count<span class="token punctuation">,</span>        order_activity_last_7d_count<span class="token punctuation">,</span>        order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>        order_coupon_last_7d_count<span class="token punctuation">,</span>        order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>        order_last_7d_original_amount<span class="token punctuation">,</span>        order_last_7d_final_amount<span class="token punctuation">,</span>        order_last_30d_count<span class="token punctuation">,</span>        order_activity_last_30d_count<span class="token punctuation">,</span>        order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>        order_coupon_last_30d_count<span class="token punctuation">,</span>        order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>        order_last_30d_original_amount<span class="token punctuation">,</span>        order_last_30d_final_amount<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_date_first<span class="token punctuation">,</span>        payment_date_last<span class="token punctuation">,</span>        payment_last_1d_count<span class="token punctuation">,</span>        payment_last_1d_amount<span class="token punctuation">,</span>        payment_last_7d_count<span class="token punctuation">,</span>        payment_last_7d_amount<span class="token punctuation">,</span>        payment_last_30d_count<span class="token punctuation">,</span>        payment_last_30d_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_last_1d_count<span class="token punctuation">,</span>        refund_order_last_1d_num<span class="token punctuation">,</span>        refund_order_last_1d_amount<span class="token punctuation">,</span>        refund_order_last_7d_count<span class="token punctuation">,</span>        refund_order_last_7d_num<span class="token punctuation">,</span>        refund_order_last_7d_amount<span class="token punctuation">,</span>        refund_order_last_30d_count<span class="token punctuation">,</span>        refund_order_last_30d_num<span class="token punctuation">,</span>        refund_order_last_30d_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_last_1d_count<span class="token punctuation">,</span>        refund_payment_last_1d_num<span class="token punctuation">,</span>        refund_payment_last_1d_amount<span class="token punctuation">,</span>        refund_payment_last_7d_count<span class="token punctuation">,</span>        refund_payment_last_7d_num<span class="token punctuation">,</span>        refund_payment_last_7d_amount<span class="token punctuation">,</span>        refund_payment_last_30d_count<span class="token punctuation">,</span>        refund_payment_last_30d_num<span class="token punctuation">,</span>        refund_payment_last_30d_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        cart_last_1d_count<span class="token punctuation">,</span>        cart_last_7d_count<span class="token punctuation">,</span>        cart_last_30d_count<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_last_1d_count<span class="token punctuation">,</span>        favor_last_7d_count<span class="token punctuation">,</span>        favor_last_30d_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        coupon_last_1d_get_count<span class="token punctuation">,</span>        coupon_last_1d_using_count<span class="token punctuation">,</span>        coupon_last_1d_used_count<span class="token punctuation">,</span>        coupon_last_7d_get_count<span class="token punctuation">,</span>        coupon_last_7d_using_count<span class="token punctuation">,</span>        coupon_last_7d_used_count<span class="token punctuation">,</span>        coupon_last_30d_get_count<span class="token punctuation">,</span>        coupon_last_30d_using_count<span class="token punctuation">,</span>        coupon_last_30d_used_count<span class="token punctuation">,</span>        coupon_get_count<span class="token punctuation">,</span>        coupon_using_count<span class="token punctuation">,</span>        coupon_used_count<span class="token punctuation">,</span>        appraise_last_1d_good_count<span class="token punctuation">,</span>        appraise_last_1d_mid_count<span class="token punctuation">,</span>        appraise_last_1d_bad_count<span class="token punctuation">,</span>        appraise_last_1d_default_count<span class="token punctuation">,</span>        appraise_last_7d_good_count<span class="token punctuation">,</span>        appraise_last_7d_mid_count<span class="token punctuation">,</span>        appraise_last_7d_bad_count<span class="token punctuation">,</span>        appraise_last_7d_default_count<span class="token punctuation">,</span>        appraise_last_30d_good_count<span class="token punctuation">,</span>        appraise_last_30d_mid_count<span class="token punctuation">,</span>        appraise_last_30d_bad_count<span class="token punctuation">,</span>        appraise_last_30d_default_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwt_user_topic    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>old<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        coupon_get_count<span class="token punctuation">,</span>        coupon_using_count<span class="token punctuation">,</span>        coupon_used_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_user_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>1d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>user_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>user_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        coupon_get_count<span class="token punctuation">,</span>        coupon_using_count<span class="token punctuation">,</span>        coupon_used_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_user_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>7d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>user_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>user_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        coupon_get_count<span class="token punctuation">,</span>        coupon_using_count<span class="token punctuation">,</span>        coupon_used_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_user_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>30d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>user_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#alter table ${APP}.dwt_user_topic drop partition(dt='$clear_date');</span><span class="token string">"dwt_sku_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_sku_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        order_last_1d_count<span class="token punctuation">,</span>        order_last_1d_num<span class="token punctuation">,</span>        order_activity_last_1d_count<span class="token punctuation">,</span>        order_coupon_last_1d_count<span class="token punctuation">,</span>        order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>        order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>        order_last_1d_original_amount<span class="token punctuation">,</span>        order_last_1d_final_amount<span class="token punctuation">,</span>        order_last_7d_count<span class="token punctuation">,</span>        order_last_7d_num<span class="token punctuation">,</span>        order_activity_last_7d_count<span class="token punctuation">,</span>        order_coupon_last_7d_count<span class="token punctuation">,</span>        order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>        order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>        order_last_7d_original_amount<span class="token punctuation">,</span>        order_last_7d_final_amount<span class="token punctuation">,</span>        order_last_30d_count<span class="token punctuation">,</span>        order_last_30d_num<span class="token punctuation">,</span>        order_activity_last_30d_count<span class="token punctuation">,</span>        order_coupon_last_30d_count<span class="token punctuation">,</span>        order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>        order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>        order_last_30d_original_amount<span class="token punctuation">,</span>        order_last_30d_final_amount<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_num<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_last_1d_count<span class="token punctuation">,</span>        payment_last_1d_num<span class="token punctuation">,</span>        payment_last_1d_amount<span class="token punctuation">,</span>        payment_last_7d_count<span class="token punctuation">,</span>        payment_last_7d_num<span class="token punctuation">,</span>        payment_last_7d_amount<span class="token punctuation">,</span>        payment_last_30d_count<span class="token punctuation">,</span>        payment_last_30d_num<span class="token punctuation">,</span>        payment_last_30d_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_num<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_last_1d_count<span class="token punctuation">,</span>        refund_order_last_1d_num<span class="token punctuation">,</span>        refund_order_last_1d_amount<span class="token punctuation">,</span>        refund_order_last_7d_count<span class="token punctuation">,</span>        refund_order_last_7d_num<span class="token punctuation">,</span>        refund_order_last_7d_amount<span class="token punctuation">,</span>        refund_order_last_30d_count<span class="token punctuation">,</span>        refund_order_last_30d_num<span class="token punctuation">,</span>        refund_order_last_30d_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_last_1d_count<span class="token punctuation">,</span>        refund_payment_last_1d_num<span class="token punctuation">,</span>        refund_payment_last_1d_amount<span class="token punctuation">,</span>        refund_payment_last_7d_count<span class="token punctuation">,</span>        refund_payment_last_7d_num<span class="token punctuation">,</span>        refund_payment_last_7d_amount<span class="token punctuation">,</span>        refund_payment_last_30d_count<span class="token punctuation">,</span>        refund_payment_last_30d_num<span class="token punctuation">,</span>        refund_payment_last_30d_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        cart_last_1d_count<span class="token punctuation">,</span>        cart_last_7d_count<span class="token punctuation">,</span>        cart_last_30d_count<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_last_1d_count<span class="token punctuation">,</span>        favor_last_7d_count<span class="token punctuation">,</span>        favor_last_30d_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        appraise_last_1d_good_count<span class="token punctuation">,</span>        appraise_last_1d_mid_count<span class="token punctuation">,</span>        appraise_last_1d_bad_count<span class="token punctuation">,</span>        appraise_last_1d_default_count<span class="token punctuation">,</span>        appraise_last_7d_good_count<span class="token punctuation">,</span>        appraise_last_7d_mid_count<span class="token punctuation">,</span>        appraise_last_7d_bad_count<span class="token punctuation">,</span>        appraise_last_7d_default_count<span class="token punctuation">,</span>        appraise_last_30d_good_count<span class="token punctuation">,</span>        appraise_last_30d_mid_count<span class="token punctuation">,</span>        appraise_last_30d_bad_count<span class="token punctuation">,</span>        appraise_last_30d_default_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwt_sku_topic    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>old<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_num<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_num<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_sku_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>1d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>sku_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_num<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_num<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_sku_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>7d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>sku_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_num<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_num<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_sku_action_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>30d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>sku_id<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#alter table ${APP}.dwt_sku_topic drop partition(dt='$clear_date');</span><span class="token string">"dwt_activity_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_activity_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>activity_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwt_activity_topic    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>old<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_activity_info_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>1d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>activity_rule_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#alter table ${APP}.dwt_activity_topic drop partition(dt='$clear_date');</span><span class="token string">"dwt_coupon_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_coupon_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>get_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>get_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>expire_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>expire_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        get_last_1d_count<span class="token punctuation">,</span>        get_last_7d_count<span class="token punctuation">,</span>        get_last_30d_count<span class="token punctuation">,</span>        get_count<span class="token punctuation">,</span>        order_last_1d_count<span class="token punctuation">,</span>        order_last_1d_reduce_amount<span class="token punctuation">,</span>        order_last_1d_original_amount<span class="token punctuation">,</span>        order_last_1d_final_amount<span class="token punctuation">,</span>        order_last_7d_count<span class="token punctuation">,</span>        order_last_7d_reduce_amount<span class="token punctuation">,</span>        order_last_7d_original_amount<span class="token punctuation">,</span>        order_last_7d_final_amount<span class="token punctuation">,</span>        order_last_30d_count<span class="token punctuation">,</span>        order_last_30d_reduce_amount<span class="token punctuation">,</span>        order_last_30d_original_amount<span class="token punctuation">,</span>        order_last_30d_final_amount<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_last_1d_count<span class="token punctuation">,</span>        payment_last_1d_reduce_amount<span class="token punctuation">,</span>        payment_last_1d_amount<span class="token punctuation">,</span>        payment_last_7d_count<span class="token punctuation">,</span>        payment_last_7d_reduce_amount<span class="token punctuation">,</span>        payment_last_7d_amount<span class="token punctuation">,</span>        payment_last_30d_count<span class="token punctuation">,</span>        payment_last_30d_reduce_amount<span class="token punctuation">,</span>        payment_last_30d_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        expire_last_1d_count<span class="token punctuation">,</span>        expire_last_7d_count<span class="token punctuation">,</span>        expire_last_30d_count<span class="token punctuation">,</span>        expire_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwt_coupon_topic    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>old<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        get_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        expire_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_coupon_info_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>1d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>coupon_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        get_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        expire_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_coupon_info_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>7d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>coupon_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        get_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        expire_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_coupon_info_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>30d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>coupon_id<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#alter table ${APP}.dwt_coupon_topic drop partition(dt='$clear_date');</span><span class="token string">"dwt_area_topic="</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dwt_area_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span> 1d_ago<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        visit_last_1d_count<span class="token punctuation">,</span>        login_last_1d_count<span class="token punctuation">,</span>        visit_last_7d_count<span class="token punctuation">,</span>        login_last_7d_count<span class="token punctuation">,</span>        visit_last_30d_count<span class="token punctuation">,</span>        login_last_30d_count<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        order_last_1d_count<span class="token punctuation">,</span>        order_last_1d_original_amount<span class="token punctuation">,</span>        order_last_1d_final_amount<span class="token punctuation">,</span>        order_last_7d_count<span class="token punctuation">,</span>        order_last_7d_original_amount<span class="token punctuation">,</span>        order_last_7d_final_amount<span class="token punctuation">,</span>        order_last_30d_count<span class="token punctuation">,</span>        order_last_30d_original_amount<span class="token punctuation">,</span>        order_last_30d_final_amount<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_last_1d_count<span class="token punctuation">,</span>        payment_last_1d_amount<span class="token punctuation">,</span>        payment_last_7d_count<span class="token punctuation">,</span>        payment_last_7d_amount<span class="token punctuation">,</span>        payment_last_30d_count<span class="token punctuation">,</span>        payment_last_30d_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_last_1d_count<span class="token punctuation">,</span>        refund_order_last_1d_amount<span class="token punctuation">,</span>        refund_order_last_7d_count<span class="token punctuation">,</span>        refund_order_last_7d_amount<span class="token punctuation">,</span>        refund_order_last_30d_count<span class="token punctuation">,</span>        refund_order_last_30d_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_last_1d_count<span class="token punctuation">,</span>        refund_payment_last_1d_amount<span class="token punctuation">,</span>        refund_payment_last_7d_count<span class="token punctuation">,</span>        refund_payment_last_7d_amount<span class="token punctuation">,</span>        refund_payment_last_30d_count<span class="token punctuation">,</span>        refund_payment_last_30d_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwt_area_topic    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>old<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_area_stats_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span>1d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>province_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>province_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_area_stats_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>7d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>province_id<span class="token operator">=</span> 7d_ago<span class="token punctuation">.</span>province_id<span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dws_area_stats_daycount    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>30d_ago<span class="token keyword">on</span> old<span class="token punctuation">.</span>province_id<span class="token operator">=</span> 30d_ago<span class="token punctuation">.</span>province_id<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#alter table ${APP}.dwt_area_topic drop partition(dt='$clear_date');</span><span class="token string">"case $1 in    "</span>dwt_visitor_topic<span class="token string">" )        hive -e "</span>$dwt_visitor_topic<span class="token string">"        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_visitor_topic/dt=$clear_date    ;;    "</span>dwt_user_topic<span class="token string">" )        hive -e "</span>$dwt_user_topic<span class="token string">"        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_user_topic/dt=$clear_date    ;;    "</span>dwt_sku_topic<span class="token string">" )        hive -e "</span>$dwt_sku_topic<span class="token string">"        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_sku_topic/dt=$clear_date    ;;    "</span>dwt_activity_topic<span class="token string">" )        hive -e "</span>$dwt_activity_topic<span class="token string">"        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_activity_topic/dt=$clear_date    ;;    "</span>dwt_coupon_topic<span class="token string">" )        hive -e "</span>$dwt_coupon_topic<span class="token string">"        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_coupon_topic/dt=$clear_date    ;;    "</span>dwt_area_topic<span class="token string">" )        hive -e "</span>$dwt_area_topic<span class="token string">"        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_area_topic/dt=$clear_date    ;;    "</span><span class="token keyword">all</span><span class="token string">" )        hive -e "</span>$dwt_visitor_topic$dwt_user_topic$dwt_sku_topic$dwt_activity_topic$dwt_coupon_topic$dwt_area_topic"        hadoop fs <span class="token operator">-</span>rm <span class="token operator">-</span>r <span class="token operator">-</span><span class="token number">f</span> <span class="token operator">/</span>warehouse<span class="token operator">/</span>gmall<span class="token operator">/</span>dwt<span class="token operator">/</span>dwt_visitor_topic<span class="token operator">/</span>dt<span class="token operator">=</span>$clear_date        hadoop fs <span class="token operator">-</span>rm <span class="token operator">-</span>r <span class="token operator">-</span><span class="token number">f</span> <span class="token operator">/</span>warehouse<span class="token operator">/</span>gmall<span class="token operator">/</span>dwt<span class="token operator">/</span>dwt_user_topic<span class="token operator">/</span>dt<span class="token operator">=</span>$clear_date        hadoop fs <span class="token operator">-</span>rm <span class="token operator">-</span>r <span class="token operator">-</span><span class="token number">f</span> <span class="token operator">/</span>warehouse<span class="token operator">/</span>gmall<span class="token operator">/</span>dwt<span class="token operator">/</span>dwt_sku_topic<span class="token operator">/</span>dt<span class="token operator">=</span>$clear_date        hadoop fs <span class="token operator">-</span>rm <span class="token operator">-</span>r <span class="token operator">-</span><span class="token number">f</span> <span class="token operator">/</span>warehouse<span class="token operator">/</span>gmall<span class="token operator">/</span>dwt<span class="token operator">/</span>dwt_activity_topic<span class="token operator">/</span>dt<span class="token operator">=</span>$clear_date        hadoop fs <span class="token operator">-</span>rm <span class="token operator">-</span>r <span class="token operator">-</span><span class="token number">f</span> <span class="token operator">/</span>warehouse<span class="token operator">/</span>gmall<span class="token operator">/</span>dwt<span class="token operator">/</span>dwt_coupon_topic<span class="token operator">/</span>dt<span class="token operator">=</span>$clear_date        hadoop fs <span class="token operator">-</span>rm <span class="token operator">-</span>r <span class="token operator">-</span><span class="token number">f</span> <span class="token operator">/</span>warehouse<span class="token operator">/</span>gmall<span class="token operator">/</span>dwt<span class="token operator">/</span>dwt_area_topic<span class="token operator">/</span>dt<span class="token operator">=</span>$clear_date    <span class="token punctuation">;</span><span class="token punctuation">;</span>esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 离线数仓 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DWT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DWS层构建</title>
      <link href="/2022/09/21/DWS%E5%B1%82%E6%9E%84%E5%BB%BA/"/>
      <url>/2022/09/21/DWS%E5%B1%82%E6%9E%84%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="1-用户主题表"><a href="#1-用户主题表" class="headerlink" title="1. 用户主题表"></a>1. 用户主题表</h2><p><img src="/2022/09/21/DWS%E5%B1%82%E6%9E%84%E5%BB%BA/1663757347300.png" alt="1663757347300"></p><p><img src="/2022/09/21/DWS%E5%B1%82%E6%9E%84%E5%BB%BA/1663757369457.png" alt="1663757369457"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_user_action_daycount<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_user_action_daycount<span class="token punctuation">(</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'登录次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单参与活动次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单减免金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单用券次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单减免金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'订单单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单总金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券领取次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券使用(下单)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券使用(支付)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'好评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'中评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'差评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'默认评价数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_detail_stats<span class="token punctuation">`</span> array<span class="token operator">&lt;</span>struct<span class="token operator">&lt;</span>sku_id:string<span class="token punctuation">,</span>sku_num:<span class="token keyword">bigint</span><span class="token punctuation">,</span>order_count:<span class="token keyword">bigint</span><span class="token punctuation">,</span>activity_reduce_amount:<span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_reduce_amount:<span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>original_amount:<span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>final_amount:<span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">>></span> <span class="token keyword">COMMENT</span> <span class="token string">'下单明细统计'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日用户行为'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dws/dws_user_action_daycount/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/09/21/DWS%E5%B1%82%E6%9E%84%E5%BB%BA/1663752559647.png" alt="1663752559647"></p><p>统计登录次数的时候一定要注意，可能一个用户的多次访问页面记录，都是在一次登录的情况下完成的，因此我们需要借助last_page_id来确定登录次数，因此每一次登录上一个页面肯定是null，因此我们只需要统计为null的数目就好了，这个count里面一定要注意不能吧null写为0，因为count是吧某一条记录作为1次来进行累加，如果你设置为0，那么会把非null的数据也计算进去，导致计算失误。里面的1写任意值都可以，因为是统计元素个数，并不是做sum求和。这里其实也可以使用sum操作来实现，这样就可以写为0 和 1了。</p><p>统计加购次数和收藏次数需要从action_log中去统计，不能从周期性快照事实表中去统计，如果有的用户当天就加购而且下单成功，那么同步的收藏表和加购表就不会存在这种记录，因此我们需要从action_log中去统计用户一天的加购次数以及收藏次数</p><p>统计优惠卷领用次数以及优惠卷使用下单和支付次数也比较特殊，因为我们聚集的dwd_cupon_use是一个累积型快照事实表，其中按照分区表存放的是用户前几天包括今天使用的优惠卷的订单以及过期的优惠卷的订单，而领用的其它的未使用的都存放在了9999分区中。因此我们还需要额外的一些过滤条件来获取这几个字段的值。</p><p><img src="/2022/09/21/DWS%E5%B1%82%E6%9E%84%E5%BB%BA/1663754594607.png" alt="1663754594607"></p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">use</span> gmall<span class="token punctuation">;</span><span class="token keyword">with</span> tmp_login <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>last_page_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">null</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> login_count    <span class="token keyword">from</span> dwd_page_log    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">and</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_cartFavor <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id <span class="token operator">=</span> <span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id <span class="token operator">=</span> <span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count    <span class="token keyword">from</span> dwd_action_log    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">and</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token operator">and</span> action_id <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_order <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> dwd_order_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">and</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_payment <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> dwd_payment_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">and</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_refund_info <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount    <span class="token keyword">from</span> dwd_order_refund_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">and</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_refund_payment <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>rp<span class="token punctuation">.</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount    <span class="token keyword">from</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                user_id<span class="token punctuation">,</span>                order_id<span class="token punctuation">,</span>                sku_id<span class="token punctuation">,</span>                refund_amount            <span class="token keyword">from</span> dwd_refund_payment            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>        <span class="token punctuation">)</span>rp            <span class="token keyword">left</span> <span class="token keyword">join</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                user_id<span class="token punctuation">,</span>                order_id<span class="token punctuation">,</span>                sku_id<span class="token punctuation">,</span>                refund_num            <span class="token keyword">from</span> dwd_order_refund_info            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>        <span class="token punctuation">)</span>ri        <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>order_id            <span class="token operator">and</span> rp<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>rp<span class="token punctuation">.</span>sku_id    <span class="token keyword">group</span> <span class="token keyword">by</span> rp<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_coupon <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_used_count    <span class="token keyword">from</span> dwd_coupon_use    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">or</span> dt <span class="token operator">=</span> <span class="token string">'9999-99-99'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_comment <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count    <span class="token keyword">from</span> dwd_comment_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_order_deatil <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span>            <span class="token string">'sku_id'</span><span class="token punctuation">,</span>sku_id<span class="token punctuation">,</span>            <span class="token string">'sku_num'</span><span class="token punctuation">,</span>sku_num<span class="token punctuation">,</span>            <span class="token string">'order_count'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span>            <span class="token string">'activity_reduce_amount'</span><span class="token punctuation">,</span>activity_reduce_amount<span class="token punctuation">,</span>            <span class="token string">'coupon_reduce_amount'</span><span class="token punctuation">,</span>coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token string">'original_amount'</span><span class="token punctuation">,</span>original_amount<span class="token punctuation">,</span>            <span class="token string">'final_amount'</span><span class="token punctuation">,</span>final_amount            <span class="token punctuation">)</span><span class="token punctuation">)</span> order_detail_stats    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> sku_num<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> activity_reduce_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> original_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> final_amount        <span class="token keyword">from</span> dwd_order_detail        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>sku_id    <span class="token punctuation">)</span> t1    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_user_action_daycount <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    t2<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> login_count<span class="token punctuation">,</span> cart_count<span class="token punctuation">,</span> favor_count<span class="token punctuation">,</span> order_count<span class="token punctuation">,</span> order_activity_count<span class="token punctuation">,</span> order_activity_reduce_amount<span class="token punctuation">,</span> order_coupon_count<span class="token punctuation">,</span> order_coupon_reduce_amount<span class="token punctuation">,</span> order_original_amount<span class="token punctuation">,</span> order_final_amount<span class="token punctuation">,</span> payment_count<span class="token punctuation">,</span> payment_amount<span class="token punctuation">,</span> refund_order_count<span class="token punctuation">,</span> refund_order_num<span class="token punctuation">,</span> refund_order_amount<span class="token punctuation">,</span> refund_payment_count<span class="token punctuation">,</span> refund_payment_num<span class="token punctuation">,</span> refund_payment_amount<span class="token punctuation">,</span> coupon_get_count<span class="token punctuation">,</span> coupon_using_count<span class="token punctuation">,</span> coupon_used_count<span class="token punctuation">,</span> appraise_good_count<span class="token punctuation">,</span> appraise_mid_count<span class="token punctuation">,</span> appraise_bad_count<span class="token punctuation">,</span> appraise_default_count<span class="token punctuation">,</span>    tmp_order_deatil<span class="token punctuation">.</span>order_detail_stats<span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span>    user_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span> favor_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">)</span> coupon_used_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span> appraise_default_count<span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            login_count<span class="token punctuation">,</span>            <span class="token number">0</span> cart_count<span class="token punctuation">,</span>            <span class="token number">0</span> favor_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_default_count        <span class="token keyword">from</span> tmp_login        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            cart_count<span class="token punctuation">,</span>            favor_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_default_count        <span class="token keyword">from</span> tmp_cartFavor        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> cart_count<span class="token punctuation">,</span>            <span class="token number">0</span> favor_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_activity_count<span class="token punctuation">,</span>            order_activity_reduce_amount<span class="token punctuation">,</span>            order_coupon_count<span class="token punctuation">,</span>            order_coupon_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_default_count        <span class="token keyword">from</span> tmp_order        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> cart_count<span class="token punctuation">,</span>            <span class="token number">0</span> favor_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_default_count        <span class="token keyword">from</span> tmp_payment        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> cart_count<span class="token punctuation">,</span>            <span class="token number">0</span> favor_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_num<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_default_count        <span class="token keyword">from</span> tmp_refund_info        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> cart_count<span class="token punctuation">,</span>            <span class="token number">0</span> favor_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_num<span class="token punctuation">,</span>            refund_payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_default_count        <span class="token keyword">from</span> tmp_refund_payment        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> cart_count<span class="token punctuation">,</span>            <span class="token number">0</span> favor_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>            coupon_get_count<span class="token punctuation">,</span>            coupon_using_count<span class="token punctuation">,</span>            coupon_used_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>            <span class="token number">0</span> appraise_default_count        <span class="token keyword">from</span> tmp_coupon        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> cart_count<span class="token punctuation">,</span>            <span class="token number">0</span> favor_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>            <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>            appraise_good_count<span class="token punctuation">,</span>            appraise_mid_count<span class="token punctuation">,</span>            appraise_bad_count<span class="token punctuation">,</span>            appraise_default_count        <span class="token keyword">from</span> tmp_comment    <span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span> t2<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_order_deatil <span class="token keyword">on</span> tmp_order_deatil<span class="token punctuation">.</span>user_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-商品主题表"><a href="#2-商品主题表" class="headerlink" title="2. 商品主题表"></a>2. 商品主题表</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_sku_action_daycount<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_sku_action_daycount<span class="token punctuation">(</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku_id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被下单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用优惠券被下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额(活动)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额(优惠券)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被下单原价金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被支付件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span>  <span class="token keyword">COMMENT</span> <span class="token string">'被退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span>  <span class="token keyword">COMMENT</span> <span class="token string">'被退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被退款件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被加入购物车次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被收藏次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'好评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'中评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'差评数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'默认评价数'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日商品行为'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dws/dws_sku_action_daycount/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入数据语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">with</span> tmp_order_detail <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_activity_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_coupon_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> dwd_order_detail    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_payment <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> payment_num<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount        <span class="token keyword">from</span> dwd_order_detail        <span class="token keyword">join</span> <span class="token punctuation">(</span>            <span class="token keyword">select</span>                order_id<span class="token punctuation">,</span>                callback_time            <span class="token keyword">from</span> dwd_payment_info            <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span> <span class="token operator">and</span> callback_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>        <span class="token punctuation">)</span> pay <span class="token keyword">on</span> pay<span class="token punctuation">.</span>order_id <span class="token operator">=</span> dwd_order_detail<span class="token punctuation">.</span>order_id        <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id    <span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_refund <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount        <span class="token keyword">from</span> dwd_order_refund_info        <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id    <span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_refund_pay <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount        <span class="token keyword">from</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                sku_id<span class="token punctuation">,</span>                refund_amount            <span class="token keyword">from</span> dwd_refund_payment            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>        <span class="token punctuation">)</span>t1        <span class="token keyword">left</span> <span class="token keyword">join</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                sku_id<span class="token punctuation">,</span>                refund_num            <span class="token keyword">from</span> dwd_order_refund_info            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>        <span class="token punctuation">)</span>t2 <span class="token keyword">on</span> t1<span class="token punctuation">.</span>sku_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>sku_id        <span class="token keyword">group</span> <span class="token keyword">by</span> t1<span class="token punctuation">.</span>sku_id    <span class="token punctuation">)</span><span class="token punctuation">,</span>     tmp_action_log <span class="token keyword">as</span>         <span class="token punctuation">(</span>             <span class="token keyword">select</span>                 item sku_id<span class="token punctuation">,</span>                 <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>                 <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count             <span class="token keyword">from</span> dwd_action_log             <span class="token keyword">where</span> action_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>             <span class="token keyword">group</span> <span class="token keyword">by</span> item         <span class="token punctuation">)</span><span class="token punctuation">,</span>     tmp_comment <span class="token keyword">as</span>         <span class="token punctuation">(</span>             <span class="token keyword">select</span>                 sku_id<span class="token punctuation">,</span>                 <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>                 <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>                 <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>                 <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count             <span class="token keyword">from</span> dwd_comment_info             <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id         <span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_sku_action_daycount <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    sku_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span><span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sku_id<span class="token punctuation">,</span>             order_count<span class="token punctuation">,</span>             order_num<span class="token punctuation">,</span>             order_activity_count<span class="token punctuation">,</span>             order_coupon_count<span class="token punctuation">,</span>             order_activity_reduce_amount<span class="token punctuation">,</span>             order_coupon_reduce_amount<span class="token punctuation">,</span>             order_original_amount<span class="token punctuation">,</span>             order_final_amount<span class="token punctuation">,</span>             <span class="token number">0</span> payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> cart_count<span class="token punctuation">,</span>             <span class="token number">0</span> favor_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_default_count      <span class="token keyword">from</span> tmp_order_detail      <span class="token keyword">union</span> <span class="token keyword">all</span>      <span class="token keyword">select</span> sku_id<span class="token punctuation">,</span>             <span class="token number">0</span> order_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_num<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>             payment_count<span class="token punctuation">,</span>             payment_num<span class="token punctuation">,</span>             payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> cart_count<span class="token punctuation">,</span>             <span class="token number">0</span> favor_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_default_count      <span class="token keyword">from</span> tmp_payment      <span class="token keyword">union</span> <span class="token keyword">all</span>      <span class="token keyword">select</span> sku_id<span class="token punctuation">,</span>             <span class="token number">0</span> order_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_num<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>             <span class="token number">0</span> payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>             refund_order_count<span class="token punctuation">,</span>             refund_order_num<span class="token punctuation">,</span>             refund_order_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> cart_count<span class="token punctuation">,</span>             <span class="token number">0</span> favor_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_default_count      <span class="token keyword">from</span> tmp_refund      <span class="token keyword">union</span> <span class="token keyword">all</span>      <span class="token keyword">select</span> sku_id<span class="token punctuation">,</span>             <span class="token number">0</span> order_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_num<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>             <span class="token number">0</span> payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>             refund_payment_count<span class="token punctuation">,</span>             refund_payment_num<span class="token punctuation">,</span>             refund_payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> cart_count<span class="token punctuation">,</span>             <span class="token number">0</span> favor_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_default_count      <span class="token keyword">from</span> tmp_refund_pay      <span class="token keyword">union</span> <span class="token keyword">all</span>      <span class="token keyword">select</span> sku_id<span class="token punctuation">,</span>             <span class="token number">0</span> order_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_num<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>             <span class="token number">0</span> payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>             cart_count<span class="token punctuation">,</span>             favor_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>             <span class="token number">0</span> appraise_default_count      <span class="token keyword">from</span> tmp_action_log      <span class="token keyword">union</span> <span class="token keyword">all</span>      <span class="token keyword">select</span> sku_id<span class="token punctuation">,</span>             <span class="token number">0</span> order_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_num<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>             <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>             <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>             <span class="token number">0</span> payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>             <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>             <span class="token number">0</span> cart_count<span class="token punctuation">,</span>             <span class="token number">0</span> favor_count<span class="token punctuation">,</span>             appraise_good_count<span class="token punctuation">,</span>             appraise_mid_count<span class="token punctuation">,</span>             appraise_bad_count<span class="token punctuation">,</span>             appraise_default_count      <span class="token keyword">from</span> tmp_comment      <span class="token punctuation">)</span> t1<span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-优惠券主题表"><a href="#3-优惠券主题表" class="headerlink" title="3. 优惠券主题表"></a>3. 优惠券主题表</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_coupon_info_daycount<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_coupon_info_daycount<span class="token punctuation">(</span>    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'领取次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用(下单)次数'</span><span class="token punctuation">,</span>     <span class="token punctuation">`</span>order_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券的订单优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券的订单原价金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券的订单总价金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用(支付)次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券的支付优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券支付的总金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'过期次数'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日活动统计'</span>PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>STORED <span class="token keyword">AS</span> ORCLOCATION <span class="token string">'/warehouse/gmall/dws/dws_coupon_info_daycount/'</span>TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入数据语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">with</span>    tmp_cu <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                coupon_id<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_count            <span class="token keyword">from</span> dwd_coupon_use            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>               <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>            <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id        <span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_order <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                coupon_id<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount            <span class="token keyword">from</span> dwd_order_detail            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>              <span class="token operator">and</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>            <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id        <span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_pay <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                coupon_id<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount            <span class="token keyword">from</span> dwd_order_detail            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>              <span class="token operator">and</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>              <span class="token operator">and</span> order_id <span class="token operator">in</span>                  <span class="token punctuation">(</span>                      <span class="token keyword">select</span> order_id <span class="token keyword">from</span> dwd_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>                  <span class="token punctuation">)</span>            <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id        <span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_coupon_info_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    coupon_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>get_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>expire_count<span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            coupon_id<span class="token punctuation">,</span>            get_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            expire_count        <span class="token keyword">from</span> tmp_cu        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            coupon_id<span class="token punctuation">,</span>            <span class="token number">0</span> get_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            order_reduce_amount<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> expire_count        <span class="token keyword">from</span> tmp_order        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            coupon_id<span class="token punctuation">,</span>            <span class="token number">0</span> get_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            payment_reduce_amount<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> expire_count        <span class="token keyword">from</span> tmp_pay    <span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-活动主题表"><a href="#4-活动主题表" class="headerlink" title="4. 活动主题表"></a>4. 活动主题表</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_activity_info_daycount<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_activity_info_daycount<span class="token punctuation">(</span>    <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则下单次数'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--注意：针对的是某个活动的某个具体规则</span>    <span class="token punctuation">`</span>order_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则下单减免金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则下单原始金额'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--只统计参与活动的订单明细,未参与活动的订单明细不统计。</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则支付减免金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则支付金额'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日活动统计'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dws/dws_activity_info_daycount/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">with</span> tmp_order_detail <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_id<span class="token punctuation">,</span>        activity_rule_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> dwd_order_detail    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span> <span class="token operator">and</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_order_payment <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            activity_rule_id<span class="token punctuation">,</span>            activity_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount        <span class="token keyword">from</span> dwd_order_detail        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>          <span class="token operator">and</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>          <span class="token operator">and</span> order_id <span class="token operator">in</span>              <span class="token punctuation">(</span>                  <span class="token keyword">select</span> order_id <span class="token keyword">from</span> dwd_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>              <span class="token punctuation">)</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id    <span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_activity_info_daycount <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    activity_rule_id<span class="token punctuation">,</span>    activity_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount    <span class="token keyword">from</span> tmp_order_detail    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount    <span class="token keyword">from</span> tmp_order_payment<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span> activity_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-地区主题表"><a href="#5-地区主题表" class="headerlink" title="5. 地区主题表"></a>5. 地区主题表</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_area_stats_daycount<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_area_stats_daycount<span class="token punctuation">(</span>    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'访客访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visitor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'访客人数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户人数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单原始金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款金额'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日地区统计表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dws/dws_area_stats_daycount/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">with</span>    tmp_vu <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                id province_id<span class="token punctuation">,</span>                visit_count<span class="token punctuation">,</span>                login_count<span class="token punctuation">,</span>                visitor_count<span class="token punctuation">,</span>                user_count            <span class="token keyword">from</span>                <span class="token punctuation">(</span>                    <span class="token keyword">select</span>                        area_code<span class="token punctuation">,</span>                        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> visit_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客访问次数</span>                        <span class="token function">count</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--用户访问次数,等价于sum(if(user_id is not null,1,0))</span>                        <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">)</span> visitor_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客人数</span>                        <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> user_count<span class="token comment" spellcheck="true">--用户人数</span>                    <span class="token keyword">from</span> dwd_page_log                    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>                      <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>                    <span class="token keyword">group</span> <span class="token keyword">by</span> area_code                <span class="token punctuation">)</span>tmp                    <span class="token keyword">left</span> <span class="token keyword">join</span> dim_base_province area                              <span class="token keyword">on</span> tmp<span class="token punctuation">.</span>area_code<span class="token operator">=</span>area<span class="token punctuation">.</span>area_code        <span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_order <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                province_id<span class="token punctuation">,</span>                <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount            <span class="token keyword">from</span> dwd_order_info            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>               <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>                <span class="token operator">and</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2022-09-01'</span>            <span class="token keyword">group</span> <span class="token keyword">by</span> province_id        <span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_pay <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                province_id<span class="token punctuation">,</span>                <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount            <span class="token keyword">from</span> dwd_payment_info            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>            <span class="token keyword">group</span> <span class="token keyword">by</span> province_id        <span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_ro <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                province_id<span class="token punctuation">,</span>                <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount            <span class="token keyword">from</span> dwd_order_refund_info            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>            <span class="token keyword">group</span> <span class="token keyword">by</span> province_id        <span class="token punctuation">)</span><span class="token punctuation">,</span>    tmp_rp <span class="token keyword">as</span>        <span class="token punctuation">(</span>            <span class="token keyword">select</span>                province_id<span class="token punctuation">,</span>                <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>                <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount            <span class="token keyword">from</span> dwd_refund_payment            <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>            <span class="token keyword">group</span> <span class="token keyword">by</span> province_id        <span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_area_stats_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    province_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>visit_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>visitor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>user_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            province_id<span class="token punctuation">,</span>            visit_count<span class="token punctuation">,</span>            login_count<span class="token punctuation">,</span>            visitor_count<span class="token punctuation">,</span>            user_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount        <span class="token keyword">from</span> tmp_vu        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            province_id<span class="token punctuation">,</span>            <span class="token number">0</span> visit_count<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>            <span class="token number">0</span> user_count<span class="token punctuation">,</span>            order_count<span class="token punctuation">,</span>            order_original_amount<span class="token punctuation">,</span>            order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount        <span class="token keyword">from</span> tmp_order        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            province_id<span class="token punctuation">,</span>            <span class="token number">0</span> visit_count<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>            <span class="token number">0</span> user_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            payment_count<span class="token punctuation">,</span>            payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount        <span class="token keyword">from</span> tmp_pay        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            province_id<span class="token punctuation">,</span>            <span class="token number">0</span> visit_count<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>            <span class="token number">0</span> user_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            refund_order_count<span class="token punctuation">,</span>            refund_order_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_payment_amount        <span class="token keyword">from</span> tmp_ro        <span class="token keyword">union</span> <span class="token keyword">all</span>        <span class="token keyword">select</span>            province_id<span class="token punctuation">,</span>            <span class="token number">0</span> visit_count<span class="token punctuation">,</span>            <span class="token number">0</span> login_count<span class="token punctuation">,</span>            <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>            <span class="token number">0</span> user_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_count<span class="token punctuation">,</span>            <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>            <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>            <span class="token number">0</span> payment_count<span class="token punctuation">,</span>            <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>            <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>            refund_payment_count<span class="token punctuation">,</span>            refund_payment_amount        <span class="token keyword">from</span> tmp_rp    <span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> province_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-访客主题表"><a href="#6-访客主题表" class="headerlink" title="6. 访客主题表"></a>6. 访客主题表</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_visitor_action_daycount<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_visitor_action_daycount<span class="token punctuation">(</span>    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备品牌'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备型号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次访问'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'应用版本'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>visit_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'访问次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>page_stats<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>page_id:STRING<span class="token punctuation">,</span>page_count:<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>during_time:<span class="token keyword">BIGINT</span><span class="token operator">>></span> <span class="token keyword">COMMENT</span> <span class="token string">'页面访问统计'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日设备行为表'</span>    PARTITIONED <span class="token keyword">BY</span><span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dws/dws_visitor_action_daycount'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_visitor_action_daycount <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    t1<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>model<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>is_new<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>channel<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>os<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>version_code<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span>    t3<span class="token punctuation">.</span>page_stats<span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            mid_id<span class="token punctuation">,</span>            brand<span class="token punctuation">,</span>            model<span class="token punctuation">,</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>array_contains<span class="token punctuation">(</span>collect_set<span class="token punctuation">(</span>is_new<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span> is_new<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--ods_page_log中，同一天内，同一设备的is_new字段，可能全部为1，可能全部为0，也可能部分为0，部分为1(卸载重装),故做该处理</span>            collect_set<span class="token punctuation">(</span>channel<span class="token punctuation">)</span> channel<span class="token punctuation">,</span>            collect_set<span class="token punctuation">(</span>os<span class="token punctuation">)</span> os<span class="token punctuation">,</span>            collect_set<span class="token punctuation">(</span>area_code<span class="token punctuation">)</span> area_code<span class="token punctuation">,</span>            collect_set<span class="token punctuation">(</span>version_code<span class="token punctuation">)</span> version_code<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>last_page_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_count        <span class="token keyword">from</span> dwd_page_log        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>          <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand    <span class="token punctuation">)</span>t1        <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            mid_id<span class="token punctuation">,</span>            brand<span class="token punctuation">,</span>            model<span class="token punctuation">,</span>            collect_set<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">'page_id'</span><span class="token punctuation">,</span>page_id<span class="token punctuation">,</span><span class="token string">'page_count'</span><span class="token punctuation">,</span>page_count<span class="token punctuation">,</span><span class="token string">'during_time'</span><span class="token punctuation">,</span>during_time<span class="token punctuation">)</span><span class="token punctuation">)</span> page_stats        <span class="token keyword">from</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span>                    mid_id<span class="token punctuation">,</span>                    brand<span class="token punctuation">,</span>                    model<span class="token punctuation">,</span>                    page_id<span class="token punctuation">,</span>                    <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> page_count<span class="token punctuation">,</span>                    <span class="token function">sum</span><span class="token punctuation">(</span>during_time<span class="token punctuation">)</span> during_time                <span class="token keyword">from</span> dwd_page_log                <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>                <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand<span class="token punctuation">,</span>page_id            <span class="token punctuation">)</span>t2        <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand    <span class="token punctuation">)</span>t3    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>t3<span class="token punctuation">.</span>mid_id        <span class="token operator">and</span> t1<span class="token punctuation">.</span>brand<span class="token operator">=</span>t3<span class="token punctuation">.</span>brand        <span class="token operator">and</span> t1<span class="token punctuation">.</span>model<span class="token operator">=</span>t3<span class="token punctuation">.</span>model<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-DWS首日数据装载"><a href="#7-DWS首日数据装载" class="headerlink" title="7. DWS首日数据装载"></a>7. DWS首日数据装载</h2><p>此脚本没有实验，不保证运行正确性</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#!/bin/bash</span>APP<span class="token operator">=</span>gmalldws_visitor_action_daycount<span class="token operator">=</span>"<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_visitor_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    t1<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>model<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>is_new<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>channel<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>os<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>version_code<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span>    t3<span class="token punctuation">.</span>page_stats<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>dt<span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>array_contains<span class="token punctuation">(</span>collect_set<span class="token punctuation">(</span>is_new<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span> is_new<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--ods_page_log中，同一天内，同一设备的is_new字段，可能全部为1，可能全部为0，也可能部分为0，部分为1(卸载重装),故做该处理</span>        collect_set<span class="token punctuation">(</span>channel<span class="token punctuation">)</span> channel<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>os<span class="token punctuation">)</span> os<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>area_code<span class="token punctuation">)</span> area_code<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>version_code<span class="token punctuation">)</span> version_code<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>last_page_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_page_log    <span class="token keyword">where</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand<span class="token punctuation">)</span>t1<span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">'page_id'</span><span class="token punctuation">,</span>page_id<span class="token punctuation">,</span><span class="token string">'page_count'</span><span class="token punctuation">,</span>page_count<span class="token punctuation">,</span><span class="token string">'during_time'</span><span class="token punctuation">,</span>during_time<span class="token punctuation">)</span><span class="token punctuation">)</span> page_stats    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            dt<span class="token punctuation">,</span>            mid_id<span class="token punctuation">,</span>            brand<span class="token punctuation">,</span>            model<span class="token punctuation">,</span>            page_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> page_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>during_time<span class="token punctuation">)</span> during_time        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_page_log        <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand<span class="token punctuation">,</span>page_id    <span class="token punctuation">)</span>t2    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand<span class="token punctuation">)</span>t3<span class="token keyword">on</span> t1<span class="token punctuation">.</span>dt<span class="token operator">=</span>t3<span class="token punctuation">.</span>dt<span class="token operator">and</span> t1<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>t3<span class="token punctuation">.</span>mid_id<span class="token operator">and</span> t1<span class="token punctuation">.</span>brand<span class="token operator">=</span>t3<span class="token punctuation">.</span>brand<span class="token operator">and</span> t1<span class="token punctuation">.</span>model<span class="token operator">=</span>t3<span class="token punctuation">.</span>model<span class="token punctuation">;</span><span class="token string">"dws_area_stats_daycount="</span><span class="token keyword">with</span>tmp_vu <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        id province_id<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        visitor_count<span class="token punctuation">,</span>        user_count    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            dt<span class="token punctuation">,</span>            area_code<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> visit_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客访问次数</span>            <span class="token function">count</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--用户访问次数,等价于sum(if(user_id is not null,1,0))</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">)</span> visitor_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客人数</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> user_count<span class="token comment" spellcheck="true">--用户人数</span>        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_page_log        <span class="token keyword">where</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>area_code    <span class="token punctuation">)</span>tmp    <span class="token keyword">left</span> <span class="token keyword">join</span> ${APP}<span class="token punctuation">.</span>dim_base_province area    <span class="token keyword">on</span> tmp<span class="token punctuation">.</span>area_code<span class="token operator">=</span>area<span class="token punctuation">.</span>area_code<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        province_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_info    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        province_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_ro <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        province_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_rp <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        province_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_refund_payment    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>province_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_area_stats_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    province_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>visit_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>visitor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>user_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    dt<span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        province_id<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        visitor_count<span class="token punctuation">,</span>        user_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount    <span class="token keyword">from</span> tmp_vu    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        province_id<span class="token punctuation">,</span>        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>        <span class="token number">0</span> user_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        province_id<span class="token punctuation">,</span>        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>        <span class="token number">0</span> user_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount    <span class="token keyword">from</span> tmp_pay    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        province_id<span class="token punctuation">,</span>        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>        <span class="token number">0</span> user_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount    <span class="token keyword">from</span> tmp_ro    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        province_id<span class="token punctuation">,</span>        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>        <span class="token number">0</span> user_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_amount    <span class="token keyword">from</span> tmp_rp<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>province_id<span class="token punctuation">;</span><span class="token string">"dws_user_action_daycount="</span><span class="token keyword">with</span>tmp_login <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> login_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_page_log    <span class="token keyword">where</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_cf <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_action_log    <span class="token keyword">where</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token operator">and</span> action_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_info    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_ri <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_rp <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>rp<span class="token punctuation">.</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            refund_amount<span class="token punctuation">,</span>            callback_time        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_refund_payment    <span class="token punctuation">)</span>rp    <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            refund_num        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info    <span class="token punctuation">)</span>ri    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>order_id    <span class="token operator">and</span> rp<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>rp<span class="token punctuation">.</span>sku_id    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rp<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_coupon <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>dt<span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> user_id<span class="token punctuation">,</span>        nvl<span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>        nvl<span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>        nvl<span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> coupon_used_count    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>            user_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> coupon_get_count        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_coupon_use        <span class="token keyword">where</span> get_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>coupon_get    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>            user_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> coupon_using_count        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_coupon_use        <span class="token keyword">where</span> using_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>coupon_using    <span class="token keyword">on</span> coupon_get<span class="token punctuation">.</span>dt<span class="token operator">=</span>coupon_using<span class="token punctuation">.</span>dt    <span class="token operator">and</span> coupon_get<span class="token punctuation">.</span>user_id<span class="token operator">=</span>coupon_using<span class="token punctuation">.</span>user_id    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>            user_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> coupon_used_count        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_coupon_use        <span class="token keyword">where</span> used_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>coupon_used    <span class="token keyword">on</span> nvl<span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>coupon_used<span class="token punctuation">.</span>dt    <span class="token operator">and</span> nvl<span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>coupon_used<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_comment <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_comment_info    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_od <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">'sku_id'</span><span class="token punctuation">,</span>sku_id<span class="token punctuation">,</span><span class="token string">'sku_num'</span><span class="token punctuation">,</span>sku_num<span class="token punctuation">,</span><span class="token string">'order_count'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token string">'activity_reduce_amount'</span><span class="token punctuation">,</span>activity_reduce_amount<span class="token punctuation">,</span><span class="token string">'coupon_reduce_amount'</span><span class="token punctuation">,</span>coupon_reduce_amount<span class="token punctuation">,</span><span class="token string">'original_amount'</span><span class="token punctuation">,</span>original_amount<span class="token punctuation">,</span><span class="token string">'final_amount'</span><span class="token punctuation">,</span>final_amount<span class="token punctuation">)</span><span class="token punctuation">)</span> order_detail_stats    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>            user_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> sku_num<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> activity_reduce_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> original_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> final_amount        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>sku_id    <span class="token punctuation">)</span>t1    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>user_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_user_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    user_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">max</span><span class="token punctuation">(</span>order_detail_stats<span class="token punctuation">)</span><span class="token punctuation">,</span>    dt<span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count<span class="token punctuation">,</span>        <span class="token boolean">null</span> order_detail_stats    <span class="token keyword">from</span> tmp_login    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count<span class="token punctuation">,</span>        <span class="token boolean">null</span> order_detail_stats    <span class="token keyword">from</span> tmp_cf    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count<span class="token punctuation">,</span>        <span class="token boolean">null</span> order_detail_stats    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count<span class="token punctuation">,</span>        <span class="token boolean">null</span> order_detail_stats    <span class="token keyword">from</span> tmp_pay    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count<span class="token punctuation">,</span>        <span class="token boolean">null</span> order_detail_stats    <span class="token keyword">from</span> tmp_ri    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count<span class="token punctuation">,</span>        <span class="token boolean">null</span> order_detail_stats    <span class="token keyword">from</span> tmp_rp    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        coupon_get_count<span class="token punctuation">,</span>        coupon_using_count<span class="token punctuation">,</span>        coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count<span class="token punctuation">,</span>        <span class="token boolean">null</span> order_detail_stats    <span class="token keyword">from</span> tmp_coupon    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count<span class="token punctuation">,</span>        <span class="token boolean">null</span> order_detail_stats    <span class="token keyword">from</span> tmp_comment    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count<span class="token punctuation">,</span>        order_detail_stats    <span class="token keyword">from</span> tmp_od<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>user_id<span class="token punctuation">;</span><span class="token string">"dws_activity_info_daycount="</span><span class="token keyword">with</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail    <span class="token keyword">where</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            activity_rule_id<span class="token punctuation">,</span>            activity_id<span class="token punctuation">,</span>            order_id<span class="token punctuation">,</span>            split_activity_amount<span class="token punctuation">,</span>            split_final_amount        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail        <span class="token keyword">where</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token punctuation">)</span>od    <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_id<span class="token punctuation">,</span>            callback_time        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info    <span class="token punctuation">)</span>pi    <span class="token keyword">on</span> od<span class="token punctuation">.</span>order_id<span class="token operator">=</span>pi<span class="token punctuation">.</span>order_id    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_activity_info_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    activity_rule_id<span class="token punctuation">,</span>    activity_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    dt<span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount    <span class="token keyword">from</span> tmp_pay<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">;</span><span class="token string">"dws_sku_action_daycount="</span><span class="token keyword">with</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_activity_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_coupon_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail od    <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_id<span class="token punctuation">,</span>            callback_time        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info        <span class="token keyword">where</span> callback_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token punctuation">)</span>pi <span class="token keyword">on</span> pi<span class="token punctuation">.</span>order_id<span class="token operator">=</span>od<span class="token punctuation">.</span>order_id    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_ri <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_rp <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        rp<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            refund_amount<span class="token punctuation">,</span>            callback_time        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_refund_payment    <span class="token punctuation">)</span>rp    <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            refund_num        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info    <span class="token punctuation">)</span>ri    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>order_id    <span class="token operator">and</span> rp<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>sku_id    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rp<span class="token punctuation">.</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_cf <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        item sku_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_action_log    <span class="token keyword">where</span> action_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_comment <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_comment_info    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sku_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_sku_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    sku_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    dt<span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_num<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_num<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_pay    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_ri    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_rp    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_cf    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> tmp_comment<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>sku_id<span class="token punctuation">;</span><span class="token string">"dws_coupon_info_daycount="</span><span class="token keyword">with</span>tmp_cu <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_exprie<span class="token punctuation">.</span>dt<span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_exprie<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span> coupon_id<span class="token punctuation">,</span>        nvl<span class="token punctuation">(</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> get_count<span class="token punctuation">,</span>        nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        nvl<span class="token punctuation">(</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> expire_count    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>            coupon_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> get_count        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_coupon_use        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id    <span class="token punctuation">)</span>coupon_get    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>            coupon_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_coupon_use        <span class="token keyword">where</span> using_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id    <span class="token punctuation">)</span>coupon_using    <span class="token keyword">on</span> coupon_get<span class="token punctuation">.</span>dt<span class="token operator">=</span>coupon_using<span class="token punctuation">.</span>dt    <span class="token operator">and</span> coupon_get<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>coupon_using<span class="token punctuation">.</span>coupon_id    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>            coupon_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_coupon_use        <span class="token keyword">where</span> used_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id    <span class="token punctuation">)</span>coupon_used    <span class="token keyword">on</span> nvl<span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>coupon_used<span class="token punctuation">.</span>dt    <span class="token operator">and</span> nvl<span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token operator">=</span>coupon_used<span class="token punctuation">.</span>coupon_id    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            date_format<span class="token punctuation">(</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>            coupon_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> expire_count        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_coupon_use        <span class="token keyword">where</span> expire_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id    <span class="token punctuation">)</span>coupon_exprie    <span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>coupon_exprie<span class="token punctuation">.</span>dt    <span class="token operator">and</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token operator">=</span>coupon_exprie<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        coupon_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail    <span class="token keyword">where</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>        coupon_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_id<span class="token punctuation">,</span>            coupon_id<span class="token punctuation">,</span>            split_coupon_amount<span class="token punctuation">,</span>            split_final_amount        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail        <span class="token keyword">where</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token punctuation">)</span>od    <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_id<span class="token punctuation">,</span>            callback_time        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info    <span class="token punctuation">)</span>pi    <span class="token keyword">on</span> od<span class="token punctuation">.</span>order_id<span class="token operator">=</span>pi<span class="token punctuation">.</span>order_id    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_coupon_info_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    coupon_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>get_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>expire_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    dt<span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        coupon_id<span class="token punctuation">,</span>        get_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        expire_count    <span class="token keyword">from</span> tmp_cu    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        coupon_id<span class="token punctuation">,</span>        <span class="token number">0</span> get_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> expire_count    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        dt<span class="token punctuation">,</span>        coupon_id<span class="token punctuation">,</span>        <span class="token number">0</span> get_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> expire_count    <span class="token keyword">from</span> tmp_pay<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>coupon_id<span class="token punctuation">;</span><span class="token string">"case $1 in    "</span>dws_visitor_action_daycount<span class="token string">" )        hive -e "</span>$dws_visitor_action_daycount<span class="token string">"    ;;    "</span>dws_user_action_daycount<span class="token string">" )        hive -e "</span>$dws_user_action_daycount<span class="token string">"    ;;    "</span>dws_activity_info_daycount<span class="token string">" )        hive -e "</span>$dws_activity_info_daycount<span class="token string">"    ;;    "</span>dws_area_stats_daycount<span class="token string">" )        hive -e "</span>$dws_area_stats_daycount<span class="token string">"    ;;    "</span>dws_sku_action_daycount<span class="token string">" )        hive -e "</span>$dws_sku_action_daycount<span class="token string">"    ;;    "</span>dws_coupon_info_daycount<span class="token string">" )        hive -e "</span>$dws_coupon_info_daycount<span class="token string">"    ;;    "</span><span class="token keyword">all</span><span class="token string">" )        hive -e "</span>$dws_visitor_action_daycount$dws_user_action_daycount$dws_activity_info_daycount$dws_area_stats_daycount$dws_sku_action_daycount$dws_coupon_info_daycount"    <span class="token punctuation">;</span><span class="token punctuation">;</span>esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-DWS每日数据装载"><a href="#8-DWS每日数据装载" class="headerlink" title="8. DWS每日数据装载"></a>8. DWS每日数据装载</h2><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#!/bin/bash</span>APP<span class="token operator">=</span>gmall<span class="token comment" spellcheck="true"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$2"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>    do_date<span class="token operator">=</span>$<span class="token number">2</span><span class="token keyword">else</span>     <span class="token keyword">exit</span>    do_date<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span><span class="token number">d</span> <span class="token string">"-1 day"</span> <span class="token operator">+</span><span class="token operator">%</span>F<span class="token punctuation">`</span>fidws_visitor_action_daycount<span class="token operator">=</span>"<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_visitor_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    t1<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>model<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>is_new<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>channel<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>os<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>version_code<span class="token punctuation">,</span>    t1<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span>    t3<span class="token punctuation">.</span>page_stats<span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>array_contains<span class="token punctuation">(</span>collect_set<span class="token punctuation">(</span>is_new<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span> is_new<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--ods_page_log中，同一天内，同一设备的is_new字段，可能全部为1，可能全部为0，也可能部分为0，部分为1(卸载重装),故做该处理</span>        collect_set<span class="token punctuation">(</span>channel<span class="token punctuation">)</span> channel<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>os<span class="token punctuation">)</span> os<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>area_code<span class="token punctuation">)</span> area_code<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>version_code<span class="token punctuation">)</span> version_code<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>last_page_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_page_log    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand<span class="token punctuation">)</span>t1<span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        mid_id<span class="token punctuation">,</span>        brand<span class="token punctuation">,</span>        model<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">'page_id'</span><span class="token punctuation">,</span>page_id<span class="token punctuation">,</span><span class="token string">'page_count'</span><span class="token punctuation">,</span>page_count<span class="token punctuation">,</span><span class="token string">'during_time'</span><span class="token punctuation">,</span>during_time<span class="token punctuation">)</span><span class="token punctuation">)</span> page_stats    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            mid_id<span class="token punctuation">,</span>            brand<span class="token punctuation">,</span>            model<span class="token punctuation">,</span>            page_id<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> page_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>during_time<span class="token punctuation">)</span> during_time        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_page_log        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand<span class="token punctuation">,</span>page_id    <span class="token punctuation">)</span>t2    <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand<span class="token punctuation">)</span>t3<span class="token keyword">on</span> t1<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>t3<span class="token punctuation">.</span>mid_id<span class="token operator">and</span> t1<span class="token punctuation">.</span>brand<span class="token operator">=</span>t3<span class="token punctuation">.</span>brand<span class="token operator">and</span> t1<span class="token punctuation">.</span>model<span class="token operator">=</span>t3<span class="token punctuation">.</span>model<span class="token punctuation">;</span><span class="token string">"dws_user_action_daycount="</span><span class="token keyword">with</span>tmp_login <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> login_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_page_log    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">and</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_cf <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_action_log    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">and</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token operator">and</span> action_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_info    <span class="token keyword">where</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>    <span class="token operator">and</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_ri <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_rp <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>rp<span class="token punctuation">.</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            refund_amount        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_refund_payment        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token punctuation">)</span>rp    <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            refund_num        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token punctuation">)</span>ri    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>order_id    <span class="token operator">and</span> rp<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>rp<span class="token punctuation">.</span>sku_id    <span class="token keyword">group</span> <span class="token keyword">by</span> rp<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_coupon <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_used_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_coupon_use    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_comment <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_comment_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_od <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        collect_set<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">'sku_id'</span><span class="token punctuation">,</span>sku_id<span class="token punctuation">,</span><span class="token string">'sku_num'</span><span class="token punctuation">,</span>sku_num<span class="token punctuation">,</span><span class="token string">'order_count'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token string">'activity_reduce_amount'</span><span class="token punctuation">,</span>activity_reduce_amount<span class="token punctuation">,</span><span class="token string">'coupon_reduce_amount'</span><span class="token punctuation">,</span>coupon_reduce_amount<span class="token punctuation">,</span><span class="token string">'original_amount'</span><span class="token punctuation">,</span>original_amount<span class="token punctuation">,</span><span class="token string">'final_amount'</span><span class="token punctuation">,</span>final_amount<span class="token punctuation">)</span><span class="token punctuation">)</span> order_detail_stats    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            user_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> sku_num<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> activity_reduce_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> coupon_reduce_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> original_amount<span class="token punctuation">,</span>            <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> final_amount        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>sku_id    <span class="token punctuation">)</span>t1    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_user_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    t2<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>     login_count<span class="token punctuation">,</span>     cart_count<span class="token punctuation">,</span>     favor_count<span class="token punctuation">,</span>     order_count<span class="token punctuation">,</span>     order_activity_count<span class="token punctuation">,</span>     order_activity_reduce_amount<span class="token punctuation">,</span>     order_coupon_count<span class="token punctuation">,</span>     order_coupon_reduce_amount<span class="token punctuation">,</span>     order_original_amount<span class="token punctuation">,</span>     order_final_amount<span class="token punctuation">,</span>     payment_count<span class="token punctuation">,</span> payment_amount<span class="token punctuation">,</span>     refund_order_count<span class="token punctuation">,</span>     refund_order_num<span class="token punctuation">,</span>     refund_order_amount<span class="token punctuation">,</span>     refund_payment_count<span class="token punctuation">,</span>     refund_payment_num<span class="token punctuation">,</span>     refund_payment_amount<span class="token punctuation">,</span>     coupon_get_count<span class="token punctuation">,</span>     coupon_using_count<span class="token punctuation">,</span>     coupon_used_count<span class="token punctuation">,</span>     appraise_good_count<span class="token punctuation">,</span>     appraise_mid_count<span class="token punctuation">,</span>     appraise_bad_count<span class="token punctuation">,</span>     appraise_default_count<span class="token punctuation">,</span>    tmp_od<span class="token punctuation">.</span>order_detail_stats<span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span>    user_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span> favor_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">)</span> coupon_used_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span> appraise_default_count<span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_login    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_cf    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_pay    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_ri    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_rp    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        coupon_get_count<span class="token punctuation">,</span>        coupon_using_count<span class="token punctuation">,</span>        coupon_used_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_coupon    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        user_id<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_get_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_using_count<span class="token punctuation">,</span>        <span class="token number">0</span> coupon_used_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> tmp_comment<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span>t2<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_od <span class="token keyword">on</span> tmp_od<span class="token punctuation">.</span>user_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span><span class="token string">"dws_activity_info_daycount="</span><span class="token keyword">with</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">and</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">and</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token operator">and</span> order_id <span class="token operator">in</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span> order_id <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token punctuation">)</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_activity_info_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    activity_rule_id<span class="token punctuation">,</span>    activity_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        activity_rule_id<span class="token punctuation">,</span>        activity_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount    <span class="token keyword">from</span> tmp_pay<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">;</span><span class="token string">"dws_sku_action_daycount="</span><span class="token keyword">with</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_activity_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_coupon_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">and</span> order_id <span class="token operator">in</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span> order_id <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token punctuation">)</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_ri <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_rp <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        rp<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            refund_amount        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_refund_payment        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token punctuation">)</span>rp    <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            refund_num        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token punctuation">)</span>ri    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>order_id    <span class="token operator">and</span> rp<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>sku_id    <span class="token keyword">group</span> <span class="token keyword">by</span> rp<span class="token punctuation">.</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_cf <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        item sku_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_action_log    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">and</span> action_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> item<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_comment <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_comment_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_sku_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    sku_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_num<span class="token punctuation">,</span>        order_activity_count<span class="token punctuation">,</span>        order_coupon_count<span class="token punctuation">,</span>        order_activity_reduce_amount<span class="token punctuation">,</span>        order_coupon_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_num<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_pay    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_num<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_ri    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_num<span class="token punctuation">,</span>        refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_rp    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        cart_count<span class="token punctuation">,</span>        favor_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>        <span class="token number">0</span> appraise_default_count    <span class="token keyword">from</span> tmp_cf    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        sku_id<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_num<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>        appraise_good_count<span class="token punctuation">,</span>        appraise_mid_count<span class="token punctuation">,</span>        appraise_bad_count<span class="token punctuation">,</span>        appraise_default_count    <span class="token keyword">from</span> tmp_comment<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span class="token punctuation">;</span><span class="token string">"dws_coupon_info_daycount="</span><span class="token keyword">with</span>tmp_cu <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_count    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_coupon_use    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>    <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">and</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_detail    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">and</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    <span class="token operator">and</span> order_id <span class="token operator">in</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span> order_id <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token punctuation">)</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_coupon_info_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    coupon_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>get_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>expire_count<span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        get_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        expire_count    <span class="token keyword">from</span> tmp_cu    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        <span class="token number">0</span> get_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        order_reduce_amount<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> expire_count    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        coupon_id<span class="token punctuation">,</span>        <span class="token number">0</span> get_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        payment_reduce_amount<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> expire_count    <span class="token keyword">from</span> tmp_pay<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id<span class="token punctuation">;</span><span class="token string">"dws_area_stats_daycount="</span><span class="token keyword">with</span>tmp_vu <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id province_id<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        visitor_count<span class="token punctuation">,</span>        user_count    <span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            area_code<span class="token punctuation">,</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> visit_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客访问次数</span>            <span class="token function">count</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--用户访问次数,等价于sum(if(user_id is not null,1,0))</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">)</span> visitor_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客人数</span>            <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> user_count<span class="token comment" spellcheck="true">--用户人数</span>        <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_page_log        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>        <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> area_code    <span class="token punctuation">)</span>tmp    <span class="token keyword">left</span> <span class="token keyword">join</span> ${APP}<span class="token punctuation">.</span>dim_base_province area    <span class="token keyword">on</span> tmp<span class="token punctuation">.</span>area_code<span class="token operator">=</span>area<span class="token punctuation">.</span>area_code<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_order <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>    <span class="token operator">and</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_pay <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_payment_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_ro <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_order_refund_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>tmp_rp <span class="token keyword">as</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount    <span class="token keyword">from</span> ${APP}<span class="token punctuation">.</span>dwd_refund_payment    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'$do_date'</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id<span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ${APP}<span class="token punctuation">.</span>dws_area_stats_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'$do_date'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    province_id<span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>visit_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>visitor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>user_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        visit_count<span class="token punctuation">,</span>        login_count<span class="token punctuation">,</span>        visitor_count<span class="token punctuation">,</span>        user_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount    <span class="token keyword">from</span> tmp_vu    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>        <span class="token number">0</span> user_count<span class="token punctuation">,</span>        order_count<span class="token punctuation">,</span>        order_original_amount<span class="token punctuation">,</span>        order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount    <span class="token keyword">from</span> tmp_order    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>        <span class="token number">0</span> user_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        payment_count<span class="token punctuation">,</span>        payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount    <span class="token keyword">from</span> tmp_pay    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>        <span class="token number">0</span> user_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        refund_order_count<span class="token punctuation">,</span>        refund_order_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_payment_amount    <span class="token keyword">from</span> tmp_ro    <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token keyword">select</span>        province_id<span class="token punctuation">,</span>        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>        <span class="token number">0</span> login_count<span class="token punctuation">,</span>        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>        <span class="token number">0</span> user_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_count<span class="token punctuation">,</span>        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>        refund_payment_count<span class="token punctuation">,</span>        refund_payment_amount    <span class="token keyword">from</span> tmp_rp<span class="token punctuation">)</span>t1<span class="token keyword">group</span> <span class="token keyword">by</span> province_id<span class="token punctuation">;</span><span class="token string">"case $1 in    "</span>dws_visitor_action_daycount<span class="token string">" )        hive -e "</span>$dws_visitor_action_daycount<span class="token string">"    ;;    "</span>dws_user_action_daycount<span class="token string">" )        hive -e "</span>$dws_user_action_daycount<span class="token string">"    ;;    "</span>dws_activity_info_daycount<span class="token string">" )        hive -e "</span>$dws_activity_info_daycount<span class="token string">"    ;;    "</span>dws_area_stats_daycount<span class="token string">" )        hive -e "</span>$dws_area_stats_daycount<span class="token string">"    ;;    "</span>dws_sku_action_daycount<span class="token string">" )        hive -e "</span>$dws_sku_action_daycount<span class="token string">"    ;;    "</span>dws_coupon_info_daycount<span class="token string">" )        hive -e "</span>$dws_coupon_info_daycount<span class="token string">"    ;;    "</span><span class="token keyword">all</span><span class="token string">" )        hive -e "</span>$dws_visitor_action_daycount$dws_user_action_daycount$dws_activity_info_daycount$dws_area_stats_daycount$dws_sku_action_daycount$dws_coupon_info_daycount"    <span class="token punctuation">;</span><span class="token punctuation">;</span>esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 离线数仓 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DWS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkipList跳表</title>
      <link href="/2022/09/21/SkipList%E8%B7%B3%E8%A1%A8/"/>
      <url>/2022/09/21/SkipList%E8%B7%B3%E8%A1%A8/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.jianshu.com/p/9d8296562806">Skip List–跳表（全网最详细的跳表文章没有之一） - 简书 (jianshu.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/420602278">图解|深入理解跳表及其在Redis中的应用 - 知乎 (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Skip List跳表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指offer14.剪绳子</title>
      <link href="/2022/09/21/%E5%89%91%E6%8C%87offer14-%E5%89%AA%E7%BB%B3%E5%AD%90/"/>
      <url>/2022/09/21/%E5%89%91%E6%8C%87offer14-%E5%89%AA%E7%BB%B3%E5%AD%90/</url>
      
        <content type="html"><![CDATA[<p><img src="/2022/09/21/%E5%89%91%E6%8C%87offer14-%E5%89%AA%E7%BB%B3%E5%AD%90/1663741022304.png" alt="1663741022304"></p><p>本题目由于n的最大数为58，因此还可以使用O(n^2)的动态规划算法。后面还有个剪绳子2，就不能使用此动态规划算法。</p><p>对于动态规划算法我们需要确定几个条件：</p><ol><li>动态规划数组中的第i个值代表什么，我们在此将其第i个值当作长度为i的绳子最长的长度</li><li>动态规划数组的前几个元素的赋值，这部分比较简单，不再阐述</li><li>动态转移方程，当绳子长度加1的时候，我们需要确定此刻最大的累积乘最大值，我们将其话分为两个部分</li></ol><p><img src="/2022/09/21/%E5%89%91%E6%8C%87offer14-%E5%89%AA%E7%BB%B3%E5%AD%90/1663741464435.png" alt="1663741464435"></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">cuttingRope</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        dp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>i<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>j<span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">-</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span>j<span class="token operator">*</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> dp<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/09/21/%E5%89%91%E6%8C%87offer14-%E5%89%AA%E7%BB%B3%E5%AD%90/1663741828918.png" alt="1663741828918"></p><p>由于本题目的数字比较大，因此不能使用O(n^2)的动态规划算法，此处使用一个数学方法</p><p><img src="/2022/09/21/%E5%89%91%E6%8C%87offer14-%E5%89%AA%E7%BB%B3%E5%AD%90/1663741901720.png" alt="1663741901720"></p><p><img src="/2022/09/21/%E5%89%91%E6%8C%87offer14-%E5%89%AA%E7%BB%B3%E5%AD%90/1663741910726.png" alt="1663741910726"></p><p><img src="/2022/09/21/%E5%89%91%E6%8C%87offer14-%E5%89%AA%E7%BB%B3%E5%AD%90/1663741919352.png" alt="1663741919352"></p><p><img src="/2022/09/21/%E5%89%91%E6%8C%87offer14-%E5%89%AA%E7%BB%B3%E5%AD%90/1663741939387.png" alt="1663741939387"></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">cuttingRope</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span>             <span class="token keyword">return</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> b <span class="token operator">=</span> n <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">,</span> p <span class="token operator">=</span> <span class="token number">1000000007</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> lineNums<span class="token operator">=</span>n<span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">//线段被我们分成以3为大小的小线段个数</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>lineNums<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//从第一段线段开始验算，3的ret次方是否越界。注意是验算lineNums-1次。</span>            ret <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">*</span>ret <span class="token operator">%</span> p<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>             <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ret <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">%</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//刚好被3整数的，要算上前一段</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>             <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ret <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">%</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//被3整数余1的，要算上前一段</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ret <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">%</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//被3整数余2的，要算上前一段</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DP </tag>
            
            <tag> 数学运算 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指offer12.矩阵中的路径</title>
      <link href="/2022/09/21/%E5%89%91%E6%8C%87offer12-%E7%9F%A9%E9%98%B5%E4%B8%AD%E7%9A%84%E8%B7%AF%E5%BE%84/"/>
      <url>/2022/09/21/%E5%89%91%E6%8C%87offer12-%E7%9F%A9%E9%98%B5%E4%B8%AD%E7%9A%84%E8%B7%AF%E5%BE%84/</url>
      
        <content type="html"><![CDATA[<h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p><img src="/2022/09/21/%E5%89%91%E6%8C%87offer12-%E7%9F%A9%E9%98%B5%E4%B8%AD%E7%9A%84%E8%B7%AF%E5%BE%84/1663728224527.png" alt="1663728224527"></p><p><img src="/2022/09/21/%E5%89%91%E6%8C%87offer12-%E7%9F%A9%E9%98%B5%E4%B8%AD%E7%9A%84%E8%B7%AF%E5%BE%84/1663728255342.png" alt="1663728255342"></p><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>目前整体思路：</p><p>首先在整个矩阵中寻找string第一个字符的所有位置，然后对于每一个位置从头开始遍历，使用一个N*M的矩阵用来代表某一个位置是否被遍历过，本来想着使用迭代的思路去求解，但是迭代的方式回溯很难实现，因此可以使用递归的思路来实现回溯。</p><pre class="line-numbers language-sql"><code class="language-sql">class Solution {    <span class="token keyword">public</span> static <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> static <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> exist<span class="token punctuation">(</span>char<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> board<span class="token punctuation">,</span> String word<span class="token punctuation">)</span> {        m <span class="token operator">=</span> board<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        n <span class="token operator">=</span> board<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>        char<span class="token punctuation">[</span><span class="token punctuation">]</span> wordAraay <span class="token operator">=</span> word<span class="token punctuation">.</span>toCharArray<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>board<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span>{            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>board<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>j<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span>{                <span class="token keyword">if</span><span class="token punctuation">(</span>wordAraay<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">=</span>board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>{                    <span class="token keyword">if</span><span class="token punctuation">(</span>DFS<span class="token punctuation">(</span>board<span class="token punctuation">,</span>wordAraay<span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>{                        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    }                }            }        }        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    }    <span class="token keyword">public</span> <span class="token keyword">boolean</span> DFS<span class="token punctuation">(</span>char<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> board<span class="token punctuation">,</span>char<span class="token punctuation">[</span><span class="token punctuation">]</span> word<span class="token punctuation">,</span><span class="token keyword">int</span> i<span class="token punctuation">,</span><span class="token keyword">int</span> j<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">)</span>{        <span class="token comment" spellcheck="true">// i和j代表矩阵搜索到哪一个元素，k代表在搜索第几个字符</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">||</span> i<span class="token operator">>=</span>m <span class="token operator">||</span> j<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">||</span> j<span class="token operator">>=</span>n <span class="token operator">||</span> board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> word<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>{            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        }        <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token operator">=</span>word<span class="token punctuation">.</span>length<span class="token number">-1</span><span class="token punctuation">)</span>{            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        }        board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'&amp;'</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> res <span class="token operator">=</span>  DFS<span class="token punctuation">(</span>board<span class="token punctuation">,</span>word<span class="token punctuation">,</span>i<span class="token number">-1</span><span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> DFS<span class="token punctuation">(</span>board<span class="token punctuation">,</span>word<span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>                <span class="token operator">||</span> DFS<span class="token punctuation">(</span>board<span class="token punctuation">,</span>word<span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token number">-1</span><span class="token punctuation">,</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> DFS<span class="token punctuation">(</span>board<span class="token punctuation">,</span>word<span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> word<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    }}<span class="token comment" spellcheck="true">// class Solution {</span><span class="token comment" spellcheck="true">//     public boolean exist(char[][] board, String word) {</span><span class="token comment" spellcheck="true">//         // 回溯</span><span class="token comment" spellcheck="true">//         char[] wordArray = word.toCharArray();</span><span class="token comment" spellcheck="true">//         int m = board.length;</span><span class="token comment" spellcheck="true">//         int n = board[0].length;</span><span class="token comment" spellcheck="true">//         ArrayList&lt;Integer> mIndex = new ArrayList&lt;>();</span><span class="token comment" spellcheck="true">//         ArrayList&lt;Integer> nIndex = new ArrayList&lt;>();</span><span class="token comment" spellcheck="true">//         for(int i = 0;i&lt;m;i++){</span><span class="token comment" spellcheck="true">//             for(int j = 0;j&lt;n;j++){</span><span class="token comment" spellcheck="true">//                 if(board[i][j] == wordArray[0]){</span><span class="token comment" spellcheck="true">//                     mIndex.add(i);</span><span class="token comment" spellcheck="true">//                     nIndex.add(j);</span><span class="token comment" spellcheck="true">//                 }</span><span class="token comment" spellcheck="true">//             }</span><span class="token comment" spellcheck="true">//         }</span><span class="token comment" spellcheck="true">//         boolean[][] flag = new boolean[m][n];</span><span class="token comment" spellcheck="true">//         for(int i = 0;i&lt;mIndex.size();i++){</span><span class="token comment" spellcheck="true">//             //初始化权重全为false未遍历</span><span class="token comment" spellcheck="true">//             for(int j=0;j&lt;flag.length;j++ ){</span><span class="token comment" spellcheck="true">//                 for(int k = 0;k&lt;flag[0].length;k++){</span><span class="token comment" spellcheck="true">//                     flag[j][k] = false;</span><span class="token comment" spellcheck="true">//                 }</span><span class="token comment" spellcheck="true">//             }</span><span class="token comment" spellcheck="true">//             int mNumber = mIndex.get(i);</span><span class="token comment" spellcheck="true">//             int nNumber = nIndex.get(i);</span><span class="token comment" spellcheck="true">//             int index = 1;</span><span class="token comment" spellcheck="true">//             int flagIndex = 0; //用来记录上一次往四个方向哪一个跑了</span><span class="token comment" spellcheck="true">//             while(index >= wordArray.length){</span><span class="token comment" spellcheck="true">//                 // 遍历上下左右四个情况，看是否能够找到下一个相等的char，当index是1且周围找不到的时候就break；</span><span class="token comment" spellcheck="true">//                 if((mNumber+1)&lt;=m &amp;&amp; flag[mNumber+1][nNumber] == false </span><span class="token comment" spellcheck="true">//                 &amp;&amp; board[mNumber+1][nNumber] == wordArray[index]){</span><span class="token comment" spellcheck="true">//                     index++;</span><span class="token comment" spellcheck="true">//                     mNumber++;</span><span class="token comment" spellcheck="true">//                     flag[mNumber+1][nNumber] = true;</span><span class="token comment" spellcheck="true">//                     flagIndex = 1;</span><span class="token comment" spellcheck="true">//                 }else if((mNumber-1)>=0 &amp;&amp; flag[mNumber-1][nNumber] == false </span><span class="token comment" spellcheck="true">//                 &amp;&amp; board[mNumber-1][nNumber] == wordArray[index]){</span><span class="token comment" spellcheck="true">//                     index++;</span><span class="token comment" spellcheck="true">//                     mNumber--;</span><span class="token comment" spellcheck="true">//                     flag[mNumber-1][nNumber] = true;</span><span class="token comment" spellcheck="true">//                     flagIndex = 2;</span><span class="token comment" spellcheck="true">//                 }else if((nNumber+1)&lt;=n &amp;&amp; flag[mNumber][nNumber+1] == false </span><span class="token comment" spellcheck="true">//                 &amp;&amp; board[mNumber][nNumber+1] == wordArray[index]){</span><span class="token comment" spellcheck="true">//                     index++;</span><span class="token comment" spellcheck="true">//                     nNumber++;</span><span class="token comment" spellcheck="true">//                     flag[mNumber][nNumber+1] = true;</span><span class="token comment" spellcheck="true">//                     flagIndex = 3;</span><span class="token comment" spellcheck="true">//                 }</span><span class="token comment" spellcheck="true">//                 else if((nNumber-1)>=0 &amp;&amp; flag[mNumber][nNumber-1] == false </span><span class="token comment" spellcheck="true">//                 &amp;&amp; board[mNumber][nNumber-1] == wordArray[index]){</span><span class="token comment" spellcheck="true">//                     index++;</span><span class="token comment" spellcheck="true">//                     nNumber--;</span><span class="token comment" spellcheck="true">//                     flag[mNumber][nNumber-1] = true;</span><span class="token comment" spellcheck="true">//                     flagIndex = 4;</span><span class="token comment" spellcheck="true">//                 }else{</span><span class="token comment" spellcheck="true">//                     if(index == 1){</span><span class="token comment" spellcheck="true">//                     break;</span><span class="token comment" spellcheck="true">//                     }</span><span class="token comment" spellcheck="true">//                     else{</span><span class="token comment" spellcheck="true">//                     index--;</span><span class="token comment" spellcheck="true">//                     if(flagIndex==1){</span><span class="token comment" spellcheck="true">//                         mNumber--;</span><span class="token comment" spellcheck="true">//                     }else if(flagIndex==2){</span><span class="token comment" spellcheck="true">//                         mNumber++;</span><span class="token comment" spellcheck="true">//                     }else if(flagIndex == 3){</span><span class="token comment" spellcheck="true">//                         nNumber--;</span><span class="token comment" spellcheck="true">//                     }</span><span class="token comment" spellcheck="true">//                     else if(flagIndex == 4){</span><span class="token comment" spellcheck="true">//                         nNumber++;</span><span class="token comment" spellcheck="true">//                     }</span><span class="token comment" spellcheck="true">//                 }</span><span class="token comment" spellcheck="true">//                 }</span>                <span class="token comment" spellcheck="true">//             }</span><span class="token comment" spellcheck="true">//             if(index==wordArray.length){</span><span class="token comment" spellcheck="true">//                 return true;</span><span class="token comment" spellcheck="true">//             }</span><span class="token comment" spellcheck="true">//         }</span><span class="token comment" spellcheck="true">//         return false;</span><span class="token comment" spellcheck="true">//     }</span><span class="token comment" spellcheck="true">// }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 回溯 </tag>
            
            <tag> DFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DWD层的构建</title>
      <link href="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/"/>
      <url>/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="1-DWD层（用户行为日志数据）"><a href="#1-DWD层（用户行为日志数据）" class="headerlink" title="1. DWD层（用户行为日志数据）"></a>1. DWD层（用户行为日志数据）</h2><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663589117103.png" alt="1663589117103"></p><h3 id="1-1-日志格式回顾"><a href="#1-1-日志格式回顾" class="headerlink" title="1.1 日志格式回顾"></a>1.1 日志格式回顾</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663589139593.png" alt="1663589139593"></p><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663589154554.png" alt="1663589154554"></p><h3 id="1-2-get-json-object函数"><a href="#1-2-get-json-object函数" class="headerlink" title="1.2 get_json_object函数"></a>1.2 get_json_object函数</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663589174365.png" alt="1663589174365"></p><h3 id="1-3-启动日志表"><a href="#1-3-启动日志表" class="headerlink" title="1.3 启动日志表"></a>1.3 启动日志表</h3><p>​<strong>启动日志解析思路：</strong>启动日志表中每行数据对应一个启动记录，一个启动记录应该包含日志中的公共信息和启动信息。先将所有包含start字段的日志过滤出来，然后使用get_json_object函数解析每个字段。</p><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663589229461.png" alt="1663589229461"></p><p><strong>建表语句</strong></p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> dwd_start_log<span class="token punctuation">;</span><span class="token keyword">create</span> external <span class="token keyword">table</span> dwd_start_log<span class="token punctuation">(</span>    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次启动'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'会员id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>entry<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'icon手机图标 notice 通知 install 安装后启动'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>loading_time<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'启动加载时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>open_ad_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告页ID '</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>open_ad_ms<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'广告总共播放时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>open_ad_skip_ms<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户跳过广告时点'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>ts<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间'</span><span class="token punctuation">)</span><span class="token keyword">COMMENT</span> <span class="token string">'启动日志表'</span>partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> string<span class="token punctuation">)</span>stored <span class="token keyword">as</span> orclocation <span class="token string">'/warehouse/gmall/dwd/dwd_start_log'</span>tblproperties <span class="token punctuation">(</span><span class="token string">'orc.compression'</span><span class="token operator">=</span><span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>插入语句</strong></p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_start_log <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ba'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.is_new'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.md'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.mid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.os'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.uid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.vc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.entry'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.loading_time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.open_ad_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.open_ad_ms'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.open_ad_skip_ms'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.ts'</span><span class="token punctuation">)</span><span class="token keyword">from</span> ods_log<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">and</span> get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">NULL</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-4-页面日志表"><a href="#1-4-页面日志表" class="headerlink" title="1.4 页面日志表"></a>1.4 页面日志表</h3><p>​<strong>页面日志解析思路：</strong>页面日志表中每行数据对应一个页面访问记录，一个页面访问记录应该包含日志中的公共信息和页面信息。先将所有包含page字段的日志过滤出来，然后使用get_json_object函数解析每个字段。</p><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663589985916.png" alt="1663589985916"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_page_log<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_page_log<span class="token punctuation">(</span>                                      <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次启动'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>os<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'会员id'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>during_time<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'持续时间毫秒'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>page_item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标id '</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>page_item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标类型'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>last_page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'上页类型'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'页面ID '</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>                                      <span class="token punctuation">`</span>ts<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'页面日志表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_page_log'</span>    TBLPROPERTIES<span class="token punctuation">(</span><span class="token string">'ORC.compression'</span><span class="token operator">=</span><span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_page_log <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ba'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.is_new'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.md'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.mid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.os'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.uid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.vc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.during_time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.last_page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.source_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.ts'</span><span class="token punctuation">)</span><span class="token keyword">from</span> ods_log<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">and</span> get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-5-动作日志表"><a href="#1-5-动作日志表" class="headerlink" title="1.5 动作日志表"></a>1.5 动作日志表</h3><p>​<strong>动作日志解析思路：</strong>动作日志表中每行数据对应用户的一个动作记录，一个动作记录应当包含公共信息、页面信息以及动作信息。先将包含action字段的日志过滤出来，然后通过UDTF函数，将action数组“炸开”（类似于explode函数的效果），然后使用get_json_object函数解析每个字段。</p><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663590296937.png" alt="1663590296937"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_action_log<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_action_log<span class="token punctuation">(</span>    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次启动'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'会员id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>during_time<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'持续时间毫秒'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>page_item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标id '</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>page_item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>last_page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'上页类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'页面id '</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>action_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'动作id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标id '</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>ts<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'动作日志表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_action_log'</span>    TBLPROPERTIES<span class="token punctuation">(</span><span class="token string">'ORC.compression'</span><span class="token operator">=</span><span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_action_log <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ba'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.is_new'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.md'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.mid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.os'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.uid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.vc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.during_time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.last_page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.source_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token keyword">action</span><span class="token punctuation">,</span><span class="token string">'$.action_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token keyword">action</span><span class="token punctuation">,</span><span class="token string">'$.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token keyword">action</span><span class="token punctuation">,</span><span class="token string">'$.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token keyword">action</span><span class="token punctuation">,</span><span class="token string">'$.ts'</span><span class="token punctuation">)</span><span class="token keyword">from</span> gmall<span class="token punctuation">.</span>ods_loglateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.actions'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'},{'</span><span class="token punctuation">,</span><span class="token string">'}%{'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> actions <span class="token keyword">as</span> <span class="token keyword">action</span><span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">and</span> get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.actions'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-6-曝光日志表"><a href="#1-6-曝光日志表" class="headerlink" title="1.6 曝光日志表"></a>1.6 曝光日志表</h3><p>​<strong>曝光日志解析思路：</strong>曝光日志表中每行数据对应一个曝光记录，一个曝光记录应当包含公共信息、页面信息以及曝光信息。先将包含display字段的日志过滤出来，然后通过UDTF函数，将display数组“炸开”（类似于explode函数的效果），然后使用get_json_object函数解析每个字段。</p><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663592697545.png" alt="1663592697545"></p><p>建表语句</p><pre class="line-numbers language-sql\"><code class="language-sql\">DROP TABLE IF EXISTS dwd_display_log;CREATE EXTERNAL TABLE dwd_display_log(    `area_code` STRING COMMENT '地区编码',    `brand` STRING COMMENT '手机品牌',    `channel` STRING COMMENT '渠道',    `is_new` STRING COMMENT '是否首次启动',    `model` STRING COMMENT '手机型号',    `mid_id` STRING COMMENT '设备id',    `os` STRING COMMENT '操作系统',    `user_id` STRING COMMENT '会员id',    `version_code` STRING COMMENT 'app版本号',    `during_time` BIGINT COMMENT '持续时间毫秒',    `page_item` STRING COMMENT '目标id ',    `page_item_type` STRING COMMENT '目标类型',    `last_page_id` STRING COMMENT '上页类型',    `page_id` STRING COMMENT '页面ID ',    `source_type` STRING COMMENT '来源类型',    `ts` BIGINT COMMENT '时间戳',    `display_type` STRING COMMENT '曝光类型',    `item` STRING COMMENT '曝光对象id ',    `item_type` STRING COMMENT 'app版本号',    `order` BIGINT COMMENT '曝光顺序',    `pos_id` BIGINT COMMENT '曝光位置') COMMENT '曝光日志表'    PARTITIONED BY (`dt` STRING)    STORED AS ORC    LOCATION '/warehouse/gmall/dwd/dwd_display_log'    TBLPROPERTIES('ORC.compression'='snappy');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_display_log <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ba'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.is_new'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.md'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.mid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.os'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.uid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.vc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.during_time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.last_page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.source_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.display_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.order'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.pos_id'</span><span class="token punctuation">)</span><span class="token keyword">from</span> gmall<span class="token punctuation">.</span>ods_log         lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>replace<span class="token punctuation">(</span>get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.displays'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'},{'</span><span class="token punctuation">,</span><span class="token string">'}%{'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> display<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span> <span class="token operator">and</span> get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.displays'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-7-错误日志表"><a href="#1-7-错误日志表" class="headerlink" title="1.7 错误日志表"></a>1.7 错误日志表</h3><p>​<strong>错误日志解析思路：</strong>错误日志表中每行数据对应一个错误记录，为方便定位错误，一个错误记录应当包含与之对应的公共信息、页面信息、曝光信息、动作信息、启动信息以及错误信息。先将包含err字段的日志过滤出来，然后使用get_json_object函数解析所有字段。</p><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663593318664.png" alt="1663593318664"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_error_log<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_error_log<span class="token punctuation">(</span>    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次启动'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'会员id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>page_item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标id '</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>page_item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>last_page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'上页类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'页面ID '</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>entry<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">' icon手机图标  notice 通知 install 安装后启动'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>loading_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'启动加载时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>open_ad_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告页ID '</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>open_ad_ms<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告总共播放时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>open_ad_skip_ms<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户跳过广告时点'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>actions<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'动作'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>displays<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'曝光'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>ts<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>error_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'错误码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>msg<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'错误信息'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'错误日志表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_error_log'</span>    TBLPROPERTIES<span class="token punctuation">(</span><span class="token string">'ORC.compression'</span><span class="token operator">=</span><span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_error_log <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ba'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.is_new'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.md'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.mid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.os'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.uid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.vc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.last_page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.source_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.entry'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.loading_time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.open_ad_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.open_ad_ms'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.open_ad_skip_ms'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.actions'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.displays'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.err.error_code'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.err.msg'</span><span class="token punctuation">)</span><span class="token keyword">from</span> ods_log<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>  <span class="token operator">and</span> get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.err'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-8-DWD层用户行为数据加载脚本"><a href="#1-8-DWD层用户行为数据加载脚本" class="headerlink" title="1.8 DWD层用户行为数据加载脚本"></a>1.8 DWD层用户行为数据加载脚本</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#!/bin/bash</span>APP<span class="token operator">=</span>gmall<span class="token comment" spellcheck="true"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$2"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>    do_date<span class="token operator">=</span>$<span class="token number">2</span><span class="token keyword">else</span>     do_date<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span><span class="token number">d</span> <span class="token string">"-1 day"</span> <span class="token operator">+</span><span class="token operator">%</span>F<span class="token punctuation">`</span>fidwd_start_log<span class="token operator">=</span><span class="token string">"insert overwrite table gmall.dwd_start_log partition (dt='$do_date')select    get_json_object(line,'$.common.ar'),    get_json_object(line,'$.common.ba'),    get_json_object(line,'$.common.ch'),    get_json_object(line,'$.common.is_new'),    get_json_object(line,'$.common.md'),    get_json_object(line,'$.common.mid'),    get_json_object(line,'$.common.os'),    get_json_object(line,'$.common.uid'),    get_json_object(line,'$.common.vc'),    get_json_object(line,'$.start.entry'),    get_json_object(line,'$.start.loading_time'),    get_json_object(line,'$.start.open_ad_id'),    get_json_object(line,'$.start.open_ad_ms'),    get_json_object(line,'$.start.open_ad_skip_ms'),    get_json_object(line,'$.ts')from gmall.ods_logwhere dt='$do_date' and get_json_object(line,'$.start') is not null;"</span>dwd_page_log<span class="token operator">=</span><span class="token string">"insert overwrite table gmall.dwd_page_log partition (dt='$do_date')select    get_json_object(line,'$.common.ar'),    get_json_object(line,'$.common.ba'),    get_json_object(line,'$.common.ch'),    get_json_object(line,'$.common.is_new'),    get_json_object(line,'$.common.md'),    get_json_object(line,'$.common.mid'),    get_json_object(line,'$.common.os'),    get_json_object(line,'$.common.uid'),    get_json_object(line,'$.common.vc'),    get_json_object(line,'$.page.during_time'),    get_json_object(line,'$.page.item'),    get_json_object(line,'$.page.item_type'),    get_json_object(line,'$.page.last_page_id'),    get_json_object(line,'$.page.page_id'),    get_json_object(line,'$.page.source_type'),    get_json_object(line,'$.ts')from gmall.ods_logwhere dt='2022-09-01' and get_json_object(line,'$.page') is not null;"</span>dwd_action_log<span class="token operator">=</span><span class="token string">"insert overwrite table gmall.dwd_action_log partition (dt='$do_date')select    get_json_object(line,'$.common.ar'),    get_json_object(line,'$.common.ba'),    get_json_object(line,'$.common.ch'),    get_json_object(line,'$.common.is_new'),    get_json_object(line,'$.common.md'),    get_json_object(line,'$.common.mid'),    get_json_object(line,'$.common.os'),    get_json_object(line,'$.common.uid'),    get_json_object(line,'$.common.vc'),    get_json_object(line,'$.page.during_time'),    get_json_object(line,'$.page.item'),    get_json_object(line,'$.page.item_type'),    get_json_object(line,'$.page.last_page_id'),    get_json_object(line,'$.page.page_id'),    get_json_object(line,'$.page.source_type'),    get_json_object(actions.action,'$.action_id'),    get_json_object(actions.action,'$.item'),    get_json_object(actions.action,'$.item_type'),    get_json_object(actions.action,'$.ts')from gmall.ods_loglateral view explode(split(replace(replace(replace(get_json_object(line,'$.actions'),'[',''),']',''),'},{','}%{'),'%')) actions as actionwhere dt='$do_date' and get_json_object(line,'$.actions') is not null;"</span>dwd_display_log<span class="token operator">=</span><span class="token string">"insert overwrite table gmall.dwd_display_log partition (dt='$do_date')select    get_json_object(line,'$.common.ar'),    get_json_object(line,'$.common.ba'),    get_json_object(line,'$.common.ch'),    get_json_object(line,'$.common.is_new'),    get_json_object(line,'$.common.md'),    get_json_object(line,'$.common.mid'),    get_json_object(line,'$.common.os'),    get_json_object(line,'$.common.uid'),    get_json_object(line,'$.common.vc'),    get_json_object(line,'$.page.during_time'),    get_json_object(line,'$.page.item'),    get_json_object(line,'$.page.item_type'),    get_json_object(line,'$.page.last_page_id'),    get_json_object(line,'$.page.page_id'),    get_json_object(line,'$.page.source_type'),    get_json_object(line,'$.ts'),    get_json_object(display,'$.display_type'),    get_json_object(display,'$.item'),    get_json_object(display,'$.item_type'),    get_json_object(display,'$.order'),    get_json_object(display,'$.pos_id')from gmall.ods_log         lateral view explode(split(replace(replace(replace(get_json_object(line,'$.displays'),'[',''),']',''),'},{','}%{'),'%')) tmp as displaywhere dt='$do_date' and get_json_object(line,'$.displays') is not null;"</span>dwd_error_log<span class="token operator">=</span><span class="token string">"insert overwrite table gmall.dwd_error_log partition(dt='$do_date')select    get_json_object(line,'$.common.ar'),    get_json_object(line,'$.common.ba'),    get_json_object(line,'$.common.ch'),    get_json_object(line,'$.common.is_new'),    get_json_object(line,'$.common.md'),    get_json_object(line,'$.common.mid'),    get_json_object(line,'$.common.os'),    get_json_object(line,'$.common.uid'),    get_json_object(line,'$.common.vc'),    get_json_object(line,'$.page.item'),    get_json_object(line,'$.page.item_type'),    get_json_object(line,'$.page.last_page_id'),    get_json_object(line,'$.page.page_id'),    get_json_object(line,'$.page.source_type'),    get_json_object(line,'$.start.entry'),    get_json_object(line,'$.start.loading_time'),    get_json_object(line,'$.start.open_ad_id'),    get_json_object(line,'$.start.open_ad_ms'),    get_json_object(line,'$.start.open_ad_skip_ms'),    get_json_object(line,'$.actions'),    get_json_object(line,'$.displays'),    get_json_object(line,'$.ts'),    get_json_object(line,'$.err.error_code'),    get_json_object(line,'$.err.msg')from gmall.ods_logwhere dt='$do_date'  and get_json_object(line,'$.err') is not null;"</span><span class="token keyword">case</span> $<span class="token number">1</span> <span class="token operator">in</span>    dwd_start_log <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_start_log"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_page_log <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_page_log"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_action_log <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_action_log"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_display_log <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_display_log"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_error_log <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_error_log"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token keyword">all</span> <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_start_log$dwd_page_log$dwd_action_log$dwd_display_log$dwd_error_log"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-DWD层（业务数据）"><a href="#2-DWD层（业务数据）" class="headerlink" title="2. DWD层（业务数据）"></a>2. DWD层（业务数据）</h2><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663597745821.png" alt="1663597745821"></p><h3 id="2-1-评价事实表（事务型事实表）"><a href="#2-1-评价事实表（事务型事实表）" class="headerlink" title="2.1 评价事实表（事务型事实表）"></a>2.1 评价事实表（事务型事实表）</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663598154226.png" alt="1663598154226"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_comment_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_comment_info<span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品sku'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品spu'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>appraise<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'评价(好评、中评、差评、默认评价)'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'评价时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'评价事实表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_comment_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入数据</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_comment_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    user_id<span class="token punctuation">,</span>    sku_id<span class="token punctuation">,</span>    spu_id<span class="token punctuation">,</span>    order_id<span class="token punctuation">,</span>    appraise<span class="token punctuation">,</span>    create_time<span class="token keyword">from</span> ods_comment_info<span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-订单明细事实表（事务型事实表）"><a href="#2-2-订单明细事实表（事务型事实表）" class="headerlink" title="2.2 订单明细事实表（事务型事实表）"></a>2.2 订单明细事实表（事务型事实表）</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663598408985.png" alt="1663598408985"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_order_detail<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_order_detail <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku商品id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>source_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品数量'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'原始价格'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>split_activity_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动优惠分摊'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>split_coupon_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券优惠分摊'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>split_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最终价格分摊'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单明细事实表表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_order_detail/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入数据语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_detail <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    od<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>    oda<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>    oda<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">,</span>    odc<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>source_type<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>source_id<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>sku_num<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>order_price<span class="token operator">*</span>od<span class="token punctuation">.</span>sku_num<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>split_activity_amount<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>split_coupon_amount<span class="token punctuation">,</span>    od<span class="token punctuation">.</span>split_final_amount<span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            <span class="token operator">*</span>        <span class="token keyword">from</span> ods_order_detail        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>od        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            user_id<span class="token punctuation">,</span>            province_id        <span class="token keyword">from</span> ods_order_info        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>oi    <span class="token keyword">on</span> od<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_detail_id<span class="token punctuation">,</span>            activity_id<span class="token punctuation">,</span>            activity_rule_id        <span class="token keyword">from</span> ods_order_detail_activity        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>oda    <span class="token keyword">on</span> od<span class="token punctuation">.</span>id<span class="token operator">=</span>oda<span class="token punctuation">.</span>order_detail_id        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_detail_id<span class="token punctuation">,</span>            coupon_id        <span class="token keyword">from</span> ods_order_detail_coupon        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>odc    <span class="token keyword">on</span> od<span class="token punctuation">.</span>id<span class="token operator">=</span>odc<span class="token punctuation">.</span>order_detail_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-3-退单明细事实表（事务型事实表）"><a href="#2-3-退单明细事实表（事务型事实表）" class="headerlink" title="2.3 退单明细事实表（事务型事实表）"></a>2.3 退单明细事实表（事务型事实表）</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663599818327.png" alt="1663599818327"></p><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663599830039.png" alt="1663599830039"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_order_refund_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_order_refund_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_reason_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单原因类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单事实表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_order_refund_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_refund_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    ri<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>    ri<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>    ri<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>    ri<span class="token punctuation">.</span>refund_type<span class="token punctuation">,</span>    ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">,</span>    ri<span class="token punctuation">.</span>refund_amount<span class="token punctuation">,</span>    ri<span class="token punctuation">.</span>refund_reason_type<span class="token punctuation">,</span>    ri<span class="token punctuation">.</span>create_time<span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_order_refund_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>ri        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span> id<span class="token punctuation">,</span>province_id <span class="token keyword">from</span> ods_order_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>oi    <span class="token keyword">on</span> ri<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-4-加购事实表（周期性快照事实表）"><a href="#2-4-加购事实表（周期性快照事实表）" class="headerlink" title="2.4 加购事实表（周期性快照事实表）"></a>2.4 加购事实表（周期性快照事实表）</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663599857041.png" alt="1663599857041"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_cart_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_cart_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>source_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cart_price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'加入购物车时的价格'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_ordered<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否已下单'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'下单时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'加购数量'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'加购事实表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_cart_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_cart_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    user_id<span class="token punctuation">,</span>    sku_id<span class="token punctuation">,</span>    source_type<span class="token punctuation">,</span>    source_id<span class="token punctuation">,</span>    cart_price<span class="token punctuation">,</span>    is_ordered<span class="token punctuation">,</span>    create_time<span class="token punctuation">,</span>    operate_time<span class="token punctuation">,</span>    order_time<span class="token punctuation">,</span>    sku_num<span class="token keyword">from</span> ods_cart_info<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-5-收藏事实表（周期性快照事实表）"><a href="#2-5-收藏事实表（周期性快照事实表）" class="headerlink" title="2.5 收藏事实表（周期性快照事实表）"></a>2.5 收藏事实表（周期性快照事实表）</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663600028593.png" alt="1663600028593"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_favor_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_favor_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'skuid'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_cancel<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'是否取消'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'收藏时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cancel_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'取消时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'收藏事实表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_favor_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_favor_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    user_id<span class="token punctuation">,</span>    sku_id<span class="token punctuation">,</span>    spu_id<span class="token punctuation">,</span>    is_cancel<span class="token punctuation">,</span>    create_time<span class="token punctuation">,</span>    cancel_time<span class="token keyword">from</span> ods_favor_info<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-6-优惠卷领用事实表（累计型快照事实表）"><a href="#2-6-优惠卷领用事实表（累计型快照事实表）" class="headerlink" title="2.6 优惠卷领用事实表（累计型快照事实表）"></a>2.6 优惠卷领用事实表（累计型快照事实表）</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663600192270.png" alt="1663600192270"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_coupon_use<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_coupon_use<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'userid'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'订单id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_status<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'优惠券状态'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>get_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'领取时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>using_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'使用时间(下单)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>used_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'使用时间(支付)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券领用事实表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_coupon_use/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663600249105.png" alt="1663600249105"></p><p>首日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_coupon_use <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    coupon_id<span class="token punctuation">,</span>    user_id<span class="token punctuation">,</span>    order_id<span class="token punctuation">,</span>    coupon_status<span class="token punctuation">,</span>    get_time<span class="token punctuation">,</span>    using_time<span class="token punctuation">,</span>    used_time<span class="token punctuation">,</span>    expire_time<span class="token punctuation">,</span>    <span class="token keyword">coalesce</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">from</span> ods_coupon_use<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>coupon_status<span class="token punctuation">,</span>old<span class="token punctuation">.</span>coupon_status<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>get_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>get_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>using_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>using_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>used_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>used_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>expire_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">coalesce</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>used_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>used_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>expire_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        coupon_id<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        order_id<span class="token punctuation">,</span>        coupon_status<span class="token punctuation">,</span>        get_time<span class="token punctuation">,</span>        using_time<span class="token punctuation">,</span>        used_time<span class="token punctuation">,</span>        expire_time    <span class="token keyword">from</span> gmall<span class="token punctuation">.</span>dwd_coupon_use    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'9999-99-99'</span><span class="token punctuation">)</span> old<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span><span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        coupon_id<span class="token punctuation">,</span>        user_id<span class="token punctuation">,</span>        order_id<span class="token punctuation">,</span>        coupon_status<span class="token punctuation">,</span>        get_time<span class="token punctuation">,</span>        using_time<span class="token punctuation">,</span>        used_time<span class="token punctuation">,</span>        expire_time    <span class="token keyword">from</span> ods_coupon_use    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-02'</span><span class="token punctuation">)</span>new<span class="token keyword">on</span> old<span class="token punctuation">.</span>id<span class="token operator">=</span>new<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-7-支付事实表（累计型快照事实表）"><a href="#2-7-支付事实表（累计型快照事实表）" class="headerlink" title="2.7 支付事实表（累计型快照事实表）"></a>2.7 支付事实表（累计型快照事实表）</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663600874368.png" alt="1663600874368"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_payment_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_payment_info <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外交易编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付状态'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--调用第三方支付接口的时间</span>    <span class="token punctuation">`</span>callback_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'完成时间'</span><span class="token comment" spellcheck="true">--支付完成时间，即支付成功回调时间</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付事实表表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_payment_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663600942151.png" alt="1663600942151"></p><p>首日插入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_payment_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    pi<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    pi<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>    pi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>    pi<span class="token punctuation">.</span>trade_no<span class="token punctuation">,</span>    pi<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>    pi<span class="token punctuation">.</span>payment_type<span class="token punctuation">,</span>    pi<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span>    pi<span class="token punctuation">.</span>payment_status<span class="token punctuation">,</span>    pi<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>    pi<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>pi<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>pi        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span> id<span class="token punctuation">,</span>province_id <span class="token keyword">from</span> ods_order_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>oi    <span class="token keyword">on</span> pi<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每日插入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_payment_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_type<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_type<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_status<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_status<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>create_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>callback_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>callback_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span> id<span class="token punctuation">,</span>               order_id<span class="token punctuation">,</span>               user_id<span class="token punctuation">,</span>               province_id<span class="token punctuation">,</span>               trade_no<span class="token punctuation">,</span>               out_trade_no<span class="token punctuation">,</span>               payment_type<span class="token punctuation">,</span>               payment_amount<span class="token punctuation">,</span>               payment_status<span class="token punctuation">,</span>               create_time<span class="token punctuation">,</span>               callback_time        <span class="token keyword">from</span> dwd_payment_info        <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'9999-99-99'</span>    <span class="token punctuation">)</span>old        <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            pi<span class="token punctuation">.</span>id<span class="token punctuation">,</span>            pi<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>            pi<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>            pi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>            pi<span class="token punctuation">.</span>payment_type<span class="token punctuation">,</span>            pi<span class="token punctuation">.</span>trade_no<span class="token punctuation">,</span>            pi<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span>            pi<span class="token punctuation">.</span>payment_status<span class="token punctuation">,</span>            pi<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>            pi<span class="token punctuation">.</span>callback_time        <span class="token keyword">from</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-02'</span>            <span class="token punctuation">)</span>pi                <span class="token keyword">left</span> <span class="token keyword">join</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span> id<span class="token punctuation">,</span>province_id <span class="token keyword">from</span> ods_order_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-02'</span>            <span class="token punctuation">)</span>oi            <span class="token keyword">on</span> pi<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id    <span class="token punctuation">)</span>new    <span class="token keyword">on</span> old<span class="token punctuation">.</span>id<span class="token operator">=</span>new<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-8-退款事实表（累计型快照事实表）"><a href="#2-8-退款事实表（累计型快照事实表）" class="headerlink" title="2.8 退款事实表（累计型快照事实表）"></a>2.8 退款事实表（累计型快照事实表）</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663601333283.png" alt="1663601333283"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_refund_payment<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_refund_payment <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外交易编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退款状态'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--调用第三方支付接口的时间</span>    <span class="token punctuation">`</span>callback_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'回调时间'</span><span class="token comment" spellcheck="true">--支付接口回调时间，即支付成功时间</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款事实表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_refund_payment/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663601394801.png" alt="1663601394801"></p><p>首日装载</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_refund_payment <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    rp<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    user_id<span class="token punctuation">,</span>    order_id<span class="token punctuation">,</span>    sku_id<span class="token punctuation">,</span>    province_id<span class="token punctuation">,</span>    trade_no<span class="token punctuation">,</span>    out_trade_no<span class="token punctuation">,</span>    payment_type<span class="token punctuation">,</span>    refund_amount<span class="token punctuation">,</span>    refund_status<span class="token punctuation">,</span>    create_time<span class="token punctuation">,</span>    callback_time<span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            out_trade_no<span class="token punctuation">,</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            payment_type<span class="token punctuation">,</span>            trade_no<span class="token punctuation">,</span>            refund_amount<span class="token punctuation">,</span>            refund_status<span class="token punctuation">,</span>            create_time<span class="token punctuation">,</span>            callback_time        <span class="token keyword">from</span> ods_refund_payment        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>rp        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            user_id<span class="token punctuation">,</span>            province_id        <span class="token keyword">from</span> ods_order_info        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>oi    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每日装载</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_refund_payment <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_type<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_type<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>refund_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_status<span class="token punctuation">,</span>old<span class="token punctuation">.</span>refund_status<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>create_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>callback_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>callback_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            user_id<span class="token punctuation">,</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            province_id<span class="token punctuation">,</span>            trade_no<span class="token punctuation">,</span>            out_trade_no<span class="token punctuation">,</span>            payment_type<span class="token punctuation">,</span>            refund_amount<span class="token punctuation">,</span>            refund_status<span class="token punctuation">,</span>            create_time<span class="token punctuation">,</span>            callback_time        <span class="token keyword">from</span> dwd_refund_payment        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>    <span class="token punctuation">)</span>old        <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            rp<span class="token punctuation">.</span>id<span class="token punctuation">,</span>            user_id<span class="token punctuation">,</span>            order_id<span class="token punctuation">,</span>            sku_id<span class="token punctuation">,</span>            province_id<span class="token punctuation">,</span>            trade_no<span class="token punctuation">,</span>            out_trade_no<span class="token punctuation">,</span>            payment_type<span class="token punctuation">,</span>            refund_amount<span class="token punctuation">,</span>            refund_status<span class="token punctuation">,</span>            create_time<span class="token punctuation">,</span>            callback_time        <span class="token keyword">from</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span>                    id<span class="token punctuation">,</span>                    out_trade_no<span class="token punctuation">,</span>                    order_id<span class="token punctuation">,</span>                    sku_id<span class="token punctuation">,</span>                    payment_type<span class="token punctuation">,</span>                    trade_no<span class="token punctuation">,</span>                    refund_amount<span class="token punctuation">,</span>                    refund_status<span class="token punctuation">,</span>                    create_time<span class="token punctuation">,</span>                    callback_time                <span class="token keyword">from</span> ods_refund_payment                <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-02'</span>            <span class="token punctuation">)</span>rp                <span class="token keyword">left</span> <span class="token keyword">join</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span>                    id<span class="token punctuation">,</span>                    user_id<span class="token punctuation">,</span>                    province_id                <span class="token keyword">from</span> ods_order_info                <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-02'</span>            <span class="token punctuation">)</span>oi            <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id    <span class="token punctuation">)</span>new    <span class="token keyword">on</span> old<span class="token punctuation">.</span>id<span class="token operator">=</span>new<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-9-订单事实表（累计型快照事实表）"><a href="#2-9-订单事实表（累计型快照事实表）" class="headerlink" title="2.9 订单事实表（累计型快照事实表）"></a>2.9 订单事实表（累计型快照事实表）</h3><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663601541878.png" alt="1663601541878"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_order_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_order_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单状态'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_way<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付方式'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>delivery_address<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'邮寄地址'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外交易编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tracking_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'物流单号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间(未支付状态)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付时间(已支付状态)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cancel_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'取消时间(已取消状态)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>finish_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'完成时间(已完成状态)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退款时间(退款中状态)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_finish_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退款完成时间(退款完成状态)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>feight_fee<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'运费'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>feight_fee_reduce<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'运费减免'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动减免'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券减免'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单原始价格'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单最终价格'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单事实表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_order_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/09/19/DWD%E5%B1%82%E7%9A%84%E6%9E%84%E5%BB%BA/1663601600941.png" alt="1663601600941"></p><p>首日导入</p><p>str_to_map函数，第一个参数是字符串，第二个参数是多个元素之间的分隔符，第三个参数是每一个元素之间key和value之间的分隔符</p><p>concat_ws函数，里面第一个参数是分隔符，第二个是一个列表，代表把列表的所有元素以分隔符分开形成一个字符串</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    oi<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>order_status<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>payment_way<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>delivery_address<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>tracking_no<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1002'</span><span class="token punctuation">]</span> payment_time<span class="token punctuation">,</span>    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1003'</span><span class="token punctuation">]</span> cancel_time<span class="token punctuation">,</span>    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1004'</span><span class="token punctuation">]</span> finish_time<span class="token punctuation">,</span>    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1005'</span><span class="token punctuation">]</span> refund_time<span class="token punctuation">,</span>    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1006'</span><span class="token punctuation">]</span> refund_finish_time<span class="token punctuation">,</span>    oi<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>    feight_fee<span class="token punctuation">,</span>    feight_fee_reduce<span class="token punctuation">,</span>    activity_reduce_amount<span class="token punctuation">,</span>    coupon_reduce_amount<span class="token punctuation">,</span>    original_amount<span class="token punctuation">,</span>    final_amount<span class="token punctuation">,</span>    <span class="token keyword">coalesce</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1003'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1004'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1006'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>oi<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            <span class="token operator">*</span>        <span class="token keyword">from</span> ods_order_info        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>oi        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            order_id<span class="token punctuation">,</span>            str_to_map<span class="token punctuation">(</span>concat_ws<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span>collect_set<span class="token punctuation">(</span>concat<span class="token punctuation">(</span>order_status<span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">,</span>operate_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">)</span> ts        <span class="token keyword">from</span> ods_order_status_log        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> order_id    <span class="token punctuation">)</span>times    <span class="token keyword">on</span> oi<span class="token punctuation">.</span>id<span class="token operator">=</span>times<span class="token punctuation">.</span>order_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每日导入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>order_status<span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_status<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_way<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_way<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>delivery_address<span class="token punctuation">,</span>old<span class="token punctuation">.</span>delivery_address<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>tracking_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>tracking_no<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>create_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>cancel_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>cancel_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>finish_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>finish_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>refund_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_finish_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>refund_finish_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>expire_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>feight_fee<span class="token punctuation">,</span>old<span class="token punctuation">.</span>feight_fee<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>feight_fee_reduce<span class="token punctuation">,</span>old<span class="token punctuation">.</span>feight_fee_reduce<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>activity_reduce_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>activity_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>coupon_reduce_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>coupon_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>original_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>final_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">coalesce</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>cancel_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>cancel_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>finish_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>finish_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_finish_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>refund_finish_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>expire_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            order_status<span class="token punctuation">,</span>            user_id<span class="token punctuation">,</span>            province_id<span class="token punctuation">,</span>            payment_way<span class="token punctuation">,</span>            delivery_address<span class="token punctuation">,</span>            out_trade_no<span class="token punctuation">,</span>            tracking_no<span class="token punctuation">,</span>            create_time<span class="token punctuation">,</span>            payment_time<span class="token punctuation">,</span>            cancel_time<span class="token punctuation">,</span>            finish_time<span class="token punctuation">,</span>            refund_time<span class="token punctuation">,</span>            refund_finish_time<span class="token punctuation">,</span>            expire_time<span class="token punctuation">,</span>            feight_fee<span class="token punctuation">,</span>            feight_fee_reduce<span class="token punctuation">,</span>            activity_reduce_amount<span class="token punctuation">,</span>            coupon_reduce_amount<span class="token punctuation">,</span>            original_amount<span class="token punctuation">,</span>            final_amount        <span class="token keyword">from</span> dwd_order_info        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>    <span class="token punctuation">)</span>old        <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            oi<span class="token punctuation">.</span>id<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>order_status<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>payment_way<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>delivery_address<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>tracking_no<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>            times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1002'</span><span class="token punctuation">]</span> payment_time<span class="token punctuation">,</span>            times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1003'</span><span class="token punctuation">]</span> cancel_time<span class="token punctuation">,</span>            times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1004'</span><span class="token punctuation">]</span> finish_time<span class="token punctuation">,</span>            times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1005'</span><span class="token punctuation">]</span> refund_time<span class="token punctuation">,</span>            times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1006'</span><span class="token punctuation">]</span> refund_finish_time<span class="token punctuation">,</span>            oi<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>            feight_fee<span class="token punctuation">,</span>            feight_fee_reduce<span class="token punctuation">,</span>            activity_reduce_amount<span class="token punctuation">,</span>            coupon_reduce_amount<span class="token punctuation">,</span>            original_amount<span class="token punctuation">,</span>            final_amount        <span class="token keyword">from</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span>                    <span class="token operator">*</span>                <span class="token keyword">from</span> ods_order_info                <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-02'</span>            <span class="token punctuation">)</span>oi                <span class="token keyword">left</span> <span class="token keyword">join</span>            <span class="token punctuation">(</span>                <span class="token keyword">select</span>                    order_id<span class="token punctuation">,</span>                    str_to_map<span class="token punctuation">(</span>concat_ws<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span>collect_set<span class="token punctuation">(</span>concat<span class="token punctuation">(</span>order_status<span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">,</span>operate_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">)</span> ts                <span class="token keyword">from</span> ods_order_status_log                <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-02'</span>                <span class="token keyword">group</span> <span class="token keyword">by</span> order_id            <span class="token punctuation">)</span>times            <span class="token keyword">on</span> oi<span class="token punctuation">.</span>id<span class="token operator">=</span>times<span class="token punctuation">.</span>order_id    <span class="token punctuation">)</span>new    <span class="token keyword">on</span> old<span class="token punctuation">.</span>id<span class="token operator">=</span>new<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-10-业务数据首日导入"><a href="#2-10-业务数据首日导入" class="headerlink" title="2.10 业务数据首日导入"></a>2.10 业务数据首日导入</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#!/bin/bash</span>APP<span class="token operator">=</span>gmall<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$2"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>   do_date<span class="token operator">=</span>$<span class="token number">2</span><span class="token keyword">else</span>    echo <span class="token string">"请传入日期参数"</span>   <span class="token keyword">exit</span>fi dwd_order_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_order_info partition(dt)select    oi.id,    oi.order_status,    oi.user_id,    oi.province_id,    oi.payment_way,    oi.delivery_address,    oi.out_trade_no,    oi.tracking_no,    oi.create_time,    times.ts['1002'] payment_time,    times.ts['1003'] cancel_time,    times.ts['1004'] finish_time,    times.ts['1005'] refund_time,    times.ts['1006'] refund_finish_time,    oi.expire_time,    feight_fee,    feight_fee_reduce,    activity_reduce_amount,    coupon_reduce_amount,    original_amount,    final_amount,    coalesce(date_format(times.ts['1003'],'yyyy-MM-dd'),date_format(times.ts['1004'],'yyyy-MM-dd'),date_format(times.ts['1006'],'yyyy-MM-dd'),date_format(oi.expire_time,'yyyy-MM-dd'),'9999-99-99')from(    select        *    from ${APP}.ods_order_info    where dt='$do_date')oileft join(    select        order_id,        str_to_map(concat_ws(',',collect_set(concat(order_status,'=',operate_time))),',','=') ts    from ${APP}.ods_order_status_log    where dt='$do_date'    group by order_id)timeson oi.id=times.order_id;"</span>dwd_order_detail<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_order_detail partition(dt)select    od.id,    od.order_id,    oi.user_id,    od.sku_id,    oi.province_id,    oda.activity_id,    oda.activity_rule_id,    odc.coupon_id,    od.create_time,    od.source_type,    od.source_id,    od.sku_num,    od.order_price*od.sku_num,    od.split_activity_amount,    od.split_coupon_amount,    od.split_final_amount,    date_format(create_time,'yyyy-MM-dd')from(    select        *    from ${APP}.ods_order_detail    where dt='$do_date')odleft join(    select        id,        user_id,        province_id    from ${APP}.ods_order_info    where dt='$do_date')oion od.order_id=oi.idleft join(    select        order_detail_id,        activity_id,        activity_rule_id    from ${APP}.ods_order_detail_activity    where dt='$do_date')odaon od.id=oda.order_detail_idleft join(    select        order_detail_id,        coupon_id    from ${APP}.ods_order_detail_coupon    where dt='$do_date')odcon od.id=odc.order_detail_id;"</span>dwd_payment_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_payment_info partition(dt)select    pi.id,    pi.order_id,    pi.user_id,    oi.province_id,    pi.trade_no,    pi.out_trade_no,    pi.payment_type,    pi.payment_amount,    pi.payment_status,    pi.create_time,    pi.callback_time,    nvl(date_format(pi.callback_time,'yyyy-MM-dd'),'9999-99-99')from(    select * from ${APP}.ods_payment_info where dt='$do_date')pileft join(    select id,province_id from ${APP}.ods_order_info where dt='$do_date')oion pi.order_id=oi.id;"</span>dwd_cart_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_cart_info partition(dt='$do_date')select    id,    user_id,    sku_id,    source_type,    source_id,    cart_price,    is_ordered,    create_time,    operate_time,    order_time,    sku_numfrom ${APP}.ods_cart_infowhere dt='$do_date';"</span>dwd_comment_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_comment_info partition (dt)select    id,    user_id,    sku_id,    spu_id,    order_id,    appraise,    create_time,    date_format(create_time,'yyyy-MM-dd')from ${APP}.ods_comment_infowhere dt='$do_date';"</span>dwd_favor_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_favor_info partition(dt='$do_date')select    id,    user_id,    sku_id,    spu_id,    is_cancel,    create_time,    cancel_timefrom ${APP}.ods_favor_infowhere dt='$do_date';"</span>dwd_coupon_use<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_coupon_use partition(dt)select    id,    coupon_id,    user_id,    order_id,    coupon_status,    get_time,    using_time,    used_time,    expire_time,    coalesce(date_format(used_time,'yyyy-MM-dd'),date_format(expire_time,'yyyy-MM-dd'),'9999-99-99')from ${APP}.ods_coupon_usewhere dt='$do_date';"</span>dwd_order_refund_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_order_refund_info partition(dt)select    ri.id,    ri.user_id,    ri.order_id,    ri.sku_id,    oi.province_id,    ri.refund_type,    ri.refund_num,    ri.refund_amount,    ri.refund_reason_type,    ri.create_time,    date_format(ri.create_time,'yyyy-MM-dd')from(    select * from ${APP}.ods_order_refund_info where dt='$do_date')rileft join(    select id,province_id from ${APP}.ods_order_info where dt='$do_date')oion ri.order_id=oi.id;"</span>dwd_refund_payment<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_refund_payment partition(dt)select    rp.id,    user_id,    order_id,    sku_id,    province_id,    trade_no,    out_trade_no,    payment_type,    refund_amount,    refund_status,    create_time,    callback_time,    nvl(date_format(callback_time,'yyyy-MM-dd'),'9999-99-99')from(    select        id,        out_trade_no,        order_id,        sku_id,        payment_type,        trade_no,        refund_amount,        refund_status,        create_time,        callback_time    from ${APP}.ods_refund_payment    where dt='$do_date')rpleft join(    select        id,        user_id,        province_id    from ${APP}.ods_order_info    where dt='$do_date')oion rp.order_id=oi.id;"</span><span class="token keyword">case</span> $<span class="token number">1</span> <span class="token operator">in</span>    dwd_order_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_order_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_order_detail <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_order_detail"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_payment_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_payment_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_cart_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_cart_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_comment_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_comment_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_favor_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_favor_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_coupon_use <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_coupon_use"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_order_refund_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_order_refund_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_refund_payment <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_refund_payment"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token keyword">all</span> <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_order_info$dwd_order_detail$dwd_payment_info$dwd_cart_info$dwd_comment_info$dwd_favor_info$dwd_coupon_use$dwd_order_refund_info$dwd_refund_payment"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-11-业务数据每日导入"><a href="#2-11-业务数据每日导入" class="headerlink" title="2.11 业务数据每日导入"></a>2.11 业务数据每日导入</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#!/bin/bash</span>APP<span class="token operator">=</span>gmall<span class="token comment" spellcheck="true"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$2"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>    do_date<span class="token operator">=</span>$<span class="token number">2</span><span class="token keyword">else</span>    <span class="token keyword">exit</span>     do_date<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span><span class="token number">d</span> <span class="token string">"-1 day"</span> <span class="token operator">+</span><span class="token operator">%</span>F<span class="token punctuation">`</span>fidwd_order_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_order_info partition(dt='$do_date')select    nvl(new.id,old.id),    nvl(new.order_status,old.order_status),    nvl(new.user_id,old.user_id),    nvl(new.province_id,old.province_id),    nvl(new.payment_way,old.payment_way),    nvl(new.delivery_address,old.delivery_address),    nvl(new.out_trade_no,old.out_trade_no),    nvl(new.tracking_no,old.tracking_no),    nvl(new.create_time,old.create_time),    nvl(new.payment_time,old.payment_time),    nvl(new.cancel_time,old.cancel_time),    nvl(new.finish_time,old.finish_time),    nvl(new.refund_time,old.refund_time),    nvl(new.refund_finish_time,old.refund_finish_time),    nvl(new.expire_time,old.expire_time),    nvl(new.feight_fee,old.feight_fee),    nvl(new.feight_fee_reduce,old.feight_fee_reduce),    nvl(new.activity_reduce_amount,old.activity_reduce_amount),    nvl(new.coupon_reduce_amount,old.coupon_reduce_amount),    nvl(new.original_amount,old.original_amount),    nvl(new.final_amount,old.final_amount),    coalesce(date_format(nvl(new.cancel_time,old.cancel_time),'yyyy-MM-dd'),date_format(nvl(new.finish_time,old.finish_time),'yyyy-MM-dd'),date_format(nvl(new.refund_finish_time,old.refund_finish_time),'yyyy-MM-dd'),date_format(nvl(new.expire_time,old.expire_time),'yyyy-MM-dd'),'9999-99-99')from(    select        id,        order_status,        user_id,        province_id,        payment_way,        delivery_address,        out_trade_no,        tracking_no,        create_time,        payment_time,        cancel_time,        finish_time,        refund_time,        refund_finish_time,        expire_time,        feight_fee,        feight_fee_reduce,        activity_reduce_amount,        coupon_reduce_amount,        original_amount,        final_amount    from ${APP}.dwd_order_info    where dt='9999-99-99')oldfull outer join(    select        oi.id,        oi.order_status,        oi.user_id,        oi.province_id,        oi.payment_way,        oi.delivery_address,        oi.out_trade_no,        oi.tracking_no,        oi.create_time,        times.ts['1002'] payment_time,        times.ts['1003'] cancel_time,        times.ts['1004'] finish_time,        times.ts['1005'] refund_time,        times.ts['1006'] refund_finish_time,        oi.expire_time,        feight_fee,        feight_fee_reduce,        activity_reduce_amount,        coupon_reduce_amount,        original_amount,        final_amount    from    (        select            *        from ${APP}.ods_order_info        where dt='$do_date'    )oi    left join    (        select            order_id,            str_to_map(concat_ws(',',collect_set(concat(order_status,'=',operate_time))),',','=') ts        from ${APP}.ods_order_status_log        where dt='$do_date'        group by order_id    )times    on oi.id=times.order_id)newon old.id=new.id;"</span>dwd_order_detail<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_order_detail partition(dt='$do_date')select    od.id,    od.order_id,    oi.user_id,    od.sku_id,    oi.province_id,    oda.activity_id,    oda.activity_rule_id,    odc.coupon_id,    od.create_time,    od.source_type,    od.source_id,    od.sku_num,    od.order_price*od.sku_num,    od.split_activity_amount,    od.split_coupon_amount,    od.split_final_amountfrom(    select        *    from ${APP}.ods_order_detail    where dt='$do_date')odleft join(    select        id,        user_id,        province_id    from ${APP}.ods_order_info    where dt='$do_date')oion od.order_id=oi.idleft join(    select        order_detail_id,        activity_id,        activity_rule_id    from ${APP}.ods_order_detail_activity    where dt='$do_date')odaon od.id=oda.order_detail_idleft join(    select        order_detail_id,        coupon_id    from ${APP}.ods_order_detail_coupon    where dt='$do_date')odcon od.id=odc.order_detail_id;"</span>dwd_payment_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_payment_info partition(dt)select    nvl(new.id,old.id),    nvl(new.order_id,old.order_id),    nvl(new.user_id,old.user_id),    nvl(new.province_id,old.province_id),    nvl(new.trade_no,old.trade_no),    nvl(new.out_trade_no,old.out_trade_no),    nvl(new.payment_type,old.payment_type),    nvl(new.payment_amount,old.payment_amount),    nvl(new.payment_status,old.payment_status),    nvl(new.create_time,old.create_time),    nvl(new.callback_time,old.callback_time),    nvl(date_format(nvl(new.callback_time,old.callback_time),'yyyy-MM-dd'),'9999-99-99')from(    select id,       order_id,       user_id,       province_id,       trade_no,       out_trade_no,       payment_type,       payment_amount,       payment_status,       create_time,       callback_time    from ${APP}.dwd_payment_info    where dt = '9999-99-99')oldfull outer join(    select        pi.id,        pi.out_trade_no,        pi.order_id,        pi.user_id,        oi.province_id,        pi.payment_type,        pi.trade_no,        pi.payment_amount,        pi.payment_status,        pi.create_time,        pi.callback_time    from    (        select * from ${APP}.ods_payment_info where dt='$do_date'    )pi    left join    (        select id,province_id from ${APP}.ods_order_info where dt='$do_date'    )oi    on pi.order_id=oi.id)newon old.id=new.id;"</span>dwd_cart_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_cart_info partition(dt='$do_date')select    id,    user_id,    sku_id,    source_type,    source_id,    cart_price,    is_ordered,    create_time,    operate_time,    order_time,    sku_numfrom ${APP}.ods_cart_infowhere dt='$do_date';"</span>dwd_comment_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_comment_info partition(dt='$do_date')select    id,    user_id,    sku_id,    spu_id,    order_id,    appraise,    create_timefrom ${APP}.ods_comment_info where dt='$do_date';"</span>dwd_favor_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_favor_info partition(dt='$do_date')select    id,    user_id,    sku_id,    spu_id,    is_cancel,    create_time,    cancel_timefrom ${APP}.ods_favor_infowhere dt='$do_date';"</span>dwd_coupon_use<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_coupon_use partition(dt)select    nvl(new.id,old.id),    nvl(new.coupon_id,old.coupon_id),    nvl(new.user_id,old.user_id),    nvl(new.order_id,old.order_id),    nvl(new.coupon_status,old.coupon_status),    nvl(new.get_time,old.get_time),    nvl(new.using_time,old.using_time),    nvl(new.used_time,old.used_time),    nvl(new.expire_time,old.expire_time),    coalesce(date_format(nvl(new.used_time,old.used_time),'yyyy-MM-dd'),date_format(nvl(new.expire_time,old.expire_time),'yyyy-MM-dd'),'9999-99-99')from(    select        id,        coupon_id,        user_id,        order_id,        coupon_status,        get_time,        using_time,        used_time,        expire_time    from ${APP}.dwd_coupon_use    where dt='9999-99-99')oldfull outer join(    select        id,        coupon_id,        user_id,        order_id,        coupon_status,        get_time,        using_time,        used_time,        expire_time    from ${APP}.ods_coupon_use    where dt='$do_date')newon old.id=new.id;"</span>dwd_order_refund_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_order_refund_info partition(dt='$do_date')select    ri.id,    ri.user_id,    ri.order_id,    ri.sku_id,    oi.province_id,    ri.refund_type,    ri.refund_num,    ri.refund_amount,    ri.refund_reason_type,    ri.create_timefrom(    select * from ${APP}.ods_order_refund_info where dt='$do_date')rileft join(    select id,province_id from ${APP}.ods_order_info where dt='$do_date')oion ri.order_id=oi.id;"</span>dwd_refund_payment<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dwd_refund_payment partition(dt)select    nvl(new.id,old.id),    nvl(new.user_id,old.user_id),    nvl(new.order_id,old.order_id),    nvl(new.sku_id,old.sku_id),    nvl(new.province_id,old.province_id),    nvl(new.trade_no,old.trade_no),    nvl(new.out_trade_no,old.out_trade_no),    nvl(new.payment_type,old.payment_type),    nvl(new.refund_amount,old.refund_amount),    nvl(new.refund_status,old.refund_status),    nvl(new.create_time,old.create_time),    nvl(new.callback_time,old.callback_time),    nvl(date_format(nvl(new.callback_time,old.callback_time),'yyyy-MM-dd'),'9999-99-99')from(    select        id,        user_id,        order_id,        sku_id,        province_id,        trade_no,        out_trade_no,        payment_type,        refund_amount,        refund_status,        create_time,        callback_time    from ${APP}.dwd_refund_payment    where dt='9999-99-99')oldfull outer join(    select        rp.id,        user_id,        order_id,        sku_id,        province_id,        trade_no,        out_trade_no,        payment_type,        refund_amount,        refund_status,        create_time,        callback_time    from    (        select            id,            out_trade_no,            order_id,            sku_id,            payment_type,            trade_no,            refund_amount,            refund_status,            create_time,            callback_time        from ${APP}.ods_refund_payment        where dt='$do_date'    )rp    left join    (        select            id,            user_id,            province_id        from ${APP}.ods_order_info        where dt='$do_date'    )oi    on rp.order_id=oi.id)newon old.id=new.id;"</span>strict<span class="token operator">=</span><span class="token string">"set hive.exec.dynamic.partition.mode=nonstrict"</span><span class="token keyword">case</span> $<span class="token number">1</span> <span class="token operator">in</span>    dwd_order_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_order_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_order_detail <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_order_detail"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_payment_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_payment_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_cart_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_cart_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_comment_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_comment_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_favor_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_favor_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_coupon_use <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_coupon_use"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_order_refund_info <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_order_refund_info"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    dwd_refund_payment <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dwd_refund_payment"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token keyword">all</span> <span class="token punctuation">)</span>        hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$strict$dwd_order_info$dwd_order_detail$dwd_payment_info$dwd_cart_info$dwd_comment_info$dwd_favor_info$dwd_coupon_use$dwd_order_refund_info$dwd_refund_payment"</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 离线数仓 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 事实表的构建 </tag>
            
            <tag> DWD层 </tag>
            
            <tag> UDTF </tag>
            
            <tag> lateral view </tag>
            
            <tag> concat_ws </tag>
            
            <tag> str_to_map </tag>
            
            <tag> 周期性快照事实表 </tag>
            
            <tag> 累计型快照事实表 </tag>
            
            <tag> 事务型事实表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指offer07重建二叉树</title>
      <link href="/2022/09/19/%E5%89%91%E6%8C%87offer07%E9%87%8D%E5%BB%BA%E4%BA%8C%E5%8F%89%E6%A0%91/"/>
      <url>/2022/09/19/%E5%89%91%E6%8C%87offer07%E9%87%8D%E5%BB%BA%E4%BA%8C%E5%8F%89%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<p>题目描述：</p><p><img src="/2022/09/19/%E5%89%91%E6%8C%87offer07%E9%87%8D%E5%BB%BA%E4%BA%8C%E5%8F%89%E6%A0%91/1663559522691.png" alt="1663559522691"></p><p>本题目较为简单的思路是使用递归去求解。</p><p>​题目中给了前序遍历结果以及中序遍历的结果，按照这两个遍历的性质，前序遍历的顺序是根结点-&gt;左子树-&gt;右子树，而中序遍历的顺序是左子树-&gt;根节点-&gt;右子树。因此我们每一次从前序遍历得到根节点，然后从中序遍历中得到根节点的位置，得到该位置之后，左边的就是左子树，右边的就是右子树，然后接着对两边进行递归求解。</p><p>​上述获取根节点的位置，可以使用一个map来达到O(1)的复杂度，因为题目中提及无重复数字。</p><p>递归需要确定的两个步骤：</p><ol><li><p>递归参数</p><p>​这部分我们每一次递归需要得到左子树以及右子树的范围，而且每一次递归我们需要得到根节点的值，我们可以根据前序遍历的第一个数字作为跟节点，然后通过map来获取根节点在中序的位置，这样就得到了左子树以及右子树的范围，这样只是得到的中序数组中的两个子树的范围，还需要确定前序数组中两个子树的范围，可以根据左子树节点的数目来计算得出前序数组的两个子树的范围。</p><p>​这样每一次我们需要传入的递归参数就是，子树在前序遍历的范围（两个下标），子树在中序遍历的范围（两个下标）</p></li><li><p>递归的结束条件</p><p>当左索引大于右索引，直接范围null</p></li></ol><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Definition for a binary tree node. * public class TreeNode { *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode(int x) { val = x; } * } */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    Map<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span>Integer<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">;</span>    <span class="token keyword">public</span> TreeNode <span class="token function">buildTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>preorder <span class="token operator">=</span> preorder<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>inorder <span class="token operator">=</span> inorder<span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> preorder<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorder<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>inorder<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> TreeNode <span class="token function">myBuildTree</span><span class="token punctuation">(</span><span class="token keyword">int</span> preLeft<span class="token punctuation">,</span><span class="token keyword">int</span> preRight<span class="token punctuation">,</span><span class="token keyword">int</span> inoLeft<span class="token punctuation">,</span> <span class="token keyword">int</span> inoRight<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>inoLeft<span class="token operator">></span>inoRight<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>inoLeft <span class="token operator">==</span> inoRight<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>inorder<span class="token punctuation">[</span>inoLeft<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        TreeNode root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorder<span class="token punctuation">[</span>preLeft<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> index <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>preorder<span class="token punctuation">[</span>preLeft<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取跟节点的下标</span>        <span class="token keyword">int</span> leftNumber <span class="token operator">=</span> index <span class="token operator">-</span> inoLeft<span class="token punctuation">;</span>        <span class="token keyword">int</span> rightNumber <span class="token operator">=</span> inoRight <span class="token operator">-</span> index<span class="token punctuation">;</span>        root<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span>preLeft<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>preLeft<span class="token operator">+</span>leftNumber<span class="token punctuation">,</span>inoLeft<span class="token punctuation">,</span>index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        root<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span>preLeft<span class="token operator">+</span>leftNumber<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>preRight<span class="token punctuation">,</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>inoRight<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前序遍历 </tag>
            
            <tag> 中序遍历 </tag>
            
            <tag> 二叉树的构建 </tag>
            
            <tag> 哈希表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dim层的创建</title>
      <link href="/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/"/>
      <url>/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="1-商品维度表（全量）"><a href="#1-商品维度表（全量）" class="headerlink" title="1. 商品维度表（全量）"></a>1. 商品维度表（全量）</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_sku_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_sku_info <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品价格'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_desc<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品描述'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>weight<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'重量'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_sale<span class="token punctuation">`</span> <span class="token keyword">BOOLEAN</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否在售'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spu编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spu名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级分类id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category3_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级分类名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级分类id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category2_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级分类名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级分类id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category1_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级分类名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_attr_values<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>attr_id:STRING<span class="token punctuation">,</span>value_id:STRING<span class="token punctuation">,</span>attr_name:STRING<span class="token punctuation">,</span>value_name:STRING<span class="token operator">>></span> <span class="token keyword">COMMENT</span> <span class="token string">'平台属性'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_sale_attr_values<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>sale_attr_id:STRING<span class="token punctuation">,</span>sale_attr_value_id:STRING<span class="token punctuation">,</span>sale_attr_name:STRING<span class="token punctuation">,</span>sale_attr_value_name:STRING<span class="token operator">>></span> <span class="token keyword">COMMENT</span> <span class="token string">'销售属性'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品维度表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_sku_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查询插入语句</p><p>这里使用了一个with … as用法，写起来比较容易理解</p><p>named_struct函数，可以把一行的多个属性值合并成为一个结构体</p><p>collect_list函数可以把多行转换成一个array数据</p><p><img src="/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663506364998.png" alt="1663506364998"></p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">with</span> sku_info <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        spu_id<span class="token punctuation">,</span>        price<span class="token punctuation">,</span>        sku_name<span class="token punctuation">,</span>        sku_desc<span class="token punctuation">,</span>        weight<span class="token punctuation">,</span>        tm_id<span class="token punctuation">,</span>        category3_id<span class="token punctuation">,</span>        is_sale<span class="token punctuation">,</span>        create_time    <span class="token keyword">from</span> ods_sku_info    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span>    spu_info <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        spu_name    <span class="token keyword">from</span> ods_spu_info    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span>    tm <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            tm_name        <span class="token keyword">from</span> ods_base_trademark        <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span>    cate_3 <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            name<span class="token punctuation">,</span>            category2_id        <span class="token keyword">from</span> ods_base_category3        <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span>    cate_2 <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            name<span class="token punctuation">,</span>            category1_id        <span class="token keyword">from</span> ods_base_category2        <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span>    cate_1 <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            name        <span class="token keyword">from</span> ods_base_category1        <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span>    sku_attr_value <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            collect_list<span class="token punctuation">(</span>                    named_struct<span class="token punctuation">(</span>                            <span class="token string">'attr_id'</span><span class="token punctuation">,</span>attr_id<span class="token punctuation">,</span>                            <span class="token string">'value_id'</span><span class="token punctuation">,</span>value_id<span class="token punctuation">,</span>                            <span class="token string">'attr_name'</span><span class="token punctuation">,</span>attr_name<span class="token punctuation">,</span>                            <span class="token string">'value_name'</span><span class="token punctuation">,</span>value_name                        <span class="token punctuation">)</span>                <span class="token punctuation">)</span> <span class="token keyword">as</span> value1        <span class="token keyword">from</span> ods_sku_attr_value        <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id    <span class="token punctuation">)</span><span class="token punctuation">,</span>    sku_sale_value <span class="token keyword">as</span> <span class="token punctuation">(</span>        <span class="token keyword">select</span>            sku_id<span class="token punctuation">,</span>            collect_list<span class="token punctuation">(</span>                named_struct<span class="token punctuation">(</span>                        <span class="token string">'sale_attr_id'</span><span class="token punctuation">,</span>sale_attr_id<span class="token punctuation">,</span>                        <span class="token string">'sale_attr_value_id'</span><span class="token punctuation">,</span>sale_attr_value_id<span class="token punctuation">,</span>                        <span class="token string">'sale_attr_name'</span><span class="token punctuation">,</span>sale_attr_name<span class="token punctuation">,</span>                        <span class="token string">'sale_attr_value_name'</span><span class="token punctuation">,</span>sale_attr_value_name                    <span class="token punctuation">)</span>                <span class="token punctuation">)</span> <span class="token keyword">as</span> value1        <span class="token keyword">from</span> ods_sku_sale_attr_value        <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-09-01'</span>        <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id    <span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_sku_info <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    sku_info<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    price<span class="token punctuation">,</span>    sku_name<span class="token punctuation">,</span>    sku_desc<span class="token punctuation">,</span>    weight<span class="token punctuation">,</span>    is_sale<span class="token punctuation">,</span>    spu_id<span class="token punctuation">,</span>    spu_name<span class="token punctuation">,</span>    category3_id<span class="token punctuation">,</span>    cate_3<span class="token punctuation">.</span>name<span class="token punctuation">,</span>    category2_id<span class="token punctuation">,</span>    cate_2<span class="token punctuation">.</span>name<span class="token punctuation">,</span>    category1_id<span class="token punctuation">,</span>    cate_1<span class="token punctuation">.</span>name<span class="token punctuation">,</span>    tm_id<span class="token punctuation">,</span>    tm_name<span class="token punctuation">,</span>    sku_attr_value<span class="token punctuation">.</span>value1<span class="token punctuation">,</span>    sku_sale_value<span class="token punctuation">.</span>value1<span class="token punctuation">,</span>    create_time<span class="token keyword">from</span> sku_info<span class="token keyword">left</span> <span class="token keyword">join</span> spu_info <span class="token keyword">on</span> sku_info<span class="token punctuation">.</span>spu_id <span class="token operator">=</span> spu_info<span class="token punctuation">.</span>id<span class="token keyword">left</span> <span class="token keyword">join</span> tm <span class="token keyword">on</span> tm_id <span class="token operator">=</span> tm<span class="token punctuation">.</span>id<span class="token keyword">left</span> <span class="token keyword">join</span> cate_3 <span class="token keyword">on</span> category3_id <span class="token operator">=</span> cate_3<span class="token punctuation">.</span>id<span class="token keyword">left</span> <span class="token keyword">join</span> cate_2 <span class="token keyword">on</span> category2_id <span class="token operator">=</span> cate_2<span class="token punctuation">.</span>id<span class="token keyword">left</span> <span class="token keyword">join</span> cate_1 <span class="token keyword">on</span> category1_id <span class="token operator">=</span> cate_1<span class="token punctuation">.</span>id<span class="token keyword">left</span> <span class="token keyword">join</span> sku_attr_value <span class="token keyword">on</span> sku_info<span class="token punctuation">.</span>id <span class="token operator">=</span> sku_attr_value<span class="token punctuation">.</span>sku_id<span class="token keyword">left</span> <span class="token keyword">join</span> sku_sale_value <span class="token keyword">on</span> sku_info<span class="token punctuation">.</span>id <span class="token operator">=</span> sku_sale_value<span class="token punctuation">.</span>sku_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-优惠卷维度表（全量）"><a href="#2-优惠卷维度表（全量）" class="headerlink" title="2. 优惠卷维度表（全量）"></a>2. 优惠卷维度表（全量）</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_coupon_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_coupon_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满额数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'减金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'折扣'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>range_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'范围类型 1、商品 2、品类 3、品牌'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>limit_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最多领取次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>taken_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'已领取次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>start_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'可以领取的开始日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>end_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'可以领取的结束日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券维度表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_coupon_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><p>本表格插入十分简单，只涉及到一个表格的插入</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_coupon_info <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    coupon_name<span class="token punctuation">,</span>    coupon_type<span class="token punctuation">,</span>    condition_amount<span class="token punctuation">,</span>    condition_num<span class="token punctuation">,</span>    activity_id<span class="token punctuation">,</span>    benefit_amount<span class="token punctuation">,</span>    benefit_discount<span class="token punctuation">,</span>    create_time<span class="token punctuation">,</span>    range_type<span class="token punctuation">,</span>    limit_num<span class="token punctuation">,</span>    taken_count<span class="token punctuation">,</span>    start_time<span class="token punctuation">,</span>    end_time<span class="token punctuation">,</span>    operate_time<span class="token punctuation">,</span>    expire_time<span class="token keyword">from</span> ods_coupon_info<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-活动维度表（全量）"><a href="#3-活动维度表（全量）" class="headerlink" title="3. 活动维度表（全量）"></a>3. 活动维度表（全量）</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_activity_rule_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_activity_rule_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_name<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_type<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>start_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'开始时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>end_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'结束时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠折扣'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>benefit_level<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠级别'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动信息表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_activity_rule_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_activity_rule_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    ar<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    ar<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>    ai<span class="token punctuation">.</span>activity_name<span class="token punctuation">,</span>    ar<span class="token punctuation">.</span>activity_type<span class="token punctuation">,</span>    ai<span class="token punctuation">.</span>start_time<span class="token punctuation">,</span>    ai<span class="token punctuation">.</span>end_time<span class="token punctuation">,</span>    ai<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>    ar<span class="token punctuation">.</span>condition_amount<span class="token punctuation">,</span>    ar<span class="token punctuation">.</span>condition_num<span class="token punctuation">,</span>    ar<span class="token punctuation">.</span>benefit_amount<span class="token punctuation">,</span>    ar<span class="token punctuation">.</span>benefit_discount<span class="token punctuation">,</span>    ar<span class="token punctuation">.</span>benefit_level<span class="token keyword">from</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            activity_id<span class="token punctuation">,</span>            activity_type<span class="token punctuation">,</span>            condition_amount<span class="token punctuation">,</span>            condition_num<span class="token punctuation">,</span>            benefit_amount<span class="token punctuation">,</span>            benefit_discount<span class="token punctuation">,</span>            benefit_level        <span class="token keyword">from</span> ods_activity_rule        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>ar        <span class="token keyword">left</span> <span class="token keyword">join</span>    <span class="token punctuation">(</span>        <span class="token keyword">select</span>            id<span class="token punctuation">,</span>            activity_name<span class="token punctuation">,</span>            start_time<span class="token punctuation">,</span>            end_time<span class="token punctuation">,</span>            create_time        <span class="token keyword">from</span> ods_activity_info        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span>    <span class="token punctuation">)</span>ai    <span class="token keyword">on</span> ar<span class="token punctuation">.</span>activity_id<span class="token operator">=</span>ai<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-地区维度表（特殊）"><a href="#4-地区维度表（特殊）" class="headerlink" title="4. 地区维度表（特殊）"></a>4. 地区维度表（特殊）</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_base_province<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_base_province <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>province_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省市名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>iso_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'ISO-3166编码，供可视化使用'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>iso_3166_2<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'IOS-3166-2编码，供可视化使用'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>region_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>region_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区名称'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'地区维度表'</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_base_province/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_base_province<span class="token keyword">select</span>    bp<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    bp<span class="token punctuation">.</span>name<span class="token punctuation">,</span>    bp<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>    bp<span class="token punctuation">.</span>iso_code<span class="token punctuation">,</span>    bp<span class="token punctuation">.</span>iso_3166_2<span class="token punctuation">,</span>    bp<span class="token punctuation">.</span>region_id<span class="token punctuation">,</span>    br<span class="token punctuation">.</span>region_name<span class="token keyword">from</span> ods_base_province bp         <span class="token keyword">join</span> ods_base_region br <span class="token keyword">on</span> bp<span class="token punctuation">.</span>region_id <span class="token operator">=</span> br<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-时间维度表（特殊）"><a href="#5-时间维度表（特殊）" class="headerlink" title="5. 时间维度表（特殊）"></a>5. 时间维度表（特殊）</h2><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_date_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_date_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>date_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'日'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>week_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'周ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>week_day<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'周几'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>day<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'每月的第几天'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>month<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几月'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>quarter<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几季度'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>year<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'年'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_workday<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否是工作日'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>holiday_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'节假日'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间维度表'</span>    STORED <span class="token keyword">AS</span> ORC    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_date_info/'</span>    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入语句</p><hr><p>创建临时表格</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> tmp_dim_date_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> tmp_dim_date_info <span class="token punctuation">(</span>    <span class="token punctuation">`</span>date_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'日'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>week_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'周ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>week_day<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'周几'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>day<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'每月的第几天'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>month<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几月'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>quarter<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几季度'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>year<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'年'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_workday<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否是工作日'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>holiday_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'节假日'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间维度表'</span><span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>LOCATION <span class="token string">'/warehouse/gmall/tmp/tmp_dim_date_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663509620531.png" alt="1663509620531"></p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_date_info <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tmp_dim_date_info<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="6-用户维度表（拉链表）"><a href="#6-用户维度表（拉链表）" class="headerlink" title="6. 用户维度表（拉链表）"></a>6. 用户维度表（拉链表）</h2><p>​当数据量小，而且随着时间数据变化很缓慢，此时就可以使用拉链表</p><h3 id="6-1-拉链表介绍"><a href="#6-1-拉链表介绍" class="headerlink" title="6.1 拉链表介绍"></a>6.1 拉链表介绍</h3><p><img src="/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663511858460.png" alt="1663511858460"></p><p><img src="/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663511869306.png" alt="1663511869306"></p><p><img src="/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663511928535.png" alt="1663511928535"></p><p><img src="/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663511944034.png" alt="1663511944034"></p><h3 id="6-2-制作拉链表"><a href="#6-2-制作拉链表" class="headerlink" title="6.2 制作拉链表"></a>6.2 制作拉链表</h3><p><img src="/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663511983585.png" alt="1663511983585"></p><p>建表语句</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_user_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_user_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>nick_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户昵称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户姓名'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>phone_num<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机号码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>email<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_level<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户等级'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>birthday<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'生日'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>gender<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'性别'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'开始日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>end_date<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'结束日期'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户表'</span>PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>STORED <span class="token keyword">AS</span> ORCLOCATION <span class="token string">'/warehouse/gmall/dim/dim_user_info/'</span>TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"orc.compress"</span><span class="token operator">=</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/09/18/dim%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663512401704.png" alt="1663512401704"></p><p><strong>首日装载</strong></p><p>首日装载就是把当天的数据全部放入9999这个分区就可以</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_user_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    id<span class="token punctuation">,</span>    login_name<span class="token punctuation">,</span>    nick_name<span class="token punctuation">,</span>    md5<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>    md5<span class="token punctuation">(</span>phone_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    md5<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">,</span>    user_level<span class="token punctuation">,</span>    birthday<span class="token punctuation">,</span>    gender<span class="token punctuation">,</span>    create_time<span class="token punctuation">,</span>    operate_time<span class="token punctuation">,</span>    <span class="token string">'2021-06-14'</span><span class="token punctuation">,</span>    <span class="token string">'9999-99-99'</span><span class="token keyword">from</span> ods_user_info<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2021-06-14'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>每日装载</strong></p><p>本部分有点麻烦，首先我们需要把当天的数据和9999的join起来，如果数据被修改了就放入昨天的分区中，如果新增以及没有被修改的就放入9999分区中。</p><p>可以有两种思路来实现，一种是写两个sql，一种是使用动态分区来插入。</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">with</span> old <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        login_name<span class="token punctuation">,</span>        nick_name<span class="token punctuation">,</span>        name<span class="token punctuation">,</span>        phone_num<span class="token punctuation">,</span>        email<span class="token punctuation">,</span>        user_level<span class="token punctuation">,</span>        birthday<span class="token punctuation">,</span>        gender<span class="token punctuation">,</span>        create_time<span class="token punctuation">,</span>        operate_time<span class="token punctuation">,</span>        start_date<span class="token punctuation">,</span>        end_date    <span class="token keyword">from</span> dim_user_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        login_name<span class="token punctuation">,</span>        nick_name<span class="token punctuation">,</span>        name<span class="token punctuation">,</span>        phone_num<span class="token punctuation">,</span>        email<span class="token punctuation">,</span>        user_level<span class="token punctuation">,</span>        birthday<span class="token punctuation">,</span>        gender<span class="token punctuation">,</span>        create_time<span class="token punctuation">,</span>        operate_time    <span class="token keyword">from</span> ods_user_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-02'</span><span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_user_info <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>login_name<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>nick_name<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>name<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>phone_num<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>email<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>user_level<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>birthday<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>gender<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>    new<span class="token punctuation">.</span>operate_time<span class="token punctuation">,</span>    start_date<span class="token punctuation">,</span>    <span class="token string">'2022-09-01'</span><span class="token keyword">from</span> old <span class="token keyword">join</span> new <span class="token keyword">on</span> old<span class="token punctuation">.</span>id <span class="token operator">=</span> new<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span class="token keyword">with</span> old <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        login_name<span class="token punctuation">,</span>        nick_name<span class="token punctuation">,</span>        name<span class="token punctuation">,</span>        phone_num<span class="token punctuation">,</span>        email<span class="token punctuation">,</span>        user_level<span class="token punctuation">,</span>        birthday<span class="token punctuation">,</span>        gender<span class="token punctuation">,</span>        create_time<span class="token punctuation">,</span>        operate_time<span class="token punctuation">,</span>        start_date<span class="token punctuation">,</span>        end_date    <span class="token keyword">from</span> dim_user_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new <span class="token keyword">as</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span>        id<span class="token punctuation">,</span>        login_name<span class="token punctuation">,</span>        nick_name<span class="token punctuation">,</span>        name<span class="token punctuation">,</span>        phone_num<span class="token punctuation">,</span>        email<span class="token punctuation">,</span>        user_level<span class="token punctuation">,</span>        birthday<span class="token punctuation">,</span>        gender<span class="token punctuation">,</span>        create_time<span class="token punctuation">,</span>        operate_time    <span class="token keyword">from</span> ods_user_info    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-09-02'</span><span class="token punctuation">)</span><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_user_info <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span><span class="token keyword">select</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>id<span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_name<span class="token punctuation">,</span>new<span class="token punctuation">.</span>login_name<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>nick_name<span class="token punctuation">,</span>new<span class="token punctuation">.</span>nick_name<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>name<span class="token punctuation">,</span>new<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>phone_num<span class="token punctuation">,</span>new<span class="token punctuation">.</span>phone_num<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>email<span class="token punctuation">,</span>new<span class="token punctuation">.</span>email<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>user_level<span class="token punctuation">,</span>new<span class="token punctuation">.</span>user_level<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>birthday<span class="token punctuation">,</span>new<span class="token punctuation">.</span>birthday<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>gender<span class="token punctuation">,</span>new<span class="token punctuation">.</span>gender<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>new<span class="token punctuation">.</span>create_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>operate_time<span class="token punctuation">,</span>new<span class="token punctuation">.</span>operate_time<span class="token punctuation">)</span><span class="token punctuation">,</span>    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>start_date<span class="token punctuation">,</span><span class="token string">'2022-09-02'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token string">'9999-99-99'</span><span class="token keyword">from</span> old <span class="token keyword">full</span> <span class="token keyword">outer</span>    <span class="token keyword">join</span> new <span class="token keyword">on</span> old<span class="token punctuation">.</span>id <span class="token operator">=</span> new<span class="token punctuation">.</span>id<span class="token keyword">where</span> old<span class="token punctuation">.</span>id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">or</span> new<span class="token punctuation">.</span>id <span class="token operator">is</span> <span class="token boolean">null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-首日DIM维度层装载脚本"><a href="#7-首日DIM维度层装载脚本" class="headerlink" title="7. 首日DIM维度层装载脚本"></a>7. 首日DIM维度层装载脚本</h2><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#!/bin/bash</span>APP<span class="token operator">=</span>gmall<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$2"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>   do_date<span class="token operator">=</span>$<span class="token number">2</span><span class="token keyword">else</span>    echo <span class="token string">"请传入日期参数"</span>   <span class="token keyword">exit</span>fi dim_user_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dim_user_info partition(dt='9999-99-99')select    id,    login_name,    nick_name,    md5(name),    md5(phone_num),    md5(email),    user_level,    birthday,    gender,    create_time,    operate_time,    '$do_date',    '9999-99-99'from ${APP}.ods_user_infowhere dt='$do_date';"</span>dim_sku_info<span class="token operator">=</span><span class="token string">"withsku as(    select        id,        price,        sku_name,        sku_desc,        weight,        is_sale,        spu_id,        category3_id,        tm_id,        create_time    from ${APP}.ods_sku_info    where dt='$do_date'),spu as(    select        id,        spu_name    from ${APP}.ods_spu_info    where dt='$do_date'),c3 as(    select        id,        name,        category2_id    from ${APP}.ods_base_category3    where dt='$do_date'),c2 as(    select        id,        name,        category1_id    from ${APP}.ods_base_category2    where dt='$do_date'),c1 as(    select        id,        name    from ${APP}.ods_base_category1    where dt='$do_date'),tm as(    select        id,        tm_name    from ${APP}.ods_base_trademark    where dt='$do_date'),attr as(    select        sku_id,        collect_set(named_struct('attr_id',attr_id,'value_id',value_id,'attr_name',attr_name,'value_name',value_name)) attrs    from ${APP}.ods_sku_attr_value    where dt='$do_date'    group by sku_id),sale_attr as(    select        sku_id,        collect_set(named_struct('sale_attr_id',sale_attr_id,'sale_attr_value_id',sale_attr_value_id,'sale_attr_name',sale_attr_name,'sale_attr_value_name',sale_attr_value_name)) sale_attrs    from ${APP}.ods_sku_sale_attr_value    where dt='$do_date'    group by sku_id)insert overwrite table ${APP}.dim_sku_info partition(dt='$do_date')select    sku.id,    sku.price,    sku.sku_name,    sku.sku_desc,    sku.weight,    sku.is_sale,    sku.spu_id,    spu.spu_name,    sku.category3_id,    c3.name,    c3.category2_id,    c2.name,    c2.category1_id,    c1.name,    sku.tm_id,    tm.tm_name,    attr.attrs,    sale_attr.sale_attrs,    sku.create_timefrom skuleft join spu on sku.spu_id=spu.idleft join c3 on sku.category3_id=c3.idleft join c2 on c3.category2_id=c2.idleft join c1 on c2.category1_id=c1.idleft join tm on sku.tm_id=tm.idleft join attr on sku.id=attr.sku_idleft join sale_attr on sku.id=sale_attr.sku_id;"</span>dim_base_province<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dim_base_provinceselect    bp.id,    bp.name,    bp.area_code,    bp.iso_code,    bp.iso_3166_2,    bp.region_id,    br.region_namefrom ${APP}.ods_base_province bpjoin ${APP}.ods_base_region br on bp.region_id = br.id;"</span>dim_coupon_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dim_coupon_info partition(dt='$do_date')select    id,    coupon_name,    coupon_type,    condition_amount,    condition_num,    activity_id,    benefit_amount,    benefit_discount,    create_time,    range_type,    limit_num,    taken_count,    start_time,    end_time,    operate_time,    expire_timefrom ${APP}.ods_coupon_infowhere dt='$do_date';"</span>dim_activity_rule_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dim_activity_rule_info partition(dt='$do_date')select    ar.id,    ar.activity_id,    ai.activity_name,    ar.activity_type,    ai.start_time,    ai.end_time,    ai.create_time,    ar.condition_amount,    ar.condition_num,    ar.benefit_amount,    ar.benefit_discount,    ar.benefit_levelfrom(    select        id,        activity_id,        activity_type,        condition_amount,        condition_num,        benefit_amount,        benefit_discount,        benefit_level    from ${APP}.ods_activity_rule    where dt='$do_date')arleft join(    select        id,        activity_name,        start_time,        end_time,        create_time    from ${APP}.ods_activity_info    where dt='$do_date')aion ar.activity_id=ai.id;"</span><span class="token keyword">case</span> $<span class="token number">1</span> <span class="token operator">in</span><span class="token string">"dim_user_info"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_user_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"dim_sku_info"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_sku_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"dim_base_province"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_base_province"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"dim_coupon_info"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_coupon_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"dim_activity_rule_info"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_activity_rule_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"all"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_user_info$dim_sku_info$dim_coupon_info$dim_activity_rule_info$dim_base_province"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span>esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-每日DIM维度层装载脚本"><a href="#8-每日DIM维度层装载脚本" class="headerlink" title="8. 每日DIM维度层装载脚本"></a>8. 每日DIM维度层装载脚本</h2><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#!/bin/bash</span>APP<span class="token operator">=</span>gmall<span class="token comment" spellcheck="true"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$2"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>do_date<span class="token operator">=</span>$<span class="token number">2</span>seconds<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span><span class="token number">d</span> $<span class="token number">2</span> <span class="token operator">+</span><span class="token operator">%</span>s<span class="token punctuation">`</span>seconds_yesterday<span class="token operator">=</span>$<span class="token punctuation">(</span><span class="token punctuation">(</span>seconds <span class="token operator">-</span> <span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">)</span>day_before<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span><span class="token number">d</span> <span class="token variable">@$seconds_yesterday</span> <span class="token operator">+</span><span class="token operator">%</span>F<span class="token punctuation">`</span><span class="token keyword">else</span>    <span class="token keyword">exit</span>     do_date<span class="token operator">=</span><span class="token punctuation">`</span><span class="token keyword">date</span> <span class="token operator">-</span><span class="token number">d</span> <span class="token string">"-1 day"</span> <span class="token operator">+</span><span class="token operator">%</span>F<span class="token punctuation">`</span>fidim_user_info<span class="token operator">=</span><span class="token string">"with    tmp as        (            select                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.id,null) old_id,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.login_name,null) old_login_name,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.nick_name,null) old_nick_name,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.name,null) old_name,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.phone_num,null) old_phone_num,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.email,null) old_email,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.user_level,null) old_user_level,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.birthday,null) old_birthday,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.gender,null) old_gender,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.create_time,null) old_create_time,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.operate_time,null) old_operate_time,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.start_date,null) old_start_date,                if(ods_ui.id is not null and dim_ui.id is not null,date_add('$do_date',-1),null) old_end_date,                nvl(ods_ui.id,dim_ui.id) new_id,                nvl(ods_ui.login_name,dim_ui.login_name) new_login_name,                nvl(ods_ui.nick_name,dim_ui.nick_name) new_nick_name,                nvl(ods_ui.name,dim_ui.name) new_name,                nvl(ods_ui.phone_num,dim_ui.phone_num) new_phone_num,                nvl(ods_ui.email,dim_ui.email) new_email,                nvl(ods_ui.user_level,dim_ui.user_level) new_user_level,                nvl(ods_ui.birthday,dim_ui.birthday) new_birthday,                nvl(ods_ui.gender,dim_ui.gender) new_gender,                nvl(ods_ui.create_time,dim_ui.create_time) new_create_time,                nvl(ods_ui.operate_time,dim_ui.operate_time) new_operate_time,                if(ods_ui.id is not null,'$do_date',dim_ui.start_date) new_start_date,                '9999-99-99' new_end_date            from                (                    select                        id,                        login_name,                        nick_name,                        name,                        phone_num,                        email,                        user_level,                        birthday,                        gender,                        create_time,                        operate_time,                        start_date,                        end_date                    from gmall.dim_user_info where dt='9999-99-99'                )dim_ui                    full outer join                (                    select                        id,                        login_name,                        nick_name,                        md5(name) name,                        md5(phone_num) phone_num,                        md5(email) email,                        user_level,                        birthday,                        gender,                        create_time,                        operate_time                    from gmall.ods_user_info where dt='$do_date'                )ods_ui                on dim_ui.id=ods_ui.id        )insert overwrite table gmall.dim_user_info partition(dt='$day_before')select    old_id,    old_login_name,    old_nick_name,    old_name,    old_phone_num,    old_email,    old_user_level,    old_birthday,    old_gender,    old_create_time,    old_operate_time,    old_start_date,    old_end_datefrom tmpwhere old_id is not null;with    tmp as        (            select                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.id,null) old_id,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.login_name,null) old_login_name,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.nick_name,null) old_nick_name,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.name,null) old_name,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.phone_num,null) old_phone_num,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.email,null) old_email,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.user_level,null) old_user_level,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.birthday,null) old_birthday,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.gender,null) old_gender,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.create_time,null) old_create_time,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.operate_time,null) old_operate_time,                if(ods_ui.id is not null and dim_ui.id is not null,dim_ui.start_date,null) old_start_date,                if(ods_ui.id is not null and dim_ui.id is not null,date_add('$do_date',-1),null) old_end_date,                nvl(ods_ui.id,dim_ui.id) new_id,                nvl(ods_ui.login_name,dim_ui.login_name) new_login_name,                nvl(ods_ui.nick_name,dim_ui.nick_name) new_nick_name,                nvl(ods_ui.name,dim_ui.name) new_name,                nvl(ods_ui.phone_num,dim_ui.phone_num) new_phone_num,                nvl(ods_ui.email,dim_ui.email) new_email,                nvl(ods_ui.user_level,dim_ui.user_level) new_user_level,                nvl(ods_ui.birthday,dim_ui.birthday) new_birthday,                nvl(ods_ui.gender,dim_ui.gender) new_gender,                nvl(ods_ui.create_time,dim_ui.create_time) new_create_time,                nvl(ods_ui.operate_time,dim_ui.operate_time) new_operate_time,                if(ods_ui.id is not null,'$do_date',dim_ui.start_date) new_start_date,                '9999-99-99' new_end_date            from                (                    select                        id,                        login_name,                        nick_name,                        name,                        phone_num,                        email,                        user_level,                        birthday,                        gender,                        create_time,                        operate_time,                        start_date,                        end_date                    from gmall.dim_user_info where dt='9999-99-99'                )dim_ui                    full outer join                (                    select                        id,                        login_name,                        nick_name,                        md5(name) name,                        md5(phone_num) phone_num,                        md5(email) email,                        user_level,                        birthday,                        gender,                        create_time,                        operate_time                    from gmall.ods_user_info where dt='$do_date'                )ods_ui                on dim_ui.id=ods_ui.id        )insert overwrite table gmall.dim_user_info partition(dt='9999-99-99')select    new_id,    new_login_name,    new_nick_name,    new_name,    new_phone_num,    new_email,    new_user_level,    new_birthday,    new_gender,    new_create_time,    new_operate_time,    new_start_date,    new_end_datefrom tmp;"</span>dim_sku_info<span class="token operator">=</span><span class="token string">"withsku as(    select        id,        price,        sku_name,        sku_desc,        weight,        is_sale,        spu_id,        category3_id,        tm_id,        create_time    from ${APP}.ods_sku_info    where dt='$do_date'),spu as(    select        id,        spu_name    from ${APP}.ods_spu_info    where dt='$do_date'),c3 as(    select        id,        name,        category2_id    from ${APP}.ods_base_category3    where dt='$do_date'),c2 as(    select        id,        name,        category1_id    from ${APP}.ods_base_category2    where dt='$do_date'),c1 as(    select        id,        name    from ${APP}.ods_base_category1    where dt='$do_date'),tm as(    select        id,        tm_name    from ${APP}.ods_base_trademark    where dt='$do_date'),attr as(    select        sku_id,        collect_set(named_struct('attr_id',attr_id,'value_id',value_id,'attr_name',attr_name,'value_name',value_name)) attrs    from ${APP}.ods_sku_attr_value    where dt='$do_date'    group by sku_id),sale_attr as(    select        sku_id,        collect_set(named_struct('sale_attr_id',sale_attr_id,'sale_attr_value_id',sale_attr_value_id,'sale_attr_name',sale_attr_name,'sale_attr_value_name',sale_attr_value_name)) sale_attrs    from ${APP}.ods_sku_sale_attr_value    where dt='$do_date'    group by sku_id)insert overwrite table ${APP}.dim_sku_info partition(dt='$do_date')select    sku.id,    sku.price,    sku.sku_name,    sku.sku_desc,    sku.weight,    sku.is_sale,    sku.spu_id,    spu.spu_name,    sku.category3_id,    c3.name,    c3.category2_id,    c2.name,    c2.category1_id,    c1.name,    sku.tm_id,    tm.tm_name,    attr.attrs,    sale_attr.sale_attrs,    sku.create_timefrom skuleft join spu on sku.spu_id=spu.idleft join c3 on sku.category3_id=c3.idleft join c2 on c3.category2_id=c2.idleft join c1 on c2.category1_id=c1.idleft join tm on sku.tm_id=tm.idleft join attr on sku.id=attr.sku_idleft join sale_attr on sku.id=sale_attr.sku_id;"</span>dim_base_province<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dim_base_provinceselect    bp.id,    bp.name,    bp.area_code,    bp.iso_code,    bp.iso_3166_2,    bp.region_id,    bp.namefrom ${APP}.ods_base_province bpjoin ${APP}.ods_base_region br on bp.region_id = br.id;"</span>dim_coupon_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dim_coupon_info partition(dt='$do_date')select    id,    coupon_name,    coupon_type,    condition_amount,    condition_num,    activity_id,    benefit_amount,    benefit_discount,    create_time,    range_type,    limit_num,    taken_count,    start_time,    end_time,    operate_time,    expire_timefrom ${APP}.ods_coupon_infowhere dt='$do_date';"</span>dim_activity_rule_info<span class="token operator">=</span><span class="token string">"insert overwrite table ${APP}.dim_activity_rule_info partition(dt='$do_date')select    ar.id,    ar.activity_id,    ai.activity_name,    ar.activity_type,    ai.start_time,    ai.end_time,    ai.create_time,    ar.condition_amount,    ar.condition_num,    ar.benefit_amount,    ar.benefit_discount,    ar.benefit_levelfrom(    select        id,        activity_id,        activity_type,        condition_amount,        condition_num,        benefit_amount,        benefit_discount,        benefit_level    from ${APP}.ods_activity_rule    where dt='$do_date')arleft join(    select        id,        activity_name,        start_time,        end_time,        create_time    from ${APP}.ods_activity_info    where dt='$do_date')aion ar.activity_id=ai.id;"</span><span class="token keyword">case</span> $<span class="token number">1</span> <span class="token operator">in</span><span class="token string">"dim_user_info"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_user_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"dim_sku_info"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_sku_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"dim_base_province"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_base_province"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"dim_coupon_info"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_coupon_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"dim_activity_rule_info"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_activity_rule_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"first"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_sku_info$dim_base_province$dim_coupon_info$dim_activity_rule_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token string">"all"</span><span class="token punctuation">)</span>{    hive <span class="token operator">-</span><span class="token number">e</span> <span class="token string">"$dim_user_info$dim_sku_info$dim_coupon_info$dim_activity_rule_info"</span>}<span class="token punctuation">;</span><span class="token punctuation">;</span>esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 离线数仓 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 维度建模 </tag>
            
            <tag> 维度表 </tag>
            
            <tag> dim </tag>
            
            <tag> 拉链表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ods层的创建</title>
      <link href="/2022/09/18/ods%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/"/>
      <url>/2022/09/18/ods%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="1-用户行为数据"><a href="#1-用户行为数据" class="headerlink" title="1.用户行为数据"></a>1.用户行为数据</h2><h3 id="1-1-创建日志表ods-log"><a href="#1-1-创建日志表ods-log" class="headerlink" title="1.1 创建日志表ods_log"></a>1.1 创建日志表ods_log</h3><p>创建表格</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> ods_log<span class="token punctuation">;</span><span class="token keyword">create</span> external <span class="token keyword">table</span> ods_log<span class="token punctuation">(</span>    line string<span class="token punctuation">)</span>partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span>dt string<span class="token punctuation">)</span>location <span class="token string">'/warehouse/gmall/ods/ods_log'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>加载数据</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">load</span> <span class="token keyword">data</span> inpath <span class="token string">'/origin_data/gmall/log/topic_log/2021-06-14'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ods_log <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2021-06-14'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-2-Shell中单引号和双引号区别"><a href="#1-2-Shell中单引号和双引号区别" class="headerlink" title="1.2 Shell中单引号和双引号区别"></a>1.2 Shell中单引号和双引号区别</h3><p>在&#x2F;home&#x2F;atguigu&#x2F;bin创建一个test.sh文件</p><pre class="line-numbers language-shel"><code class="language-shel">[atguigu@hadoop102 bin]$ vim test.sh <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在文件中添加如下内容</p><pre class="line-numbers language-shell"><code class="language-shell">#!/bin/bashdo_date=$1echo '$do_date'echo "$do_date"echo "'$do_date'"echo '"$do_date"'echo `date`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看执行结果</p><pre class="line-numbers language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ test.sh 2021-06-14$do_date2021-06-14'2021-06-14'"$do_date"2021年 06月 18日 星期四 21:02:08 CST<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总结</p><p>（1）单引号不取变量值</p><p>（2）双引号取变量值</p><p>（3）反引号&#96;，执行引号中命令</p><p>（4）双引号内部嵌套单引号，取出变量值</p><p>（5）单引号内部嵌套双引号，不取出变量值</p><h3 id="1-3-ODS层日志表加载脚本"><a href="#1-3-ODS层日志表加载脚本" class="headerlink" title="1.3 ODS层日志表加载脚本"></a>1.3 ODS层日志表加载脚本</h3><pre class="line-numbers language-shell"><code class="language-shell">#!/bin/bashAPP=gmallif [ $# -lt 1 ]then exitfido_date=$1echo "==============日志日期为 $do_date ======="sql="load data inpath '/origin_data/$APP/log/topic_log/$do_date' into table ${APP}.ods_log partition(dt='$do_date')";hive -e "$sql"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-日志数据"><a href="#2-日志数据" class="headerlink" title="2. 日志数据"></a>2. 日志数据</h2><p><img src="/2022/09/18/ods%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663489752215.png" alt="1663489752215"></p><p><img src="/2022/09/18/ods%E5%B1%82%E7%9A%84%E5%88%9B%E5%BB%BA/1663489877935.png" alt="1663489877935"></p><h3 id="2-1-活动信息表"><a href="#2-1-活动信息表" class="headerlink" title="2.1 活动信息表"></a>2.1 活动信息表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_activity_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_activity_info<span class="token punctuation">(</span>   <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>activity_name<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动名称'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>activity_type<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动类型'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>start_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'开始时间'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>end_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'结束时间'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动信息表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_activity_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-购物车表"><a href="#2-2-购物车表" class="headerlink" title="2.2 购物车表"></a>2.2 购物车表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_cart_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_cart_info<span class="token punctuation">(</span>   <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'skuid'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>cart_price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'放入购物车时价格'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>sku_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'数量'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku名称 (冗余)'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>is_ordered<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否已经下单'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>order_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'下单时间'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>source_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源编号'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'加购表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_cart_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-3-活动规则表"><a href="#2-3-活动规则表" class="headerlink" title="2.3 活动规则表"></a>2.3 活动规则表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_activity_rule<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_activity_rule<span class="token punctuation">(</span>   <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>activity_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动类型'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减金额'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减件数'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠折扣'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>benefit_level<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠级别'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动规则表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_activity_rule/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-4-一级品类表"><a href="#2-4-一级品类表" class="headerlink" title="2.4 一级品类表"></a>2.4 一级品类表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_category1<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_category1<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'名称'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品一级分类表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_category1/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-5-二级品类表"><a href="#2-5-二级品类表" class="headerlink" title="2.5 二级品类表"></a>2.5 二级品类表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_category2<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_category2<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">' id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级品类id'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品二级分类表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_category2/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-6-三级品类表"><a href="#2-6-三级品类表" class="headerlink" title="2.6 三级品类表"></a>2.6 三级品类表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_category3<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_category3<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">' id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级品类id'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品三级分类表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_category3/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-7-编码字典表"><a href="#2-7-编码字典表" class="headerlink" title="2.7 编码字典表"></a>2.7 编码字典表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_dic<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_dic<span class="token punctuation">(</span>    <span class="token punctuation">`</span>dic_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>dic_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编码名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>parent_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'父编码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建日期'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作日期'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'编码字典表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_dic/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-8-省份表"><a href="#2-8-省份表" class="headerlink" title="2.8 省份表"></a>2.8 省份表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_province<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_province <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>region_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>iso_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'ISO-3166编码，供可视化使用'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>iso_3166_2<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'IOS-3166-2编码，供可视化使用'</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'省份表'</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_province/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-9-地区表"><a href="#2-9-地区表" class="headerlink" title="2.9 地区表"></a>2.9 地区表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_region<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_region <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>region_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区名称'</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'地区表'</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_region/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-10-品牌表"><a href="#2-10-品牌表" class="headerlink" title="2.10 品牌表"></a>2.10 品牌表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_trademark<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_trademark <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'品牌表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_trademark/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-11-评论表"><a href="#2-11-评论表" class="headerlink" title="2.11 评论表"></a>2.11 评论表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_comment_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_comment_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品sku'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品spu'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>appraise<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'评价'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'评价时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品评论表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_comment_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-12-优惠卷信息表"><a href="#2-12-优惠卷信息表" class="headerlink" title="2.12 优惠卷信息表"></a>2.12 优惠卷信息表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_coupon_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_coupon_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满额数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'减金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'折扣'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>range_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'范围类型 1、商品 2、品类 3、品牌'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>limit_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最多领用次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>taken_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'已领用次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>start_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'开始领取时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>end_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'结束领取时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_coupon_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-13-优惠卷领用表"><a href="#2-13-优惠卷领用表" class="headerlink" title="2.13 优惠卷领用表"></a>2.13 优惠卷领用表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_coupon_use<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_coupon_use<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'skuid'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_status<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'优惠券状态'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>get_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'领取时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>using_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'使用时间(下单)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>used_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'使用时间(支付)'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券领用表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_coupon_use/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-14-收藏表"><a href="#2-14-收藏表" class="headerlink" title="2.14 收藏表"></a>2.14 收藏表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_favor_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_favor_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'skuid'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_cancel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否取消'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'收藏时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>cancel_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'取消时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品收藏表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_favor_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-15-订单明细表"><a href="#2-15-订单明细表" class="headerlink" title="2.15 订单明细表"></a>2.15 订单明细表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_detail<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_detail<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品价格'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品数量'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>source_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>split_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'分摊最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>split_activity_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'分摊活动优惠'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>split_coupon_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'分摊优惠券优惠'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单详情表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_detail/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-16-订单明细活动关联表"><a href="#2-16-订单明细活动关联表" class="headerlink" title="2.16 订单明细活动关联表"></a>2.16 订单明细活动关联表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_detail_activity<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_detail_activity<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_detail_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单明细id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单详情活动关联表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_detail_activity/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-17-订单明细优惠卷关联表"><a href="#2-17-订单明细优惠卷关联表" class="headerlink" title="2.17 订单明细优惠卷关联表"></a>2.17 订单明细优惠卷关联表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_detail_coupon<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_detail_coupon<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_detail_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单明细id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_use_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券领用记录id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单详情活动关联表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_detail_coupon/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-18-订单表"><a href="#2-18-订单表" class="headerlink" title="2.18 订单表"></a>2.18 订单表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_info <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单最终金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单状态'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_way<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付方式'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>delivery_address<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'送货地址'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付流水号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tracking_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'物流单编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动减免金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券减免金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'订单原价金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>feight_fee<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'运费'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>feight_fee_reduce<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'运费减免'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-19-退单表"><a href="#2-19-退单表" class="headerlink" title="2.19 退单表"></a>2.19 退单表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_refund_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_refund_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单件数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_reason_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单原因类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单状态'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--退单状态应包含买家申请、卖家审核、卖家收货、退款完成等状态。此处未涉及到，故该表按增量处理</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_refund_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-20-订单状态日志表"><a href="#2-20-订单状态日志表" class="headerlink" title="2.20 订单状态日志表"></a>2.20 订单状态日志表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_status_log<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_status_log <span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单状态'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'订单状态表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_status_log/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-21-支付表"><a href="#2-21-支付表" class="headerlink" title="2.21 支付表"></a>2.21 支付表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_payment_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_payment_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外业务编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>subject<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易内容'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付状态'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>callback_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'回调时间'</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'支付流水表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_payment_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-22-退款表"><a href="#2-22-退款表" class="headerlink" title="2.22 退款表"></a>2.22 退款表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_refund_payment<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_refund_payment<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外业务编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付类型'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>subject<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易内容'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>refund_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付状态'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>callback_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'回调时间'</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'支付流水表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_refund_payment/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-23-商品平台属性表"><a href="#2-23-商品平台属性表" class="headerlink" title="2.23 商品平台属性表"></a>2.23 商品平台属性表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_sku_attr_value<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_sku_attr_value<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>attr_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>value_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性值ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>attr_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>value_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性值名称'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'sku平台属性表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_sku_attr_value/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-24-商品（sku）表"><a href="#2-24-商品（sku）表" class="headerlink" title="2.24 商品（sku）表"></a>2.24 商品（sku）表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_sku_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_sku_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'skuId'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'价格'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_desc<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品描述'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>weight<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'重量'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品类id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>is_sale<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否在售'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'SKU商品表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_sku_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-25-商品销售属性表"><a href="#2-25-商品销售属性表" class="headerlink" title="2.25 商品销售属性表"></a>2.25 商品销售属性表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_sku_sale_attr_value<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_sku_sale_attr_value<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku_id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spu_id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sale_attr_value_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性值id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sale_attr_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sale_attr_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>sale_attr_value_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性值名称'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'sku销售属性名称'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_sku_sale_attr_value/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-26-商品（spu）表"><a href="#2-26-商品（spu）表" class="headerlink" title="2.26 商品（spu）表"></a>2.26 商品（spu）表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_spu_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_spu_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spu名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品类id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌id'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'SPU商品表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_spu_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-27-用户表"><a href="#2-27-用户表" class="headerlink" title="2.27 用户表"></a>2.27 用户表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_user_info<span class="token punctuation">;</span><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_user_info<span class="token punctuation">(</span>    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>login_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户名称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>nick_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户昵称'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户姓名'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>phone_num<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机号码'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>email<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>user_level<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户等级'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>birthday<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'生日'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>gender<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'性别'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作时间'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户表'</span>    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>    LOCATION <span class="token string">'/warehouse/gmall/ods/ods_user_info/'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-28-ODS层业务数据首日导入脚本"><a href="#2-28-ODS层业务数据首日导入脚本" class="headerlink" title="2.28 ODS层业务数据首日导入脚本"></a>2.28 ODS层业务数据首日导入脚本</h3><pre class="line-numbers language-shell"><code class="language-shell">#!/bin/bashAPP=gmall# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天if [ -n "$2" ] ;then   do_date=$2else    echo "请传入日期参数"   exitfi ods_order_info=" load data inpath '/origin_data/$APP/db/order_info/$do_date' OVERWRITE into table ${APP}.ods_order_info partition(dt='$do_date');"ods_order_detail="load data inpath '/origin_data/$APP/db/order_detail/$do_date' OVERWRITE into table ${APP}.ods_order_detail partition(dt='$do_date');"ods_sku_info="load data inpath '/origin_data/$APP/db/sku_info/$do_date' OVERWRITE into table ${APP}.ods_sku_info partition(dt='$do_date');"ods_user_info="load data inpath '/origin_data/$APP/db/user_info/$do_date' OVERWRITE into table ${APP}.ods_user_info partition(dt='$do_date');"ods_payment_info="load data inpath '/origin_data/$APP/db/payment_info/$do_date' OVERWRITE into table ${APP}.ods_payment_info partition(dt='$do_date');"ods_base_category1="load data inpath '/origin_data/$APP/db/base_category1/$do_date' OVERWRITE into table ${APP}.ods_base_category1 partition(dt='$do_date');"ods_base_category2="load data inpath '/origin_data/$APP/db/base_category2/$do_date' OVERWRITE into table ${APP}.ods_base_category2 partition(dt='$do_date');"ods_base_category3="load data inpath '/origin_data/$APP/db/base_category3/$do_date' OVERWRITE into table ${APP}.ods_base_category3 partition(dt='$do_date'); "ods_base_trademark="load data inpath '/origin_data/$APP/db/base_trademark/$do_date' OVERWRITE into table ${APP}.ods_base_trademark partition(dt='$do_date'); "ods_activity_info="load data inpath '/origin_data/$APP/db/activity_info/$do_date' OVERWRITE into table ${APP}.ods_activity_info partition(dt='$do_date'); "ods_cart_info="load data inpath '/origin_data/$APP/db/cart_info/$do_date' OVERWRITE into table ${APP}.ods_cart_info partition(dt='$do_date'); "ods_comment_info="load data inpath '/origin_data/$APP/db/comment_info/$do_date' OVERWRITE into table ${APP}.ods_comment_info partition(dt='$do_date'); "ods_coupon_info="load data inpath '/origin_data/$APP/db/coupon_info/$do_date' OVERWRITE into table ${APP}.ods_coupon_info partition(dt='$do_date'); "ods_coupon_use="load data inpath '/origin_data/$APP/db/coupon_use/$do_date' OVERWRITE into table ${APP}.ods_coupon_use partition(dt='$do_date'); "ods_favor_info="load data inpath '/origin_data/$APP/db/favor_info/$do_date' OVERWRITE into table ${APP}.ods_favor_info partition(dt='$do_date'); "ods_order_refund_info="load data inpath '/origin_data/$APP/db/order_refund_info/$do_date' OVERWRITE into table ${APP}.ods_order_refund_info partition(dt='$do_date'); "ods_order_status_log="load data inpath '/origin_data/$APP/db/order_status_log/$do_date' OVERWRITE into table ${APP}.ods_order_status_log partition(dt='$do_date'); "ods_spu_info="load data inpath '/origin_data/$APP/db/spu_info/$do_date' OVERWRITE into table ${APP}.ods_spu_info partition(dt='$do_date'); "ods_activity_rule="load data inpath '/origin_data/$APP/db/activity_rule/$do_date' OVERWRITE into table ${APP}.ods_activity_rule partition(dt='$do_date');" ods_base_dic="load data inpath '/origin_data/$APP/db/base_dic/$do_date' OVERWRITE into table ${APP}.ods_base_dic partition(dt='$do_date'); "ods_order_detail_activity="load data inpath '/origin_data/$APP/db/order_detail_activity/$do_date' OVERWRITE into table ${APP}.ods_order_detail_activity partition(dt='$do_date'); "ods_order_detail_coupon="load data inpath '/origin_data/$APP/db/order_detail_coupon/$do_date' OVERWRITE into table ${APP}.ods_order_detail_coupon partition(dt='$do_date'); "ods_refund_payment="load data inpath '/origin_data/$APP/db/refund_payment/$do_date' OVERWRITE into table ${APP}.ods_refund_payment partition(dt='$do_date'); "ods_sku_attr_value="load data inpath '/origin_data/$APP/db/sku_attr_value/$do_date' OVERWRITE into table ${APP}.ods_sku_attr_value partition(dt='$do_date'); "ods_sku_sale_attr_value="load data inpath '/origin_data/$APP/db/sku_sale_attr_value/$do_date' OVERWRITE into table ${APP}.ods_sku_sale_attr_value partition(dt='$do_date'); "ods_base_province=" load data inpath '/origin_data/$APP/db/base_province/$do_date' OVERWRITE into table ${APP}.ods_base_province;"ods_base_region="load data inpath '/origin_data/$APP/db/base_region/$do_date' OVERWRITE into table ${APP}.ods_base_region;"case $1 in    "ods_order_info"){        hive -e "$ods_order_info"    };;    "ods_order_detail"){        hive -e "$ods_order_detail"    };;    "ods_sku_info"){        hive -e "$ods_sku_info"    };;    "ods_user_info"){        hive -e "$ods_user_info"    };;    "ods_payment_info"){        hive -e "$ods_payment_info"    };;    "ods_base_category1"){        hive -e "$ods_base_category1"    };;    "ods_base_category2"){        hive -e "$ods_base_category2"    };;    "ods_base_category3"){        hive -e "$ods_base_category3"    };;    "ods_base_trademark"){        hive -e "$ods_base_trademark"    };;    "ods_activity_info"){        hive -e "$ods_activity_info"    };;    "ods_cart_info"){        hive -e "$ods_cart_info"    };;    "ods_comment_info"){        hive -e "$ods_comment_info"    };;    "ods_coupon_info"){        hive -e "$ods_coupon_info"    };;    "ods_coupon_use"){        hive -e "$ods_coupon_use"    };;    "ods_favor_info"){        hive -e "$ods_favor_info"    };;    "ods_order_refund_info"){        hive -e "$ods_order_refund_info"    };;    "ods_order_status_log"){        hive -e "$ods_order_status_log"    };;    "ods_spu_info"){        hive -e "$ods_spu_info"    };;    "ods_activity_rule"){        hive -e "$ods_activity_rule"    };;    "ods_base_dic"){        hive -e "$ods_base_dic"    };;    "ods_order_detail_activity"){        hive -e "$ods_order_detail_activity"    };;    "ods_order_detail_coupon"){        hive -e "$ods_order_detail_coupon"    };;    "ods_refund_payment"){        hive -e "$ods_refund_payment"    };;    "ods_sku_attr_value"){        hive -e "$ods_sku_attr_value"    };;    "ods_sku_sale_attr_value"){        hive -e "$ods_sku_sale_attr_value"    };;    "ods_base_province"){        hive -e "$ods_base_province"    };;    "ods_base_region"){        hive -e "$ods_base_region"    };;    "all"){        hive -e "$ods_order_info$ods_order_detail$ods_sku_info$ods_user_info$ods_payment_info$ods_base_category1$ods_base_category2$ods_base_category3$ods_base_trademark$ods_activity_info$ods_cart_info$ods_comment_info$ods_coupon_info$ods_coupon_use$ods_favor_info$ods_order_refund_info$ods_order_status_log$ods_spu_info$ods_activity_rule$ods_base_dic$ods_order_detail_activity$ods_order_detail_coupon$ods_refund_payment$ods_sku_attr_value$ods_sku_sale_attr_value$ods_base_province$ods_base_region"    };;esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-29-ODS层业务数据每日导入脚本"><a href="#2-29-ODS层业务数据每日导入脚本" class="headerlink" title="2.29 ODS层业务数据每日导入脚本"></a>2.29 ODS层业务数据每日导入脚本</h3><pre class="line-numbers language-shell"><code class="language-shell">#!/bin/bashAPP=gmall# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天if [ -n "$2" ] ;then    do_date=$2else    exit     do_date=`date -d "-1 day" +%F`fiods_order_info=" load data inpath '/origin_data/$APP/db/order_info/$do_date' OVERWRITE into table ${APP}.ods_order_info partition(dt='$do_date');"ods_order_detail="load data inpath '/origin_data/$APP/db/order_detail/$do_date' OVERWRITE into table ${APP}.ods_order_detail partition(dt='$do_date');"ods_sku_info="load data inpath '/origin_data/$APP/db/sku_info/$do_date' OVERWRITE into table ${APP}.ods_sku_info partition(dt='$do_date');"ods_user_info="load data inpath '/origin_data/$APP/db/user_info/$do_date' OVERWRITE into table ${APP}.ods_user_info partition(dt='$do_date');"ods_payment_info="load data inpath '/origin_data/$APP/db/payment_info/$do_date' OVERWRITE into table ${APP}.ods_payment_info partition(dt='$do_date');"ods_base_category1="load data inpath '/origin_data/$APP/db/base_category1/$do_date' OVERWRITE into table ${APP}.ods_base_category1 partition(dt='$do_date');"ods_base_category2="load data inpath '/origin_data/$APP/db/base_category2/$do_date' OVERWRITE into table ${APP}.ods_base_category2 partition(dt='$do_date');"ods_base_category3="load data inpath '/origin_data/$APP/db/base_category3/$do_date' OVERWRITE into table ${APP}.ods_base_category3 partition(dt='$do_date'); "ods_base_trademark="load data inpath '/origin_data/$APP/db/base_trademark/$do_date' OVERWRITE into table ${APP}.ods_base_trademark partition(dt='$do_date'); "ods_activity_info="load data inpath '/origin_data/$APP/db/activity_info/$do_date' OVERWRITE into table ${APP}.ods_activity_info partition(dt='$do_date'); "ods_cart_info="load data inpath '/origin_data/$APP/db/cart_info/$do_date' OVERWRITE into table ${APP}.ods_cart_info partition(dt='$do_date'); "ods_comment_info="load data inpath '/origin_data/$APP/db/comment_info/$do_date' OVERWRITE into table ${APP}.ods_comment_info partition(dt='$do_date'); "ods_coupon_info="load data inpath '/origin_data/$APP/db/coupon_info/$do_date' OVERWRITE into table ${APP}.ods_coupon_info partition(dt='$do_date'); "ods_coupon_use="load data inpath '/origin_data/$APP/db/coupon_use/$do_date' OVERWRITE into table ${APP}.ods_coupon_use partition(dt='$do_date'); "ods_favor_info="load data inpath '/origin_data/$APP/db/favor_info/$do_date' OVERWRITE into table ${APP}.ods_favor_info partition(dt='$do_date'); "ods_order_refund_info="load data inpath '/origin_data/$APP/db/order_refund_info/$do_date' OVERWRITE into table ${APP}.ods_order_refund_info partition(dt='$do_date'); "ods_order_status_log="load data inpath '/origin_data/$APP/db/order_status_log/$do_date' OVERWRITE into table ${APP}.ods_order_status_log partition(dt='$do_date'); "ods_spu_info="load data inpath '/origin_data/$APP/db/spu_info/$do_date' OVERWRITE into table ${APP}.ods_spu_info partition(dt='$do_date'); "ods_activity_rule="load data inpath '/origin_data/$APP/db/activity_rule/$do_date' OVERWRITE into table ${APP}.ods_activity_rule partition(dt='$do_date');" ods_base_dic="load data inpath '/origin_data/$APP/db/base_dic/$do_date' OVERWRITE into table ${APP}.ods_base_dic partition(dt='$do_date'); "ods_order_detail_activity="load data inpath '/origin_data/$APP/db/order_detail_activity/$do_date' OVERWRITE into table ${APP}.ods_order_detail_activity partition(dt='$do_date'); "ods_order_detail_coupon="load data inpath '/origin_data/$APP/db/order_detail_coupon/$do_date' OVERWRITE into table ${APP}.ods_order_detail_coupon partition(dt='$do_date'); "ods_refund_payment="load data inpath '/origin_data/$APP/db/refund_payment/$do_date' OVERWRITE into table ${APP}.ods_refund_payment partition(dt='$do_date'); "ods_sku_attr_value="load data inpath '/origin_data/$APP/db/sku_attr_value/$do_date' OVERWRITE into table ${APP}.ods_sku_attr_value partition(dt='$do_date'); "ods_sku_sale_attr_value="load data inpath '/origin_data/$APP/db/sku_sale_attr_value/$do_date' OVERWRITE into table ${APP}.ods_sku_sale_attr_value partition(dt='$do_date'); "ods_base_province=" load data inpath '/origin_data/$APP/db/base_province/$do_date' OVERWRITE into table ${APP}.ods_base_province;"ods_base_region="load data inpath '/origin_data/$APP/db/base_region/$do_date' OVERWRITE into table ${APP}.ods_base_region;"case $1 in    "ods_order_info"){        hive -e "$ods_order_info"    };;    "ods_order_detail"){        hive -e "$ods_order_detail"    };;    "ods_sku_info"){        hive -e "$ods_sku_info"    };;    "ods_user_info"){        hive -e "$ods_user_info"    };;    "ods_payment_info"){        hive -e "$ods_payment_info"    };;    "ods_base_category1"){        hive -e "$ods_base_category1"    };;    "ods_base_category2"){        hive -e "$ods_base_category2"    };;    "ods_base_category3"){        hive -e "$ods_base_category3"    };;    "ods_base_trademark"){        hive -e "$ods_base_trademark"    };;    "ods_activity_info"){        hive -e "$ods_activity_info"    };;    "ods_cart_info"){        hive -e "$ods_cart_info"    };;    "ods_comment_info"){        hive -e "$ods_comment_info"    };;    "ods_coupon_info"){        hive -e "$ods_coupon_info"    };;    "ods_coupon_use"){        hive -e "$ods_coupon_use"    };;    "ods_favor_info"){        hive -e "$ods_favor_info"    };;    "ods_order_refund_info"){        hive -e "$ods_order_refund_info"    };;    "ods_order_status_log"){        hive -e "$ods_order_status_log"    };;    "ods_spu_info"){        hive -e "$ods_spu_info"    };;    "ods_activity_rule"){        hive -e "$ods_activity_rule"    };;    "ods_base_dic"){        hive -e "$ods_base_dic"    };;    "ods_order_detail_activity"){        hive -e "$ods_order_detail_activity"    };;    "ods_order_detail_coupon"){        hive -e "$ods_order_detail_coupon"    };;    "ods_refund_payment"){        hive -e "$ods_refund_payment"    };;    "ods_sku_attr_value"){        hive -e "$ods_sku_attr_value"    };;    "ods_sku_sale_attr_value"){        hive -e "$ods_sku_sale_attr_value"    };;    "all"){        hive -e "$ods_order_info$ods_order_detail$ods_sku_info$ods_user_info$ods_payment_info$ods_base_category1$ods_base_category2$ods_base_category3$ods_base_trademark$ods_activity_info$ods_cart_info$ods_comment_info$ods_coupon_info$ods_coupon_use$ods_favor_info$ods_order_refund_info$ods_order_status_log$ods_spu_info$ods_activity_rule$ods_base_dic$ods_order_detail_activity$ods_order_detail_coupon$ods_refund_payment$ods_sku_attr_value$ods_sku_sale_attr_value"    };;esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 离线数仓 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ods </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kafka向hdfs中写文件总是有小文件(配置项不起作用)</title>
      <link href="/2022/09/17/kafka%E5%90%91hdfs%E4%B8%AD%E5%86%99%E6%96%87%E4%BB%B6%E6%80%BB%E6%98%AF%E6%9C%89%E5%B0%8F%E6%96%87%E4%BB%B6-%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%B8%8D%E8%B5%B7%E4%BD%9C%E7%94%A8/"/>
      <url>/2022/09/17/kafka%E5%90%91hdfs%E4%B8%AD%E5%86%99%E6%96%87%E4%BB%B6%E6%80%BB%E6%98%AF%E6%9C%89%E5%B0%8F%E6%96%87%E4%BB%B6-%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%B8%8D%E8%B5%B7%E4%BD%9C%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>今天遇到了一个比较坑的地方，所以记录一下。</p><p>当我们从kafka中向hdfs写数据的时候，我们一般为了防止写入hdfs的文件大小全是小文件，因此需要设置几个参数给予限制，一般来说我们使用如下三个参数来配置：</p><p>hdfs.rollInterval，30</p><p>hdfs.rollSize，1024</p><p>hdfs.rollCount，10</p><p>30代表30s回产生一个文件，1024代表1024字节会产生一个文件，10代表生成10个events会产生一个文件，这个参数目前已经不常使用了。</p><p>但是我再配置的过程中，发现这两个配置选项总是不起作用，保存的文件总是1ms产生一个，后来看到了一篇博客</p><p><img src="/2022/09/17/kafka%E5%90%91hdfs%E4%B8%AD%E5%86%99%E6%96%87%E4%BB%B6%E6%80%BB%E6%98%AF%E6%9C%89%E5%B0%8F%E6%96%87%E4%BB%B6-%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%B8%8D%E8%B5%B7%E4%BD%9C%E7%94%A8/1663428385530.png" alt="1663428385530"></p><p>主要是下面这个参数干扰了我们</p><p><img src="/2022/09/17/kafka%E5%90%91hdfs%E4%B8%AD%E5%86%99%E6%96%87%E4%BB%B6%E6%80%BB%E6%98%AF%E6%9C%89%E5%B0%8F%E6%96%87%E4%BB%B6-%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%B8%8D%E8%B5%B7%E4%BD%9C%E7%94%A8/1663428578873.png" alt="1663428578873"></p><p>这个图片中配置的意思是让你设置文件保存在hdfs中的副本数目，如果不设置，就读取hdfs中的默认副本数目，由于我设置的默认副本数目是3，因此次设置值为3，当flume检测到hdfs文件快的复制，就会强行中止tmp临时文件，生成新的，因此roll参数不起作用</p><p>解决办法就是我们把这个数值改为1，让flume感应不到hdfs文件快的复制，备份数目还是3，而且可以解决我们的问题。</p>]]></content>
      
      
      <categories>
          
          <category> 离线数仓 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kfaka sink </tag>
            
            <tag> 项目配置选项 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数仓基本概念</title>
      <link href="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/"/>
      <url>/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<h2 id="1-数仓分层"><a href="#1-数仓分层" class="headerlink" title="1. 数仓分层"></a>1. 数仓分层</h2><h3 id="1-1-为什么要进行分层"><a href="#1-1-为什么要进行分层" class="headerlink" title="1.1 为什么要进行分层"></a>1.1 为什么要进行分层</h3><p><img src="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/1663389045139.png" alt="1663389045139"></p><h3 id="1-2-数据集市和数据仓库的概念"><a href="#1-2-数据集市和数据仓库的概念" class="headerlink" title="1.2 数据集市和数据仓库的概念"></a>1.2 数据集市和数据仓库的概念</h3><p> <img src="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/1663389137035.png" alt="1663389137035"></p><h3 id="1-3-数仓命名规范"><a href="#1-3-数仓命名规范" class="headerlink" title="1.3 数仓命名规范"></a>1.3 数仓命名规范</h3><h4 id="1-3-1-表格命名"><a href="#1-3-1-表格命名" class="headerlink" title="1.3.1 表格命名"></a>1.3.1 表格命名</h4><ul><li><p>ODS层命名为ods_表名</p></li><li><p>DIM层命名为dim_表名</p></li><li><p>DWD层命名为dwd_表名</p></li><li><p>DWS层命名为dws_表名  </p></li><li><p>DWT层命名为dwt_表名</p></li><li><p>ADS层命名为ads_表名</p></li><li><p>临时表命名为tmp_表名</p></li></ul><h4 id="1-3-2-脚本命名"><a href="#1-3-2-脚本命名" class="headerlink" title="1.3.2 脚本命名"></a>1.3.2 脚本命名</h4><ul><li><p>数据源_to_目标_db&#x2F;log.sh</p></li><li><p>用户行为脚本以log为后缀；业务数据脚本以db为后缀。</p></li></ul><h4 id="1-3-3-表格字段命名"><a href="#1-3-3-表格字段命名" class="headerlink" title="1.3.3 表格字段命名"></a>1.3.3 表格字段命名</h4><ul><li><p>数量类型为bigint</p></li><li><p>金额类型为decimal(16, 2)，表示：16位有效数字，其中小数部分2位</p></li><li><p>字符串(名字，描述信息等)类型为string</p></li><li><p>主键外键类型为string</p></li><li><p>时间戳类型为bigint</p></li></ul><h2 id="2-数仓理论"><a href="#2-数仓理论" class="headerlink" title="2. 数仓理论"></a>2. 数仓理论</h2><h3 id="2-1-关系建模和维度建模"><a href="#2-1-关系建模和维度建模" class="headerlink" title="2.1 关系建模和维度建模"></a>2.1 关系建模和维度建模</h3><p>​关系建模和维度建模是两种数据仓库的建模技术。关系建模由Bill Inmon所倡导，维度建模由Ralph Kimball所倡导。</p><h4 id="2-1-1-关系建模"><a href="#2-1-1-关系建模" class="headerlink" title="2.1.1 关系建模"></a>2.1.1 关系建模</h4><p>​关系建模将复杂的数据抽象为两个概念——实体和关系，并使用规范化的方式表示出来。关系模型如图所示，从图中可以看出，较为松散、零碎，物理表数量多。</p><p><img src="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/1663389432280.png" alt="1663389432280"></p><p>​关系模型严格遵循第三范式（3NF），数据冗余程度低，数据的一致性容易得到保证。由于数据分布于众多的表中，查询会相对复杂，在大数据的场景下，查询效率相对较低。</p><h4 id="2-1-2-维度建模"><a href="#2-1-2-维度建模" class="headerlink" title="2.1.2 维度建模"></a>2.1.2 维度建模</h4><p>​维度模型如图所示，从图中可以看出，模型相对清晰、简洁。</p><p><img src="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/1663389476701.png" alt="1663389476701"></p><p>​维度模型以数据分析作为出发点，不遵循三范式，故数据存在一定的冗余。维度模型面向业务，将业务用事实表和维度表呈现出来。表结构简单，故查询简单，查询效率较高。</p><h3 id="2-2-维度表和事实表"><a href="#2-2-维度表和事实表" class="headerlink" title="2.2 维度表和事实表"></a>2.2 维度表和事实表</h3><h4 id="2-2-1-维度表"><a href="#2-2-1-维度表" class="headerlink" title="2.2.1 维度表"></a>2.2.1 维度表</h4><p>​<strong>维度表</strong>：一般是对事实的<strong>描述信息</strong>。每一张维表对应现实世界中的一个对象或者概念。例如：用户、商品、日期、地区等。</p><p><strong>维表的特征：</strong></p><ul><li><p>维表的范围很宽（具有多个属性、列比较多）</p></li><li><p>跟事实表相比，行数相对较小：通常&lt; 10万条</p></li><li><p>内容相对固定：编码表</p></li></ul><p>时间维度表：</p><p><img src="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/1663389591658.png" alt="1663389591658"></p><h4 id="2-2-2-事实表"><a href="#2-2-2-事实表" class="headerlink" title="2.2.2 事实表"></a>2.2.2 事实表</h4><p>​事实表中的<strong>每行数据代表一个业务事件（下单、支付、退款、评价等）</strong>。“事实”这个术语表示的是业务事件的<strong>度量值（可统计次数、个数、金额等）</strong>，例如，2021年5月21日，宋宋老师在京东花了250块钱买了一瓶海狗人参丸。维度表：时间、用户、商品、商家。事实表：250块钱、一瓶</p><p>​每一个事实表的行包括：具有可加性的数值型的度量值、与维表相连接的外键，通常具有两个和两个以上的外键。</p><p>​事实表的特征：</p><ul><li><p>非常的大</p></li><li><p>内容相对的窄：列数较少（主要是外键id和度量值）</p></li><li><p>经常发生变化，每天会新增加很多。</p></li></ul><p><strong>事务型事实表</strong></p><p>​以<strong>每个事务或事件为单位</strong>，例如一个销售订单记录，一笔支付记录等，作为事实表里的一行数据。一旦事务被提交，事实表数据被插入，数据就不再进行更改，其更新方式为增量更新。</p><p><strong>周期性快照事实表</strong></p><p>​周期型快照事实表中<strong>不会保留所有数据</strong>，<strong>只保留固定时间间隔的数据</strong>，例如每天或者每月的销售额，或每月的账户余额等。</p><p>​例如购物车，有加减商品，随时都有可能变化，但是我们更关心每天结束时这里面有多少商品，方便我们后期统计分析。</p><p><strong>累积型快照事实表</strong></p><p>​<strong>累计快照事实表用于跟踪业务事实的变化。</strong>例如，数据仓库中可能需要累积或者存储订单从下订单开始，到订单商品被打包、运输、和签收的各个业务阶段的时间点数据来跟踪订单声明周期的进展情况。当这个业务过程进行时，事实表的记录也要不断更新。</p><p><img src="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/1663389787499.png" alt="1663389787499"></p><h3 id="2-3-维度模型分类"><a href="#2-3-维度模型分类" class="headerlink" title="2.3 维度模型分类"></a>2.3 维度模型分类</h3><p>​在维度建模的基础上又分为三种模型：星型模型、雪花模型、星座模型。</p><p><img src="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/1663389855394.png" alt="1663389855394"></p><p><img src="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/1663389868957.png" alt="1663389868957"></p><h3 id="2-4-数据仓库建模"><a href="#2-4-数据仓库建模" class="headerlink" title="2.4 数据仓库建模"></a>2.4 数据仓库建模</h3><h4 id="2-4-1-ODS层"><a href="#2-4-1-ODS层" class="headerlink" title="2.4.1 ODS层"></a>2.4.1 ODS层</h4><p>​针对HDFS上的用户行为数据和业务数据，我们如何规划处理？</p><p>（1）保持数据原貌不做任何修改，起到备份数据的作用。</p><p>（2）数据采用压缩，减少磁盘存储空间（例如：原始数据100G，可以压缩到10G左右）</p><p>（3）创建分区表，防止后续的全表扫描</p><h4 id="2-4-2-DIM层和DWD层"><a href="#2-4-2-DIM层和DWD层" class="headerlink" title="2.4.2 DIM层和DWD层"></a>2.4.2 DIM层和DWD层</h4><p>DIM层DWD层需构建维度模型，一般采用星型模型，呈现的状态一般为星座模型。</p><p>维度建模一般按照以下四个步骤：</p><p><strong>选择业务过程→声明粒度→确认维度→确认事实</strong></p><p><strong>（1）选择业务过程</strong></p><p>在业务系统中，挑选我们感兴趣的业务线，比如下单业务，支付业务，退款业务，物流业务，一条业务线对应一张事实表。</p><p><strong>（2）声明粒度</strong></p><p>数据粒度指数据仓库的数据中保存数据的细化程度或综合程度的级别。</p><p>声明粒度意味着精确定义事实表中的一行数据表示什么，应该尽可能选择<strong>最小粒度</strong>，以此来应各种各样的需求。</p><p><strong>典型的粒度声明如下：</strong></p><p>订单事实表中一行数据表示的是一个订单中的一个商品项。</p><p>支付事实表中一行数据表示的是一个支付记录。</p><p><strong>（3）确定维度</strong></p><p>维度的主要作用是描述业务是事实，主要表示的是“谁，何处，何时”等信息。</p><p>确定维度的原则是：后续需求中是否要分析相关维度的指标。例如，需要统计，什么时间下的订单多，哪个地区下的订单多，哪个用户下的订单多。需要确定的维度就包括：时间维度、地区维度、用户维度。</p><p><strong>（4）确定事实</strong></p><p>此处的“事实”一词，指的是业务中的度量值（次数、个数、件数、金额，可以进行累加），例如订单金额、下单次数等。</p><p>在DWD层，以<strong>业务过程</strong>为建模驱动，基于每个具体业务过程的特点，构建<strong>最细粒度</strong>的明细层事实表。事实表可做适当的宽表化处理。</p><p>事实表和维度表的关联比较灵活，但是为了应对更复杂的业务需求，可以将能关联上的表尽量关联上。</p><p><img src="/2022/09/17/%E6%95%B0%E4%BB%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/1663390431982.png" alt="1663390431982"></p><p>至此，数据仓库的维度建模已经完毕，DWD层是以业务过程为驱动。</p><p>DWS层、DWT层和ADS层都是以需求为驱动，和维度建模已经没有关系了。</p><p>DWS和DWT都是建宽表，按照主题去建表。主题相当于观察问题的角度。对应着维度表。</p><h4 id="2-4-3-DWS层和DWT层"><a href="#2-4-3-DWS层和DWT层" class="headerlink" title="2.4.3 DWS层和DWT层"></a>2.4.3 DWS层和DWT层</h4><p>DWS层和DWT层统称宽表层，这两层的设计思想大致相同，通过以下案例进行阐述。</p><p>1）问题引出：两个需求，统计每个省份订单的个数、统计每个省份订单的总金额</p><p>2）处理办法：都是将省份表和订单表进行join，group by省份，然后计算。同样数据被计算了两次，实际上类似的场景还会更多。</p><p>​       那怎么设计能避免重复计算呢？</p><p>针对上述场景，可以设计一张地区宽表，其主键为地区ID，字段包含为：下单次数、下单金额、支付次数、支付金额等。上述所有指标都统一进行计算，并将结果保存在该宽表中，这样就能有效避免数据的重复计算。</p><p>3）总结：</p><p>（１）需要建哪些宽表：以维度为基准。</p><p>（２）宽表里面的字段：是站在不同维度的角度去看事实表，重点关注事实表聚合后的度量值。</p><p>（３）DWS和DWT层的区别：DWS层存放的所有主题对象当天的汇总行为，例如每个地区当天的下单次数，下单金额等，DWT层存放的是所有主题对象的累积行为，例如每个地区最近７天（１５天、３０天、６０天）的下单次数、下单金额等。</p><h4 id="2-4-4-ADS层"><a href="#2-4-4-ADS层" class="headerlink" title="2.4.4 ADS层"></a>2.4.4 ADS层</h4><p>​对电商系统各大主题指标分别进行分析。</p>]]></content>
      
      
      <categories>
          
          <category> 离线数仓 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数仓分层 </tag>
            
            <tag> 维度建模 </tag>
            
            <tag> ODS </tag>
            
            <tag> DWD </tag>
            
            <tag> DIM </tag>
            
            <tag> DWS </tag>
            
            <tag> DWT </tag>
            
            <tag> ADS </tag>
            
            <tag> 维度表 </tag>
            
            <tag> 事实表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka集群机器数和分区数的计算</title>
      <link href="/2022/09/16/Kafka%E4%B8%AD%E5%88%86%E5%8C%BA%E6%95%B0%E5%92%8C%E6%9C%BA%E5%99%A8%E6%95%B0%E7%9A%84%E8%AE%A1%E7%AE%97/"/>
      <url>/2022/09/16/Kafka%E4%B8%AD%E5%88%86%E5%8C%BA%E6%95%B0%E5%92%8C%E6%9C%BA%E5%99%A8%E6%95%B0%E7%9A%84%E8%AE%A1%E7%AE%97/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Kfaka机器数量的计算"><a href="#1-Kfaka机器数量的计算" class="headerlink" title="1.Kfaka机器数量的计算"></a>1.Kfaka机器数量的计算</h2><p>首先我们需要知道这个数据集群中最大生产速度</p><p>然后我们需要确定这个topic需要的副本数量，这样我们就可以确定一个集群中Kafka的数量</p><p>Kafka机器数量（经验公式）&#x3D;2<em>（峰值生产速度</em>副本数&#x2F;100）+1</p><p>比如我们的峰值生产速度是50M&#x2F;s。副本数为2。</p><p>Kafka机器数量&#x3D;2×（50×2&#x2F;100）+ 1&#x3D;3台</p><h2 id="2-Kafka分区数目的计算"><a href="#2-Kafka分区数目的计算" class="headerlink" title="2. Kafka分区数目的计算"></a>2. Kafka分区数目的计算</h2><p>1）创建一个只有1个分区的topic</p><p>2）测试这个topic的producer吞吐量和consumer吞吐量。</p><p>3）假设他们的值分别是Tp和Tc，单位可以是MB&#x2F;s。</p><p>4）然后假设总的目标吞吐量是Tt，那么分区数&#x3D;Tt &#x2F; min（Tp，Tc）</p><p>例如：producer吞吐量&#x3D;20m&#x2F;s；consumer吞吐量&#x3D;50m&#x2F;s，期望吞吐量100m&#x2F;s；</p><p>分区数&#x3D;100 &#x2F; 20 &#x3D;5分区</p><p><a href="https://blog.csdn.net/weixin_42641909/article/details/89294698">https://blog.csdn.net/weixin_42641909/article/details/89294698</a></p><p>分区数一般设置为：3-10个</p>]]></content>
      
      
      <categories>
          
          <category> 离线数仓 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kakfa集群数目的计算 </tag>
            
            <tag> kakfa机器数目的计算 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>环境变量的设置</title>
      <link href="/2022/09/15/linux%E4%B8%AD%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E9%85%8D%E7%BD%AE/"/>
      <url>/2022/09/15/linux%E4%B8%AD%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>​在Linux中环境变量可以在多个文件中去配置，比如&#x2F;etc&#x2F;profile，&#x2F;etc&#x2F;profile.d&#x2F;*.sh，<del>&#x2F;.bashrc ，</del>&#x2F;.bash_profile等，下面说明上述几个文件之间的关系和区别。</p><p>​bash的运行模式可分为login shell和non-login shell。</p><p>​例如，我们通过终端，输入用户名、密码，登录系统之后，得到就是一个login shell，而当我们执行以下命令ssh hadoop103 command，在hadoop103执行command的就是一个non-login shell。</p><p>​这两种shell的主要区别在于，它们启动时会加载不同的配置文件，login shell启动时会加载&#x2F;etc&#x2F;profile，<del>&#x2F;.bash_profile，</del>&#x2F;.bashrc，non-login shell启动时会加载~&#x2F;.bashrc。</p><p>​而在加载<del>&#x2F;.bashrc（实际是</del>&#x2F;.bashrc中加载的&#x2F;etc&#x2F;bashrc）或&#x2F;etc&#x2F;profile时，都会执行如下代码片段，</p><p><img src="/2022/09/15/linux%E4%B8%AD%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E9%85%8D%E7%BD%AE/1663256723054.png" alt="1663256723054"></p><p>​因此不管是loginshell还是non-login shell，启动时都会加载&#x2F;etc&#x2F;profile.d&#x2F;*.sh中的环境变量。</p><p>​因此我们可以选择在profile.d文件夹中创建一个sh文件，里面配置环境变量，那么登录的shell 以及非登录shell都可以得到环境变量。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> login shell </tag>
            
            <tag> non-login shell </tag>
            
            <tag> 环境变量 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指offer03.数组中的重复数字</title>
      <link href="/2022/09/15/%E5%89%91%E6%8C%87offer/%E5%89%91%E6%8C%87offer03-%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E6%95%B0%E5%AD%97/"/>
      <url>/2022/09/15/%E5%89%91%E6%8C%87offer/%E5%89%91%E6%8C%87offer03-%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E6%95%B0%E5%AD%97/</url>
      
        <content type="html"><![CDATA[<p><img src="/2022/09/15/%E5%89%91%E6%8C%87offer/%E5%89%91%E6%8C%87offer03-%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E6%95%B0%E5%AD%97/1663242021137.png" alt="1663242021137"></p><p>本题目一共有两种解决思路</p><p>第一种思路很简单，就是使用空间换时间的思路，用一个set存储数字，出现过就直接返回，这种思路比较容易想到。</p><p>代码如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findRepeatNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Set<span class="token operator">&lt;</span>Integer<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">return</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                map<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>本题目主要讲解第二种思路：</p><p>有一个隐含条件我们可能忽略了，数组中的所有数字在0 - n-1的范围内。这样我们完全可以使用这个数组来当一个set，就是我们按照把索引值当作数组内的值，这样找到一个数字之后，如果组内的值出现过，那么里面的数组肯定等于该数字，因此可以找出重复数字</p><p>代码如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findRepeatNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>                i<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">==</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">return</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token keyword">int</span> temp <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>nums<span class="token punctuation">[</span>temp<span class="token punctuation">]</span><span class="token punctuation">;</span>                nums<span class="token punctuation">[</span>temp<span class="token punctuation">]</span><span class="token operator">=</span>temp<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 剑指offer </category>
          
      </categories>
      
      
        <tags>
            
            <tag> set </tag>
            
            <tag> 数组 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java多线程</title>
      <link href="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
      <url>/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="17【多线程】"><a href="#17【多线程】" class="headerlink" title="17【多线程】"></a>17【多线程】</h1><h2 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h2><ul><li>多线程</li></ul><h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ul><li><input disabled="" type="checkbox"> 说出进程的概念</li><li><input disabled="" type="checkbox"> 说出线程的概念</li><li><input disabled="" type="checkbox"> 能够理解并发与并行的区别</li><li><input disabled="" type="checkbox"> 能够开启新线程</li><li><input disabled="" type="checkbox"> 能够描述Java中多线程运行原理</li><li><input disabled="" type="checkbox"> 能够使用继承类的方式创建多线程</li><li><input disabled="" type="checkbox"> 能够使用实现接口的方式创建多线程</li><li><input disabled="" type="checkbox"> 能够说出实现接口方式的好处</li><li><input disabled="" type="checkbox"> 能够解释安全问题的出现的原因</li><li><input disabled="" type="checkbox"> 能够使用同步代码块解决线程安全问题</li><li><input disabled="" type="checkbox"> 能够使用同步方法解决线程安全问题</li><li><input disabled="" type="checkbox"> 能够说出线程6个状态的名称</li><li><input disabled="" type="checkbox"> 能够理解线程通信概念</li><li><input disabled="" type="checkbox"> 能够理解等待唤醒机制</li><li><input disabled="" type="checkbox"> 能够编写单例设计模式</li></ul><h1 id="第十一章-多线程"><a href="#第十一章-多线程" class="headerlink" title="第十一章 多线程"></a>第十一章 多线程</h1><p>我们在之前，学习的程序在没有跳转语句的前提下，都是由上至下依次执行，那现在想要设计一个程序，边打游戏边听歌，怎么设计？</p><p>要解决上述问题,咱们得使用多进程或者多线程来解决.</p><h2 id="11-1-相关概念"><a href="#11-1-相关概念" class="headerlink" title="11.1 相关概念"></a>11.1 相关概念</h2><h3 id="11-1-1-并发与并行（了解）"><a href="#11-1-1-并发与并行（了解）" class="headerlink" title="11.1.1 并发与并行（了解）"></a>11.1.1 并发与并行（了解）</h3><ul><li><p><strong>并行</strong>（parallel）：指两个或多个事件在<strong>同一时刻</strong>发生（同时发生）。指在同一时刻，有多条指令在多个处理器上同时执行。</p><p>多项工作一起执行，之后再汇总</p></li><li><p><strong>并发</strong>（concurrency）：指两个或多个事件在<strong>同一个时间段内</strong>发生。指在同一个时刻只能有一条指令执行，但多个进程的指令被快速轮换执行，使得在宏观上具有多个进程同时执行的效果。</p><p>同一时刻多个线程在访问同一个资源，多个线程对一个点</p></li></ul><p><img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%B9%B6%E5%8F%91.bmp" alt="并行与并发"></p><p>在操作系统中，安装了多个程序，并发指的是在一段时间内宏观上有多个程序同时运行，这在单 CPU 系统中，每一时刻只能有一个程序执行，即微观上这些程序是分时的交替运行，只不过是给人的感觉是同时运行，那是因为分时交替运行的时间是非常短的。</p><p>而在多个 CPU 系统中，则这些可以并发执行的程序便可以分配到多个处理器上（CPU），实现多任务并行执行，即利用每个处理器来处理一个可以并发执行的程序，这样多个程序便可以同时执行。目前电脑市场上说的多核 CPU，便是多核处理器，核越多，<strong>并行</strong>处理的程序越多，能大大的提高电脑运行的效率。</p><blockquote><p>注意：<strong>单核</strong>处理器的计算机肯定是<strong>不能并行</strong>的处理多个任务的，只能是多个任务在单个CPU上并发运行。同理，线程也是一样的，从宏观角度上理解线程是并行运行的，但是从微观角度上分析却是串行运行的，即一个线程一个线程的去运行，当系统只有一个CPU时，线程会以某种顺序执行多个线程，我们把这种情况称之为线程调度。</p></blockquote><h3 id="11-1-2-线程与进程"><a href="#11-1-2-线程与进程" class="headerlink" title="11.1.2 线程与进程"></a>11.1.2 线程与进程</h3><ul><li><p><strong>程序</strong>：为了完成某个任务和功能，选择一种编程语言编写的一组指令的集合。</p></li><li><p><strong>软件</strong>：<strong>1个或多个</strong>应用程序+相关的素材和资源文件等构成一个软件系统。</p></li><li><p><strong>进程</strong>：是指一个内存中运行的应用程序，每个进程都有一个独立的内存空间，进程也是程序的一次执行过程，是系统运行程序的基本单位；系统运行一个程序即是一个进程从创建、运行到消亡的过程。</p></li><li><p><strong>线程</strong>：线程是进程中的一个执行单元，负责当前进程中程序的执行，一个进程中至少有一个线程。一个进程中是可以有多个线程的，这个应用程序也可以称之为多线程程序。 </p><p>简而言之：一个软件中至少有一个应用程序，应用程序的一次运行就是一个进程，一个进程中至少有一个线程。</p></li><li><p>面试题：进程是操作系统调度和分配资源的最小单位，线程是CPU调度的最小单位。不同的进程之间是不共享内存的。进程之间的数据交换和通信的成本是很高。不同的线程是共享同一个进程的内存的。当然不同的线程也有自己独立的内存空间。对于方法区，堆中中的同一个对象的内存，线程之间是可以共享的，但是栈的局部变量永远是独立的。</p></li></ul><p>例如：</p><h4 id="一个软件中包含多个进程"><a href="#一个软件中包含多个进程" class="headerlink" title="一个软件中包含多个进程"></a>一个软件中包含多个进程</h4><p><img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/1563267154695.png" alt="1563267154695"></p><h4 id="每个应用程序的运行都是一个进程"><a href="#每个应用程序的运行都是一个进程" class="headerlink" title="每个应用程序的运行都是一个进程"></a>每个应用程序的运行都是一个进程</h4><p>我们可以再电脑底部任务栏，右键—–&gt;打开任务管理器,可以查看当前任务的进程：</p><h4 id="一个应用程序的多次运行，就是多个进程"><a href="#一个应用程序的多次运行，就是多个进程" class="headerlink" title="一个应用程序的多次运行，就是多个进程"></a>一个应用程序的多次运行，就是多个进程</h4><p><img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/1563267431480.png" alt="1563267431480"></p><h4 id="一个进程中包含多个线程"><a href="#一个进程中包含多个线程" class="headerlink" title="一个进程中包含多个线程"></a>一个进程中包含多个线程</h4><p><img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/1563270525077.png" alt="1563270525077"></p><h3 id="11-1-3-线程调度"><a href="#11-1-3-线程调度" class="headerlink" title="11.1.3 线程调度"></a>11.1.3 线程调度</h3><ul><li><p>分时调度</p><p>所有线程轮流使用 CPU 的使用权，平均分配每个线程占用 CPU 的时间。</p></li><li><p>抢占式调度</p><p>优先让优先级高的线程使用 CPU，如果线程的优先级相同，那么会随机选择一个(线程随机性)，Java使用的为抢占式调度。</p><ul><li>抢占式调度详解</li></ul><p>  大部分操作系统都支持多进程并发运行，现在的操作系统几乎都支持同时运行多个程序。比如：现在我们上课一边使用编辑器，一边使用录屏软件，同时还开着画图板，dos窗口等软件。此时，这些程序是在同时运行，”感觉这些软件好像在同一时刻运行着“。</p><p>  实际上，CPU(中央处理器)使用抢占式调度模式在多个线程间进行着高速的切换。对于CPU的一个核而言，某个时刻，只能执行一个线程，而 CPU的在多个线程间切换速度相对我们的感觉要快，看上去就是在同一时刻运行。<br>  其实，多线程程序并不能提高程序的运行速度，但能够提高程序运行效率，让CPU的使用率更高。</p><p>  <img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E6%8A%A2%E5%8D%A0%E5%BC%8F%E8%B0%83%E5%BA%A6.bmp" alt="抢占式调度"></p></li></ul><h2 id="11-2-另行创建和启动线程"><a href="#11-2-另行创建和启动线程" class="headerlink" title="11.2 另行创建和启动线程"></a>11.2 另行创建和启动线程</h2><p>当运行Java程序时，其实已经有一个线程了，那就是main线程。</p><p><img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/1563281796505.png" alt="1563281796505"></p><p>那么如何创建和启动main线程以外的线程呢？</p><h3 id="11-2-1-继承Thread类"><a href="#11-2-1-继承Thread类" class="headerlink" title="11.2.1 继承Thread类"></a>11.2.1 继承Thread类</h3><p>Java使用<code>java.lang.Thread</code>类代表<strong>线程</strong>，所有的线程对象都必须是Thread类或其子类的实例。每个线程的作用是完成一定的任务，实际上就是执行一段程序流即一段顺序执行的代码。Java使用线程执行体来代表这段程序流。Java中通过继承Thread类来<strong>创建</strong>并<strong>启动多线程</strong>的步骤如下：</p><ol><li>定义Thread类的子类，并重写该类的run()方法，该run()方法的方法体就代表了线程需要完成的任务,因此把run()方法称为线程执行体。</li><li>创建Thread子类的实例，即创建了线程对象</li><li>调用线程对象的start()方法来启动该线程</li></ol><p>代码如下：</p><p>测试类：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo01</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//创建自定义线程对象</span>        MyThread mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"新的线程！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//开启新线程</span>        mt<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//在主方法中执行for循环</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main线程！"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>自定义线程类：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//定义指定线程名称的构造方法</span>    <span class="token keyword">public</span> <span class="token function">MyThread</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//调用父类的String参数的构造方法，指定线程的名称</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 重写run方法，完成该线程执行的逻辑     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"：正在执行！"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11-2-2-实现Runnable接口"><a href="#11-2-2-实现Runnable接口" class="headerlink" title="11.2.2 实现Runnable接口"></a>11.2.2 实现Runnable接口</h3><p>Java有单继承的限制，当我们无法继承Thread类时，那么该如何做呢？在核心类库中提供了Runnable接口，我们可以实现Runnable接口，重写run()方法，然后再通过Thread类的对象代理启动和执行我们的线程体run()方法</p><p>步骤如下：</p><ol><li>定义Runnable接口的实现类，并重写该接口的run()方法，该run()方法的方法体同样是该线程的线程执行体。</li><li>创建Runnable实现类的实例，并以此实例作为Thread的target来创建Thread对象，该Thread对象才是真正<br>的线程对象。</li><li>调用线程对象的start()方法来启动线程。<br>代码如下：</li></ol><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>      <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" "</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">}</span>             <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">//创建自定义类对象  线程任务对象</span>          MyRunnable mr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//创建线程对象</span>          Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mr<span class="token punctuation">,</span> <span class="token string">"小强"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"旺财 "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 通过实现Runnable接口，使得该类有了多线程类的特征。run()方法是多线程程序的一个执行目标。所有的多线程<br>代码都在run方法里面。Thread类实际上也是实现了Runnable接口的类。</p><p>在启动的多线程的时候，需要先通过Thread类的构造方法Thread(Runnable target) 构造出对象，然后调用Thread对象的start()方法来运行多线程代码。</p><p>实际上所有的多线程代码都是通过运行Thread的start()方法来运行的。因此，不管是继承Thread类还是实现<br>Runnable接口来实现多线程，最终还是通过Thread的对象的API来控制线程的，熟悉Thread类的API是进行多线程编程的基础。</p><p>tips:Runnable对象仅仅作为Thread对象的target，Runnable实现类里包含的run()方法仅作为线程执行体。<br>而实际的线程对象依然是Thread实例，只是该Thread线程负责执行其target的run()方法。</p><h3 id="11-2-3-使用匿名内部类对象来实现线程的创建和启动"><a href="#11-2-3-使用匿名内部类对象来实现线程的创建和启动" class="headerlink" title="11.2.3 使用匿名内部类对象来实现线程的创建和启动"></a>11.2.3 使用匿名内部类对象来实现线程的创建和启动</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">"新的线程！"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"：正在执行！"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"："</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="11-3-Thread类"><a href="#11-3-Thread类" class="headerlink" title="11.3 Thread类"></a>11.3 Thread类</h2><h3 id="11-3-1-构造方法"><a href="#11-3-1-构造方法" class="headerlink" title="11.3.1 构造方法"></a>11.3.1 构造方法</h3><p>public Thread() :分配一个新的线程对象。<br>public Thread(String name) :分配一个指定名字的新的线程对象。<br>public Thread(Runnable target) :分配一个带有指定目标新的线程对象。<br>public Thread(Runnable target,String name) :分配一个带有指定目标新的线程对象并指定名字。</p><h3 id="11-3-2-常用方法系列1"><a href="#11-3-2-常用方法系列1" class="headerlink" title="11.3.2 常用方法系列1"></a>11.3.2 常用方法系列1</h3><ul><li><p>public void run() :此线程要执行的任务在此处定义代码。</p></li><li><p>public String getName() :获取当前线程名称。</p></li><li><p>public static Thread currentThread() :返回对当前正在执行的线程对象的引用。</p></li><li><p>public final boolean isAlive()：测试线程是否处于活动状态。如果线程已经启动且尚未终止，则为活动状态。 </p></li><li><p>public final int getPriority() ：返回线程优先级 </p></li><li><p>public final void setPriority(int newPriority) ：改变线程的优先级</p><ul><li>每个线程都有一定的优先级，优先级高的线程将获得较多的执行机会。每个线程默认的优先级都与创建它的父线程具有相同的优先级。Thread类提供了setPriority(int newPriority)和getPriority()方法类设置和获取线程的优先级，其中setPriority方法需要一个整数，并且范围在[1,10]之间，通常推荐设置Thread类的三个优先级常量：</li><li>MAX_PRIORITY（10）：最高优先级 </li><li>MIN _PRIORITY （1）：最低优先级</li><li>NORM_PRIORITY （5）：普通优先级，默认情况下main线程具有普通优先级。</li></ul></li></ul><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"的优先级："</span> <span class="token operator">+</span> <span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>MAX_PRIORITY<span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">"的优先级："</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11-3-3-常用方法系列2"><a href="#11-3-3-常用方法系列2" class="headerlink" title="11.3.3 常用方法系列2"></a>11.3.3 常用方法系列2</h3><ul><li><p>public void start() :导致此线程开始执行; Java虚拟机调用此线程的run方法。</p></li><li><p>public static void sleep(long millis) :使当前正在执行的线程以指定的毫秒数暂停（暂时停止执行）。</p></li><li><p>public static void yield()：yield只是让当前线程暂停一下，让系统的线程调度器重新调度一次，希望优先级与当前线程相同或更高的其他线程能够获得执行机会，但是这个不能保证，完全有可能的情况是，当某个线程调用了yield方法暂停之后，线程调度器又将其调度出来重新执行。</p></li><li><p>void join() ：等待该线程终止。 </p><p>void join(long millis) ：等待该线程终止的时间最长为 millis 毫秒。如果millis时间到，将不再等待。 </p><p>void join(long millis, int nanos) ：等待该线程终止的时间最长为 millis 毫秒 + nanos 纳秒。 </p></li><li><p>public final void stop()：强迫线程停止执行。 该方法具有固有的不安全性，已经标记为@Deprecated不建议再使用，那么我们就需要通过其他方式来停止线程了，其中一种方式是使用变量的值的变化来控制线程是否结束。</p></li></ul><h4 id="示例代码：倒计时"><a href="#示例代码：倒计时" class="headerlink" title="示例代码：倒计时"></a>示例代码：倒计时</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"新年快乐！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="示例代码：强行加塞"><a href="#示例代码：强行加塞" class="headerlink" title="示例代码：强行加塞"></a>示例代码：强行加塞</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Scanner<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestJoin</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ChatThread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main:"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">//当main打印到5之后，需要等join进来的线程停止后才会继续了。</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">ChatThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        Scanner input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"是否结束？（Y、N）"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">char</span> confirm <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>confirm <span class="token operator">==</span> <span class="token string">'Y'</span> <span class="token operator">||</span> confirm <span class="token operator">==</span> <span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11-3-4-守护线程（了解）"><a href="#11-3-4-守护线程（了解）" class="headerlink" title="11.3.4 守护线程（了解）"></a>11.3.4 守护线程（了解）</h3><p>有一种线程，它是在后台运行的，它的任务是为其他线程提供服务的，这种线程被称为“守护线程”。JVM的垃圾回收线程就是典型的守护线程。</p><p>守护线程有个特点，就是如果所有非守护线程都死亡，那么守护线程自动死亡。</p><p>调用setDaemon(true)方法可将指定线程设置为守护线程。必须在线程启动之前设置，否则会报IllegalThreadStateException异常。</p><p>调用isDaemon()可以判断线程是否是守护线程。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestThread</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        MyDaemon m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main:"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">MyDaemon</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"我一直守护者你..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="11-4-线程安全"><a href="#11-4-线程安全" class="headerlink" title="11.4 线程安全"></a>11.4 线程安全</h2><h3 id="11-4-1-线程安全"><a href="#11-4-1-线程安全" class="headerlink" title="11.4.1 线程安全"></a>11.4.1 线程安全</h3><p>我们通过一个案例，演示线程的安全问题：<br>电影院要卖票，我们模拟电影院的卖票过程。假设要播放的电影是 “葫芦娃大战奥特曼”，本次电影的座位共100个<br>(本场电影只能卖100张票)。<br>我们来模拟电影院的售票窗口，实现多个窗口同时卖 “葫芦娃大战奥特曼”这场电影票(多个窗口一起卖这100张票)<br>方式一：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Ticket</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*     * 执行卖票操作     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 每个窗口卖票的操作</span>        <span class="token comment" spellcheck="true">// 窗口永远开启</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 有票可以卖</span>                    <span class="token comment" spellcheck="true">// 出票操作</span>                <span class="token comment" spellcheck="true">// 使用sleep模拟一下出票时间</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 获取当前线程对象的名字</span>                String name <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"正在卖:"</span> <span class="token operator">+</span> ticket<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试类：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 创建线程任务对象</span>        Ticket ticket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ticket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 创建三个窗口对象</span>        Thread t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span> <span class="token string">"窗口1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span> <span class="token string">"窗口2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span> <span class="token string">"窗口3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 同时卖票</span>        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>方式二：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestThread</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Ticket t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ticket</span><span class="token punctuation">(</span><span class="token string">"窗口一"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Ticket t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ticket</span><span class="token punctuation">(</span><span class="token string">"窗口二"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Ticket t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ticket</span><span class="token punctuation">(</span><span class="token string">"窗口三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Ticket</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Ticket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Ticket</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*     * 执行卖票操作     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 每个窗口卖票的操作</span>        <span class="token comment" spellcheck="true">// 窗口永远开启</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 有票可以卖</span>                <span class="token comment" spellcheck="true">// 出票操作</span>                <span class="token comment" spellcheck="true">// 使用sleep模拟一下出票时间</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 获取当前线程对象的名字</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"正在卖:"</span> <span class="token operator">+</span> ticket<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>发现程序出现了两个问题：</p><ol><li>相同的票数,比如某张票被卖了两回。</li><li>不存在的票，比如0票与-1票，是不存在的。</li></ol><p>这种问题，几个窗口(线程)票数不同步了，这种问题称为线程不安全。</p><p>当我们使用多个线程访问<strong>同一资源</strong>（可以是同一个变量、同一个文件、同一条记录等）的时候，若多个线程只有读操作，那么不会发生线程安全问题，但是如果多个线程中对资源有读和写的操作，就容易出现线程安全问题。<br>要解决上述多线程并发访问一个资源的安全性问题:也就是解决重复票与不存在票问题，Java中提供了同步机制<br>(synchronized)来解决。</p><p><img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/1563372934332.png" alt="1563372934332"></p><p>根据案例简述：</p><p>窗口1线程进入操作的时候，窗口2和窗口3线程只能在外等着，窗口1操作结束，窗口1和窗口2和窗口3才有机会进入代码去执行。也就是说在某个线程修改共享资源的时候，其他线程不能修改该资源，等待修改完毕同步之后，才能去抢夺CPU资源，完成对应的操作，保证了数据的同步性，解决了线程不安全的现象。</p><p>为了保证每个线程都能正常执行原子操作,Java引入了线程同步机制。<br>那么怎么去使用呢？有三种方式完成同步操作：</p><ol><li>同步代码块。</li><li>同步方法。</li><li>锁机制</li></ol><h3 id="11-4-2-同步代码块"><a href="#11-4-2-同步代码块" class="headerlink" title="11.4.2 同步代码块"></a>11.4.2 同步代码块</h3><ul><li><p>同步代码块： synchronized 关键字可以用于方法中的某个区块中，表示只对这个区块的资源实行互斥访问。<br>格式:</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">synchronized</span><span class="token punctuation">(</span>同步锁<span class="token punctuation">)</span><span class="token punctuation">{</span>     需要同步操作的代码<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>同步锁:<br>对象的同步锁只是一个概念,可以想象为在对象上标记了一个锁.</li></ul><p>​锁对象 可以是任意类型。</p><p>​多个线程对象  要使用同一把锁。<br>注意:在任何时候,最多允许一个线程拥有同步锁,谁拿到锁就进入代码块,其他的线程只能在外等着(BLOCKED)。<br>使用同步代码块解决代码：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Ticket</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*     * 执行卖票操作     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 每个窗口卖票的操作</span>        <span class="token comment" spellcheck="true">// 窗口永远开启</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//这里可以选择this作为锁，是因为对于这几个线程，Ticket的this是同一个 </span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// 有票可以卖</span>                    <span class="token comment" spellcheck="true">// 出票操作</span>                    <span class="token comment" spellcheck="true">// 使用sleep模拟一下出票时间</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token comment" spellcheck="true">// 获取当前线程对象的名字</span>                    String name <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"正在卖:"</span> <span class="token operator">+</span> ticket<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当使用了同步代码块后，上述的线程的安全问题，解决了。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Ticket</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Ticket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Ticket</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*     * 执行卖票操作     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 每个窗口卖票的操作</span>        <span class="token comment" spellcheck="true">// 窗口永远开启</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Ticket<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//这里不能选用this作为锁，因为这几个线程的this不是同一个</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 有票可以卖</span>                    <span class="token comment" spellcheck="true">// 出票操作</span>                    <span class="token comment" spellcheck="true">// 使用sleep模拟一下出票时间</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token comment" spellcheck="true">// 获取当前线程对象的名字</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"正在卖:"</span> <span class="token operator">+</span> ticket<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="11-4-3-同步方法"><a href="#11-4-3-同步方法" class="headerlink" title="11.4.3 同步方法"></a>11.4.3 同步方法</h3><ul><li>同步方法:使用synchronized修饰的方法,就叫做同步方法,保证A线程执行该方法的时候,其他线程只能在方法外<br>等着</li></ul><p>格式：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    可能会产生线程安全问题的代码<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>同步方法的锁对象：</p><p>（1）静态方法：当前类的Class对象</p><p>（2）非静态方法：this</p><p>使用同步方法代码如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Ticket</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/*     * 执行卖票操作        */</span>      <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//每个窗口卖票的操作         </span>    <span class="token comment" spellcheck="true">//窗口 永远开启         </span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token function">sellTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>            <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">/*            * 锁对象 是 谁调用这个方法 就是谁              *   隐含 锁对象 就是  this             *                 */</span>            <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sellTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ticket<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//有票 可以卖   </span>          <span class="token comment" spellcheck="true">//出票操作</span>          <span class="token comment" spellcheck="true">//使用sleep模拟一下出票时间 </span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                              Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>                    <span class="token comment" spellcheck="true">//获取当前线程对象的名字 </span>            String name <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token operator">+</span><span class="token string">"正在卖:"</span><span class="token operator">+</span>ticket‐‐<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Ticket</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Ticket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Ticket</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*     * 执行卖票操作     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 每个窗口卖票的操作</span>        <span class="token comment" spellcheck="true">// 窗口永远开启</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">sellTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//这里必须是静态方法，因为如果是非静态方法，隐含的锁对象是this，那么多个线程就不是同一个锁对象了</span>    <span class="token comment" spellcheck="true">//而静态方法隐含的锁对象是当前类的Class对象</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sellTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ticket<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//有票可以卖 </span>            <span class="token comment" spellcheck="true">//出票操作</span>            <span class="token comment" spellcheck="true">//使用sleep模拟一下出票时间</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//获取当前线程对象的名字</span>            String name <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"正在卖："</span> <span class="token operator">+</span> ticket<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="11-5-等待唤醒机制"><a href="#11-5-等待唤醒机制" class="headerlink" title="11.5 等待唤醒机制"></a>11.5 等待唤醒机制</h2><h3 id="11-5-1-线程间通信"><a href="#11-5-1-线程间通信" class="headerlink" title="11.5.1 线程间通信"></a>11.5.1 线程间通信</h3><p><strong>概念：</strong>多个线程在处理同一个资源，但是处理的动作（线程的任务）却不相同。</p><p>比如：线程A用来生成包子的，线程B用来吃包子的，包子可以理解为同一资源，线程A与线程B处理的动作，一个是生产，一个是消费，那么线程A与线程B之间就存在线程通信问题。</p><p><img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/1563373005631.png" alt="1563373005631"></p><p><strong>为什么要处理线程间通信：</strong></p><p>多个线程并发执行时, 在默认情况下CPU是随机切换线程的，当我们需要多个线程来共同完成一件任务，并且我们希望他们有规律的执行, 那么多线程之间需要一些协调通信，以此来帮我们达到多线程共同操作一份数据。</p><p><strong>如何保证线程间通信有效利用资源：</strong></p><p>多个线程在处理同一个资源，并且任务不同时，需要线程通信来帮助解决线程之间对同一个变量的使用或操作。 就是多个线程在操作同一份数据时， 避免对同一共享变量的争夺。也就是我们需要通过一定的手段使各个线程能有效的利用资源。而这种手段即—— <strong>等待唤醒机制。</strong></p><h3 id="11-5-2-等待唤醒机制"><a href="#11-5-2-等待唤醒机制" class="headerlink" title="11.5.2 等待唤醒机制"></a>11.5.2 等待唤醒机制</h3><p><strong>什么是等待唤醒机制</strong></p><p>这是多个线程间的一种<strong>协作</strong>机制。谈到线程我们经常想到的是线程间的<strong>竞争（race）</strong>，比如去争夺锁，但这并不是故事的全部，线程间也会有协作机制。就好比在公司里你和你的同事们，你们可能存在在晋升时的竞争，但更多时候你们更多是一起合作以完成某些任务。</p><p>就是在一个线程进行了规定操作后，就进入等待状态（**wait()<strong>）， 等待其他线程执行完他们的指定代码过后 再将其唤醒（</strong>notify()**）;在有多个线程进行等待时， 如果需要，可以使用 notifyAll()来唤醒所有的等待线程。</p><p>wait&#x2F;notify 就是线程间的一种协作机制。</p><p><strong>等待唤醒中的方法</strong></p><p>等待唤醒机制就是用于解决线程间通信的问题的，使用到的3个方法的含义如下：</p><ol><li>wait：线程不再活动，不再参与调度，进入 wait set 中，因此不会浪费 CPU 资源，也不会去竞争锁了，这时的线程状态即是 WAITING。它还要等着别的线程执行一个<strong>特别的动作</strong>，也即是“<strong>通知（notify）</strong>”在这个对象上等待的线程从wait set 中释放出来，重新进入到调度队列（ready queue）中</li><li>notify：则选取所通知对象的 wait set 中的一个线程释放；</li><li>notifyAll：则释放所通知对象的 wait set 上的全部线程。</li></ol><blockquote><p>注意：</p><p>哪怕只通知了一个等待的线程，被通知线程也不能立即恢复执行，因为它当初中断的地方是在同步块内，而此刻它已经不持有锁，所以她需要再次尝试去获取锁（很可能面临其它线程的竞争），成功后才能在当初调用 wait 方法之后的地方恢复执行。</p><p>总结如下：</p><ul><li>如果能获取锁，线程就从 WAITING 状态变成 RUNNABLE（可运行） 状态；</li><li>否则，线程就从 WAITING 状态又变成 BLOCKED（等待锁） 状态</li></ul></blockquote><p><strong>调用wait和notify方法需要注意的细节</strong></p><ol><li>wait方法与notify方法必须要由同一个锁对象调用。因为：对应的锁对象可以通过notify唤醒使用同一个锁对象调用的wait方法后的线程。</li><li>wait方法与notify方法是属于Object类的方法的。因为：锁对象可以是任意对象，而任意对象的所属类都是继承了Object类的。</li><li>wait方法与notify方法必须要在同步代码块或者是同步函数中使用。因为：必须要通过锁对象调用这2个方法。</li></ol><h3 id="11-5-3-生产者与消费者问题"><a href="#11-5-3-生产者与消费者问题" class="headerlink" title="11.5.3 生产者与消费者问题"></a>11.5.3 生产者与消费者问题</h3><p>等待唤醒机制可以解决经典的“生产者与消费者”的问题。</p><p>生产者与消费者问题（英语：Producer-consumer problem），也称有限缓冲问题（英语：Bounded-buffer problem），是一个多线程同步问题的经典案例。该问题描述了两个（多个）共享固定大小缓冲区的线程——即所谓的“生产者”和“消费者”——在实际运行时会发生的问题。生产者的主要作用是生成一定量的数据放到缓冲区中，然后重复此过程。与此同时，消费者也在缓冲区消耗这些数据。该问题的关键就是要保证生产者不会在缓冲区满时加入数据，消费者也不会在缓冲区中空时消耗数据。</p><p>生产者与消费者问题中其实隐含了两个问题：</p><ul><li>线程安全问题：因为生产者与消费者共享数据缓冲区，不过这个问题可以使用同步解决。</li><li>线程的协调工作问题：<ul><li>要解决该问题，就必须让生产者线程在缓冲区满时等待(wait)，暂停进入阻塞状态，等到下次消费者消耗了缓冲区中的数据的时候，通知(notify)正在等待的线程恢复到就绪状态，重新开始往缓冲区添加数据。同样，也可以让消费者线程在缓冲区空时进入等待(wait)，暂停进入阻塞状态，等到生产者往缓冲区添加数据之后，再通知(notify)正在等待的线程恢复到就绪状态。通过这样的通信机制来解决此类问题。</li></ul></li></ul><h4 id="一对一做包子吃包子问题"><a href="#一对一做包子吃包子问题" class="headerlink" title="一对一做包子吃包子问题"></a>一对一做包子吃包子问题</h4><p>就拿生产包子消费包子来说等待唤醒机制如何有效利用资源：</p><pre class="line-numbers language-java"><code class="language-java">包子铺线程生产包子，吃货线程消费包子。当包子没有时（包子状态为<span class="token boolean">false</span>），吃货线程等待，包子铺线程生产包子（即包子状态为<span class="token boolean">true</span>），并通知吃货线程（解除吃货的等待状态）<span class="token punctuation">,</span>因为已经有包子了，那么包子铺线程进入等待状态。接下来，吃货线程能否进一步执行则取决于锁的获取情况。如果吃货获取到锁，那么就执行吃包子动作，包子吃完（包子状态为<span class="token boolean">false</span>），并通知包子铺线程（解除包子铺的等待状态）<span class="token punctuation">,</span>吃货线程进入等待。包子铺线程能否进一步执行则取决于锁的获取情况。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>代码演示：</strong></p><p>包子资源类：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaoZi</span> <span class="token punctuation">{</span>     String  pier <span class="token punctuation">;</span>     String  xianer <span class="token punctuation">;</span>     <span class="token keyword">boolean</span>  flag <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">;</span><span class="token comment" spellcheck="true">//包子资源 是否准备好  包子资源状态</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>吃货线程类：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChiHuo</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> BaoZi bz<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ChiHuo</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span>BaoZi bz<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>bz <span class="token operator">=</span> bz<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>bz<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>bz<span class="token punctuation">.</span>flag <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//没包子</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        bz<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                                                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"吃货正在吃："</span><span class="token operator">+</span>bz<span class="token punctuation">.</span>pier<span class="token operator">+</span><span class="token string">","</span><span class="token operator">+</span>bz<span class="token punctuation">.</span>xianer<span class="token operator">+</span><span class="token string">"包子"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                bz<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                bz<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>包子铺线程类：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaoZiPu</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> BaoZi bz<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">BaoZiPu</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span>BaoZi bz<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>bz <span class="token operator">=</span> bz<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//造包子</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//同步</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>bz<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>bz<span class="token punctuation">.</span>flag <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//包子资源  存在</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        bz<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 没有包子  造包子</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"包子铺开始做包子"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 薄皮  蟹黄包</span>                    bz<span class="token punctuation">.</span>pier <span class="token operator">=</span> <span class="token string">"薄皮"</span><span class="token punctuation">;</span>                    bz<span class="token punctuation">.</span>xianer <span class="token operator">=</span> <span class="token string">"蟹黄灌汤"</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 厚皮  牛肉大葱</span>                    bz<span class="token punctuation">.</span>pier <span class="token operator">=</span> <span class="token string">"厚皮"</span><span class="token punctuation">;</span>                    bz<span class="token punctuation">.</span>xianer <span class="token operator">=</span> <span class="token string">"牛肉大葱"</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                count<span class="token operator">++</span><span class="token punctuation">;</span>                bz<span class="token punctuation">.</span>flag<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"包子造好了："</span><span class="token operator">+</span>bz<span class="token punctuation">.</span>pier<span class="token operator">+</span>bz<span class="token punctuation">.</span>xianer<span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"吃货来吃吧"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//唤醒等待线程 （吃货）</span>                bz<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试类：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//等待唤醒案例</span>        BaoZi bz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaoZi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ChiHuo ch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChiHuo</span><span class="token punctuation">(</span><span class="token string">"吃货"</span><span class="token punctuation">,</span>bz<span class="token punctuation">)</span><span class="token punctuation">;</span>        BaoZiPu bzp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaoZiPu</span><span class="token punctuation">(</span><span class="token string">"包子铺"</span><span class="token punctuation">,</span>bz<span class="token punctuation">)</span><span class="token punctuation">;</span>        ch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bzp<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行效果：</p><pre class="line-numbers language-java"><code class="language-java">包子铺开始做包子包子造好了：厚皮牛肉大葱吃货来吃吧吃货正在吃：厚皮<span class="token punctuation">,</span>牛肉大葱包子包子铺开始做包子包子造好了：薄皮蟹黄灌汤吃货来吃吧吃货正在吃：薄皮<span class="token punctuation">,</span>蟹黄灌汤包子包子铺开始做包子包子造好了：厚皮牛肉大葱吃货来吃吧吃货正在吃：厚皮<span class="token punctuation">,</span>牛肉大葱包子包子铺开始做包子包子造好了：薄皮蟹黄灌汤吃货来吃吧吃货正在吃：薄皮<span class="token punctuation">,</span>蟹黄灌汤包子<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="多个厨师多个服务员问题"><a href="#多个厨师多个服务员问题" class="headerlink" title="多个厨师多个服务员问题"></a>多个厨师多个服务员问题</h4><p>案例：有家餐馆的取餐口比较小，只能放10份快餐，厨师做完快餐放在取餐口的工作台上，服务员从这个工作台取出快餐给顾客。现在有多个厨师和多个服务员。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>test<span class="token punctuation">.</span>thread<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestThread</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Workbench bench <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Workbench</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Cook c1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cook</span><span class="token punctuation">(</span><span class="token string">"大拿"</span><span class="token punctuation">,</span>bench<span class="token punctuation">)</span><span class="token punctuation">;</span>        Cook c2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cook</span><span class="token punctuation">(</span><span class="token string">"吉祥"</span><span class="token punctuation">,</span>bench<span class="token punctuation">)</span><span class="token punctuation">;</span>        Waiter w1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Waiter</span><span class="token punctuation">(</span><span class="token string">"翠花"</span><span class="token punctuation">,</span>bench<span class="token punctuation">)</span><span class="token punctuation">;</span>        Waiter w2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Waiter</span><span class="token punctuation">(</span><span class="token string">"如意"</span><span class="token punctuation">,</span>bench<span class="token punctuation">)</span><span class="token punctuation">;</span>                c1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        c2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        w1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        w2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Workbench</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_VALUE <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>num <span class="token operator">>=</span> MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//加入睡眠时间是放大问题现象，去掉同步和wait等，可观察问题</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        num<span class="token operator">++</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"厨师制作了一份快餐，现在工作台上有："</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">"份快餐"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>num <span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//加入睡眠时间是放大问题现象，去掉同步和wait等，可观察问题</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        num<span class="token operator">--</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"服务员取走了一份快餐，现在工作台上有："</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">"份快餐"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Waiter</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> Workbench workbench<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">Waiter</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span>Workbench workbench<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>workbench <span class="token operator">=</span> workbench<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            workbench<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Cook</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> Workbench workbench<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">Cook</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span>Workbench workbench<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>workbench <span class="token operator">=</span> workbench<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            workbench<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="11-6-线程生命周期"><a href="#11-6-线程生命周期" class="headerlink" title="11.6 线程生命周期"></a>11.6 线程生命周期</h2><p>简单来说，线程的生命周期有五种状态：新建（New）、就绪（Runnable）、运行（Running）、阻塞（Blocked）、死亡（Dead）。CPU需要在多条线程之间切换，于是线程状态会多次在运行、阻塞、就绪之间切换。</p><p><img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/1563282798989.png"></p><p><strong>1.</strong> <strong>新建</strong></p><p>当一个Thread类或其子类的对象被声明并创建时，新生的线程对象处于新建状。此时它和其他Java对象一样，仅仅由JVM为其分配了内存，并初始化了实例变量的值。此时的线程对象并没有任何线程的动态特征，程序也不会执行它的线程体run()。</p><p><strong>2.</strong> <strong>就绪</strong></p><p>但是当线程对象调用了start()方法之后，就不一样了，线程就从新建状态转为就绪状态。JVM会为其创建方法调用栈和程序计数器，当然，处于这个状态中的线程并没有开始运行，只是表示已具备了运行的条件，随时可以被调度。至于什么时候被调度，取决于JVM里线程调度器的调度。</p><blockquote><p>注意：</p><p>程序只能对新建状态的线程调用start()，并且只能调用一次，如果对非新建状态的线程，如已启动的线程或已死亡的线程调用start()都会报错IllegalThreadStateException异常。</p></blockquote><p><strong>3.</strong> <strong>运行</strong></p><p>如果处于就绪状态的线程获得了CPU，开始执行run()方法的线程体代码，则该线程处于运行状态。如果计算机只有一个CPU，在任何时刻只有一个线程处于运行状态，如果计算机有多个处理器，将会有多个线程并行(Parallel)执行。</p><p>当然，美好的时光总是短暂的，而且CPU讲究雨露均沾。对于抢占式策略的系统而言，系统会给每个可执行的线程一个小时间段来处理任务，当该时间用完，系统会剥夺该线程所占用的资源，让其回到就绪状态等待下一次被调度。此时其他线程将获得执行机会，而在选择下一个线程时，系统会适当考虑线程的优先级。</p><p><strong>4.</strong> <strong>阻塞</strong></p><p>当在运行过程中的线程遇到如下情况时，线程会进入阻塞状态：</p><ul><li>线程调用了sleep()方法，主动放弃所占用的CPU资源；</li><li>线程试图获取一个同步监视器，但该同步监视器正被其他线程持有；</li><li>线程执行过程中，同步监视器调用了wait()，让它等待某个通知（notify）；</li><li>线程执行过程中，同步监视器调用了wait(time)</li><li>线程执行过程中，遇到了其他线程对象的加塞（join）；</li><li>线程被调用suspend方法被挂起（已过时，因为容易发生死锁）；</li></ul><p>当前正在执行的线程被阻塞后，其他线程就有机会执行了。针对如上情况，当发生如下情况时会解除阻塞，让该线程重新进入就绪状态，等待线程调度器再次调度它：</p><ul><li>线程的sleep()时间到；</li><li>线程成功获得了同步监视器；</li><li>线程等到了通知(notify)；</li><li>线程wait的时间到了</li><li>加塞的线程结束了；</li><li>被挂起的线程又被调用了resume恢复方法（已过时，因为容易发生死锁）；</li></ul><p><strong>5.</strong> <strong>死亡</strong></p><p>线程会以以下三种方式之一结束，结束后的线程就处于死亡状态：</p><ul><li>run()方法执行完成，线程正常结束</li><li>线程执行过程中抛出了一个未捕获的异常（Exception）或错误（Error）</li><li>直接调用该线程的stop()来结束该线程（已过时，因为容易发生死锁）</li></ul><p>不过在java.lang.Thread.State的枚举类中这样定义：</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">enum</span> State <span class="token punctuation">{</span>        NEW<span class="token punctuation">,</span>   新建        RUNNABLE<span class="token punctuation">,</span>  准备就绪        BLOCKED<span class="token punctuation">,</span>   阻塞        WAITING<span class="token punctuation">,</span>   不见不散        TIMED_WAITING<span class="token punctuation">,</span> 过时不候        TERMINATED<span class="token punctuation">;</span>    终结    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>首先它没有区分：就绪和运行状态，因为对于Java对象来说，只能标记为可运行，至于什么时候运行，不是JVM来控制的了，是OS来进行调度的，而且时间非常短暂，因此对于Java对象的状态来说，无法区分。只能我们人为的进行想象和理解。</p></li><li><p>其次根据Thread.State的定义，阻塞状态是分为三种的：BLOCKED、WAITING、TIMED_WAITING。</p></li></ul><p><img src="/2020/02/18/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/1563381997032.png" alt="1563381997032"></p><h2 id="11-7-Thread和Runnable的区别"><a href="#11-7-Thread和Runnable的区别" class="headerlink" title="11.7 Thread和Runnable的区别"></a>11.7 Thread和Runnable的区别</h2><p>如果一个类继承Thread，则不适合资源共享。但是如果实现了Runable接口的话，则很容易的实现资源共享。<br>总结：<br>实现Runnable接口比继承Thread类所具有的优势：</p><ol><li>适合多个相同的程序代码的线程去共享同一个资源。</li><li>可以避免java中的单继承的局限性。</li><li>增加程序的健壮性，实现解耦操作，代码可以被多个线程共享，代码和线程独立。</li><li>线程池只能放入实现Runable或Callable类线程，不能直接放入继承Thread的类。</li><li>扩充：在java中，每次程序运行至少启动2个线程。一个是main线程，一个是垃圾收集线程。因为每当使用<br>java命令执行一个类的时候，实际上都会启动一个JVM，每一个JVM其实在就是在操作系统中启动了一个进<br>程。</li></ol><h2 id="11-8-释放锁操作与死锁"><a href="#11-8-释放锁操作与死锁" class="headerlink" title="11.8 释放锁操作与死锁"></a>11.8 释放锁操作与死锁</h2><p>任何线程进入同步代码块、同步方法之前，必须先获得对同步监视器的锁定，那么何时会释放对同步监视器的锁定呢？</p><h3 id="1、释放锁的操作"><a href="#1、释放锁的操作" class="headerlink" title="1、释放锁的操作"></a><strong>1、释放锁的操作</strong></h3><p>当前线程的同步方法、同步代码块执行结束。</p><p>当前线程在同步代码块、同步方法中遇到break、return终止了该代码块、该方法的继续执行。</p><p>当前线程在同步代码块、同步方法中出现了未处理的Error或Exception，导致当前线程异常结束。</p><p>当前线程在同步代码块、同步方法中执行了锁对象的wait()方法，当前线程被挂起，并释放锁。</p><h3 id="2、不会释放锁的操作"><a href="#2、不会释放锁的操作" class="headerlink" title="2、不会释放锁的操作"></a><strong>2、不会释放锁的操作</strong></h3><p>线程执行同步代码块或同步方法时，程序调用Thread.sleep()、Thread.yield()方法暂停当前线程的执行。</p><p>线程执行同步代码块时，其他线程调用了该线程的suspend()方法将该该线程挂起，该线程不会释放锁（同步监视器）。应尽量避免使用suspend()和resume()这样的过时来控制线程。</p><h3 id="3、死锁"><a href="#3、死锁" class="headerlink" title="3、死锁"></a>3、死锁</h3><p>不同的线程分别锁住对方需要的同步监视器对象不释放，都在等待对方先放弃时就形成了线程的死锁。一旦出现死锁，整个程序既不会发生异常，也不会给出任何提示，只是所有线程处于阻塞状态，无法继续。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestDeadLock</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Object g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Owner s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Owner</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        Customer c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Customer</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Owner</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> Object goods<span class="token punctuation">;</span>    <span class="token keyword">private</span> Object money<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Owner</span><span class="token punctuation">(</span>Object goods<span class="token punctuation">,</span> Object money<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>goods <span class="token operator">=</span> goods<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>money <span class="token operator">=</span> money<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>goods<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"先给钱"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>money<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发货"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> Object goods<span class="token punctuation">;</span>    <span class="token keyword">private</span> Object money<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Customer</span><span class="token punctuation">(</span>Object goods<span class="token punctuation">,</span> Object money<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>goods <span class="token operator">=</span> goods<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>money <span class="token operator">=</span> money<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>money<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"先发货"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>goods<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"再给钱"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4、sleep-和wait-方法的区别"><a href="#4、sleep-和wait-方法的区别" class="headerlink" title="4、sleep()和wait()方法的区别"></a>4、sleep()和wait()方法的区别</h3><p>（1）sleep()不释放锁，wait()释放锁</p><p>（2）sleep()指定休眠的时间，wait()可以指定时间也可以无限等待直到notify或notifyAll</p><p>（3）sleep()在Thread类中声明的静态方法，wait方法在Object类中声明</p><p>因为我们调用wait（）方法是由锁对象调用，而锁对象的类型是任意类型的对象。那么希望任意类型的对象都要有的方法，只能声明在Object类中。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多线程 </tag>
            
            <tag> 单例模式 </tag>
            
            <tag> sleep </tag>
            
            <tag> wait </tag>
            
            <tag> thread </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
